!function(a,b){function c(a,b){this.eventName=a,this.callbackFnc=b||function(){},this.applyCallback=function(a){this.callbackFnc.apply(window.vtftw,[a])}}function d(a,b,d,e){function f(){x=!0,z=clearTimeout(z),y||(z=setTimeout(g,3e5))}function g(){x=!1,q.userInactive()}function h(){document.addEventListener("keypress",f),document.addEventListener("mousemove",f),f()}function i(){r=(new Date).getTime()}function j(a){return"null"==a?void 0:null==a?void 0:a}function k(){return"lastCheckin_"+d}function l(){return"s_"+d}function m(){var a,b=Date.now();k();return a=j(localStorage.getItem(k())),!(a&&b-a>=s.sessionTimeout)}function n(){localStorage.removeItem(l())}function o(){if(x){var a,b;try{a=j(localStorage.getItem("i")),m()?b=j(localStorage.getItem(l())):n()}catch(c){}t.post(s.pingQueueUrl,{i:a,s:b,f:q.firstLoad.toString(),pid:r,sid:d,url:u,ref:v,c:B,ai:A},{withCredentials:!0,callback:function(a){if(q.firstLoad=!1,a.i){B++;var b=a.e;q.pingInterval=setTimeout(o,s.pingInterval),b&&b.length&&b.forEach(function(a){q.trigger(a.eventName,a)});try{return a.i&&localStorage.setItem("i",a.i),a.s&&localStorage.setItem(l(),a.s),localStorage.setItem(k(),Date.now()),!0}catch(c){return!1}}},error:function(){console.log("error")}})}}function p(){(w||[]).forEach(function(a){q.on.apply(q,a)})}var q=this;q.firstLoad=!0;var r,s=a,t=b,d=d,u=document.location.href,v=document.referrer||"Direct",w=e,x=!0,y=!1,z=null,A={},B=1;this.events=[],this.initialized=!1,this.userActive=function(){q.pingInterval=setTimeout(o,0)},this.userInactive=function(){q.pingInterval&&(q.pingInterval=clearTimeout(q.pingInterval))},this.setUserAlwaysActive=function(){y=!0,f(),q.pingInterval||setTimeout(o,0)},this.unsetUserAlwaysActive=function(){y=!1,f(),q.pingInterval||setTimeout(o,0)},this.setAdditionalInfo=function(a){for(var b in a)A[b]=a[b]},this.trigger=function(a,b){for(var c=0;c<this.events.length;c++)this.events[c].eventName==a&&this.events[c].applyCallback(b)},this.on=function(a,b){this.events.push(new c(a,b))},this.off=function(a){this.events.forEach(function(b){b.eventName==a&&(b.remove=!0)});var b=[];this.events.forEach(function(a){a.remove||b.push(a)}),this.events=b},this.init=function(){i(),p(),q.userActive(),this.initialized=!0},h()}function e(a){return new RegExp("([\\s.]|&nbsp;|^)("+a+")(?=[\\s.]|&nbsp;|$)","gim")}var f={pingQueueUrl:"https://checkin.purechat.com/api/checkin",pidCookieName:"prodvtftwPID",pingInterval:5e3,sessionTimeout:12e5},g={jsonToQuery:function(a){a=a||{};var b="?";for(var c in a)b+=c+"="+encodeURIComponent((a[c]||"").toString())+"&";return b},_parseResponseAsJSON:function(a){a=(a||"{}").trim();try{return JSON.parse(a)}catch(b){console.log("Unable to parse JSON from tiny Ajax request."),console.log(b)}},_mapOptionsToRequest:function(a,b){a.withCredentials=b.withCredentials||!1},_createRequest:function(a,b,c,d){var e=g._getSuccessCallback(d),f=g._getErrorCallback(d),h=g._getAlwaysCallback(d);if(window.XMLHttpRequest){var i=new XMLHttpRequest;g._mapOptionsToRequest(i,d),i.onreadystatechange=function(){if(200==i.status&&4==i.readyState){var a=(i.getResponseHeader("Content-Type")||"").toLowerCase();a.search("application/json")>-1;var b=g._parseResponseAsJSON(i.responseText);e(b),h(b)}},i.onerror=function(){f(),h()};for(var j in c)"object"==typeof c[j]&&(c[j]=JSON.stringify(c[j]));switch(a){case"POST":case"PUT":i.open(a,b,!0),i.setRequestHeader("Content-Type","application/json; charset=utf-8"),i.send(JSON.stringify(c));break;default:b+=g.jsonToQuery(c),i.open(a,b,!0),i.send()}}else console.log("Browser does not support XMLHttpRequests")},_getSuccessCallback:function(a){return a.callback||function(){}},_getErrorCallback:function(a){return a.error||function(){}},_getAlwaysCallback:function(a){return a.always||function(){}},get:function(a,b,c){g._createRequest("GET",a,b,c)},post:function(a,b,c){g._createRequest("POST",a,b,c)},"delete":function(a,b){g._createRequest("DELETE",a,data,b)},put:function(a,b,c){g._createRequest("PUT",a,b,c)}};!function(){PureChat=function(b,c,d,e,f,g,h,i,j,k){var l=this;this.currentUserId=c,this.currentDomainId=d,this.currentAuthToken=e,this.poppedOut=i,this.emailMD5Hash=j,l.setConnectionStatus(0),io.transports=["websocket"];var m={"reconnection limit":15e3,"max reconnection attempts":k||1/0};this.socket=io.connect(b,m),this.socket.socket.connecting||this.socket.socket.reconnect(),this.messageQueue=[],this.eventFncMappings={},this.registerHandler=function(b){var c=function(c){a[b]?a[b].call(l,c):a["default"].call(l,b,c)};l.eventFncMappings[b]=c,l.socket.on(b,l.eventFncMappings[b])},this.chatServerEvents=["message","joined","left","roomdestroyed","userDestroyed","typing","reidentify","userdeleted","chat-counts","opInvite","roomchanged","roomclosed","rooms","onlineOperatorStatus","opStatus","serverNotice","roomdetailschanged","userSettings:change","canned-responses:changed","canned-responses:added","canned-responses:deleted","userOnboarding:change","operator:refresh","noOperatorJoined"],this.chatServerEvents.forEach(function(a){l.registerHandler(a)}),this.socket.on("connect",function(){this.reconnectCount=0,l.setConnectionStatus(1),l.identify(l.currentUserId,l.currentDomainId,l.currentAuthToken,f,l.poppedOut,l.emailMD5Hash),l.trigger("connection:connected:socketio")}),this.socket.on("disconnect",function(){l.setConnectionStatus(0),console.log("Just disconnected..."),l.trigger("connection:disconnected:socketio")}),this.socket.on("reconnecting",function(){this.reconnectCount++,console.log("reconnecting..."),this.reconnectCount>8&&l.setConnectionStatus(3)}),l.on("connection:retry:socketio",function(){var a=l.socket.socket;!a.connected&&a.reconnectionAttempts>=8&&a.reconnect()}),g&&this.socket.on("error",g)},PureChat.prototype.setConnectionStatus=function(a){this.status=a,this.trigger("change:connectionStatus",this,a)},PureChat.prototype.disconnect=function(){this.socket.disconnect(),this.socket.socket.disconnect(),this.socket.removeAllListeners(),this.socket=null},PureChat.prototype.identify=function(a,b,c,d,e,f){function g(a,b,c,e){a&&h.setConnectionStatus(2),d.apply(this,arguments)}var h=this;this.currentUserId=a,this.currentDomainId=b,this.currentAuthToken=c,this.deviceType=PureChat.enums.deviceType.desktop,this.poppedOut=e,this.protocolVersion="2.0",this.emailMD5Hash=f,this.socket.emit("identify",{userId:this.currentUserId,domainId:this.currentDomainId,authToken:this.currentAuthToken,deviceType:this.deviceType,deviceVersion:PureChat.deviceVersion,poppedOut:this.poppedOut,protocolVersion:this.protocolVersion,emailMD5Hash:this.emailMD5Hash},g)},PureChat.prototype.sendmessage=function(a,b,c){this.socket.emit("sendmessage",{message:a,roomId:b},c)},PureChat.prototype.sendtyping=function(a,b,c){this.socket.emit("sendtyping",{roomId:a,isTyping:b},c)},PureChat.prototype.destroyself=function(a,b){this.socket.emit("destroyself",b||{},a)},PureChat.prototype.join=function(a,b){var c=a.roomId,d=a.invisible,e=a.joinType;this.socket.emit("join",{roomId:c,invisible:d,joinType:e},b)},PureChat.prototype.leave=function(a,b){this.socket.emit("leave",{roomId:a},b)},PureChat.prototype.closeroom=function(a,b){this.socket.emit("closeroom",{roomId:a},b)},PureChat.prototype.createoperatorroom=function(a,b,c,d,e){this.socket.emit("createoperatorroom",{roomName:a,otherUserIds:b},c,d,e)},PureChat.prototype.sendcurrentstate=function(a){this.socket.emit("sendcurrentstate",{},a)},PureChat.prototype.getuser=function(a){this.socket.emit("getuser",a)},PureChat.prototype.getusers=function(a){this.socket.emit("getusers",a)},PureChat.prototype.sendroomhistory=function(a,b){this.socket.emit("sendroomhistory",{roomId:a},b)},PureChat.prototype.setavailable=function(a,b,c,d){this.socket.emit("setavailable",{userId:a,connectionId:b,available:c},d)},PureChat.prototype.setWidgetTypeAvailable=function(a,b,c,d){this.socket.emit("setwidgettypeavailable",{userId:a,widgetType:b,available:c},d)},PureChat.prototype.forcedisconnect=function(a,b,c){this.socket.emit("forcedisconnect",{userId:a,connectionId:b},c)},PureChat.prototype.startdemo=function(a,b){this.socket.emit("startdemo",{widgetId:a},b)},PureChat.prototype.sendInvite=function(a,b,c,d,e){this.socket.emit("opInvite",{userId:a,roomId:b,roomName:c,fromName:d},e)},PureChat.prototype.setVisitorDetails=function(a,b,c){this.socket.emit("setvisitordetails",{roomId:a,details:b},c)},PureChat.deviceVersion=1,PureChat.enums={deviceType:{desktop:0,ios:1},roomType:{account:0,operator:1,visitor:2}};var a={message:function(a){var b=a.userDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),c=a.roomDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),d=(a.message||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.trigger("message",a.userId,b,a.roomId,c,a.time,d.length>0?d:null,a.isHistory,a.timeElapsed,a.protocolVersion,a.avatarUrl,a.fromOperator,a.roomUtcOffset)},joined:function(a){var b=a.userDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),c=a.roomDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.trigger("joined",a.userId,b,a.roomId,c,a.time,a.isHistory)},left:function(a){var b=a.userDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),c=a.roomDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.trigger("left",a.userId,b,a.roomId,c,a.time,a.isHistory)},roomdestroyed:function(a){var b=a.roomDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.trigger("roomdestroyed",a.roomId,b,a.time,a.reasonCode)},userDestroyed:function(a){this.trigger("userDestroyed",a.userId)},typing:function(a){var b=a.userDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");a.roomDisplayName.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.trigger("typing",a.userId,b,a.roomId,a.roomDisplayName,a.isTyping,a.time)},roomchanged:function(a){a&&"closedroom"==a.action&&purechatApp.execute("roomclosed",a.room.id),this.trigger("roomchanged",a)},"default":function(a,b){this.trigger(a,b)}},b=[],c=(b.push,b.slice);b.splice;PureChat.prototype.on=function(a,b,c){if(!e(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},PureChat.prototype.once=function(a,b,c){if(!e(this,"once",a,[b,c])||!b)return this;var d=this,f=_.once(function(){d.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,c)},PureChat.prototype.off=function(a,b,c){var d,f,g,h,i,j,k,l;if(!this._events||!e(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(h=a?[a]:_.keys(this._events),i=0,j=h.length;j>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=d=[],b||c)for(k=0,l=g.length;l>k;k++)f=g[k],(b&&b!==f.callback&&b!==f.callback._callback||c&&c!==f.context)&&d.push(f);d.length||delete this._events[a]}return this},PureChat.prototype.trigger=function(a){if(!this._events)return this;var b=c.call(arguments,1);if(!e(this,"trigger",a,b))return this;var d=this._events[a],g=this._events.all;return d&&f(d,b),g&&f(g,arguments),this},PureChat.prototype.stopListening=function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this};var d=/\s+/,e=function(a,b,c,e){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(e));return!1}if(d.test(c)){for(var g=c.split(d),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(e));return!1}return!0},f=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}}}(),a=void 0;var h=window.$,j=window.$pureChatJquery;(function(){function b(a){function b(b,c,d,e,f,g){for(;f>=0&&g>f;f+=a){var h=e?e[f]:f;d=c(d,b[h],h,b)}return d}return function(c,d,e,f){d=t(d,f,4);var g=!y(c)&&s.keys(c),h=(g||c).length,i=a>0?0:h-1;return arguments.length<3&&(e=c[g?g[i]:i],i+=a),b(c,d,e,g,i,h)}}function c(a){return function(b,c,d){c=u(c,d);for(var e=null!=b&&b.length,f=a>0?0:e-1;f>=0&&e>f;f+=a)if(c(b[f],f,b))return f;return-1}}function d(a,b){var c=D.length,d=a.constructor,e=s.isFunction(d)&&d.prototype||h,f="constructor";for(s.has(a,f)&&!s.contains(b,f)&&b.push(f);c--;)f=D[c],f in a&&a[f]!==e[f]&&!s.contains(b,f)&&b.push(f)}var e=this,f=e._,g=Array.prototype,h=Object.prototype,i=Function.prototype,j=g.push,k=g.slice,l=h.toString,m=h.hasOwnProperty,n=Array.isArray,o=Object.keys,p=i.bind,q=Object.create,r=function(){},s=function(a){return a instanceof s?a:this instanceof s?void(this._wrapped=a):new s(a)};"undefined"!=typeof a?("undefined"!=typeof module&&module.exports&&(a=module.exports=s),a._=s):e._=s,s.VERSION="1.8.2";var t=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return function(){return a.apply(b,arguments)}},u=function(a,b,c){return null==a?s.identity:s.isFunction(a)?t(a,b,c):s.isObject(a)?s.matcher(a):s.property(a)};s.iteratee=function(a,b){return u(a,b,1/0)};var v=function(a,b){return function(c){var d=arguments.length;if(2>d||null==c)return c;for(var e=1;d>e;e++)for(var f=arguments[e],g=a(f),h=g.length,i=0;h>i;i++){var j=g[i];b&&void 0!==c[j]||(c[j]=f[j])}return c}},w=function(a){if(!s.isObject(a))return{};if(q)return q(a);r.prototype=a;var b=new r;return r.prototype=null,b},x=Math.pow(2,53)-1,y=function(a){var b=a&&a.length;return"number"==typeof b&&b>=0&&x>=b};s.each=s.forEach=function(a,b,c){b=t(b,c);var d,e;if(y(a))for(d=0,e=a.length;e>d;d++)b(a[d],d,a);else{var f=s.keys(a);for(d=0,e=f.length;e>d;d++)b(a[f[d]],f[d],a)}return a},s.map=s.collect=function(a,b,c){b=u(b,c);for(var d=!y(a)&&s.keys(a),e=(d||a).length,f=Array(e),g=0;e>g;g++){var h=d?d[g]:g;f[g]=b(a[h],h,a)}return f},s.reduce=s.foldl=s.inject=b(1),s.reduceRight=s.foldr=b(-1),s.find=s.detect=function(a,b,c){var d;return d=y(a)?s.findIndex(a,b,c):s.findKey(a,b,c),void 0!==d&&-1!==d?a[d]:void 0},s.filter=s.select=function(a,b,c){var d=[];return b=u(b,c),s.each(a,function(a,c,e){b(a,c,e)&&d.push(a)}),d},s.reject=function(a,b,c){return s.filter(a,s.negate(u(b)),c)},s.every=s.all=function(a,b,c){b=u(b,c);for(var d=!y(a)&&s.keys(a),e=(d||a).length,f=0;e>f;f++){var g=d?d[f]:f;if(!b(a[g],g,a))return!1}return!0},s.some=s.any=function(a,b,c){b=u(b,c);for(var d=!y(a)&&s.keys(a),e=(d||a).length,f=0;e>f;f++){var g=d?d[f]:f;if(b(a[g],g,a))return!0}return!1},s.contains=s.includes=s.include=function(a,b,c){return y(a)||(a=s.values(a)),s.indexOf(a,b,"number"==typeof c&&c)>=0},s.invoke=function(a,b){var c=k.call(arguments,2),d=s.isFunction(b);return s.map(a,function(a){var e=d?b:a[b];return null==e?e:e.apply(a,c)})},s.pluck=function(a,b){return s.map(a,s.property(b))},s.where=function(a,b){return s.filter(a,s.matcher(b))},s.findWhere=function(a,b){return s.find(a,s.matcher(b))},s.max=function(a,b,c){var d,e,f=-1/0,g=-1/0;if(null==b&&null!=a){a=y(a)?a:s.values(a);for(var h=0,i=a.length;i>h;h++)d=a[h],d>f&&(f=d)}else b=u(b,c),s.each(a,function(a,c,d){e=b(a,c,d),(e>g||e===-1/0&&f===-1/0)&&(f=a,g=e)});return f},s.min=function(a,b,c){var d,e,f=1/0,g=1/0;if(null==b&&null!=a){a=y(a)?a:s.values(a);for(var h=0,i=a.length;i>h;h++)d=a[h],f>d&&(f=d)}else b=u(b,c),s.each(a,function(a,c,d){e=b(a,c,d),(g>e||1/0===e&&1/0===f)&&(f=a,g=e)});return f},s.shuffle=function(a){for(var b,c=y(a)?a:s.values(a),d=c.length,e=Array(d),f=0;d>f;f++)b=s.random(0,f),b!==f&&(e[f]=e[b]),e[b]=c[f];return e},s.sample=function(a,b,c){return null==b||c?(y(a)||(a=s.values(a)),a[s.random(a.length-1)]):s.shuffle(a).slice(0,Math.max(0,b))},s.sortBy=function(a,b,c){return b=u(b,c),s.pluck(s.map(a,function(a,c,d){return{value:a,index:c,criteria:b(a,c,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")};var z=function(a){return function(b,c,d){var e={};return c=u(c,d),s.each(b,function(d,f){var g=c(d,f,b);a(e,d,g)}),e}};s.groupBy=z(function(a,b,c){s.has(a,c)?a[c].push(b):a[c]=[b]}),s.indexBy=z(function(a,b,c){a[c]=b}),s.countBy=z(function(a,b,c){s.has(a,c)?a[c]++:a[c]=1}),s.toArray=function(a){return a?s.isArray(a)?k.call(a):y(a)?s.map(a,s.identity):s.values(a):[]},s.size=function(a){return null==a?0:y(a)?a.length:s.keys(a).length},s.partition=function(a,b,c){b=u(b,c);var d=[],e=[];return s.each(a,function(a,c,f){(b(a,c,f)?d:e).push(a)}),[d,e]},s.first=s.head=s.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:s.initial(a,a.length-b)},s.initial=function(a,b,c){return k.call(a,0,Math.max(0,a.length-(null==b||c?1:b)))},s.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:s.rest(a,Math.max(0,a.length-b))},s.rest=s.tail=s.drop=function(a,b,c){return k.call(a,null==b||c?1:b)},s.compact=function(a){return s.filter(a,s.identity)};var A=function(a,b,c,d){for(var e=[],f=0,g=d||0,h=a&&a.length;h>g;g++){var i=a[g];if(y(i)&&(s.isArray(i)||s.isArguments(i))){b||(i=A(i,b,c));var j=0,k=i.length;for(e.length+=k;k>j;)e[f++]=i[j++]}else c||(e[f++]=i)}return e};s.flatten=function(a,b){return A(a,b,!1)},s.without=function(a){return s.difference(a,k.call(arguments,1))},s.uniq=s.unique=function(a,b,c,d){if(null==a)return[];s.isBoolean(b)||(d=c,c=b,b=!1),null!=c&&(c=u(c,d));for(var e=[],f=[],g=0,h=a.length;h>g;g++){var i=a[g],j=c?c(i,g,a):i;b?(g&&f===j||e.push(i),f=j):c?s.contains(f,j)||(f.push(j),e.push(i)):s.contains(e,i)||e.push(i)}return e},s.union=function(){return s.uniq(A(arguments,!0,!0))},s.intersection=function(a){if(null==a)return[];for(var b=[],c=arguments.length,d=0,e=a.length;e>d;d++){var f=a[d];if(!s.contains(b,f)){for(var g=1;c>g&&s.contains(arguments[g],f);g++);g===c&&b.push(f)}}return b},s.difference=function(a){var b=A(arguments,!0,!0,1);return s.filter(a,function(a){return!s.contains(b,a)})},s.zip=function(){return s.unzip(arguments)},s.unzip=function(a){for(var b=a&&s.max(a,"length").length||0,c=Array(b),d=0;b>d;d++)c[d]=s.pluck(a,d);return c},s.object=function(a,b){for(var c={},d=0,e=a&&a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},s.indexOf=function(a,b,c){var d=0,e=a&&a.length;if("number"==typeof c)d=0>c?Math.max(0,e+c):c;else if(c&&e)return d=s.sortedIndex(a,b),a[d]===b?d:-1;if(b!==b)return s.findIndex(k.call(a,d),s.isNaN);for(;e>d;d++)if(a[d]===b)return d;return-1},s.lastIndexOf=function(a,b,c){var d=a?a.length:0;if("number"==typeof c&&(d=0>c?d+c+1:Math.min(d,c+1)),b!==b)return s.findLastIndex(k.call(a,0,d),s.isNaN);for(;--d>=0;)if(a[d]===b)return d;return-1},s.findIndex=c(1),s.findLastIndex=c(-1),s.sortedIndex=function(a,b,c,d){c=u(c,d,1);for(var e=c(b),f=0,g=a.length;g>f;){var h=Math.floor((f+g)/2);c(a[h])<e?f=h+1:g=h}return f},s.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=c||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=Array(d),f=0;d>f;f++,a+=c)e[f]=a;return e};var B=function(a,b,c,d,e){if(!(d instanceof b))return a.apply(c,e);var f=w(a.prototype),g=a.apply(f,e);return s.isObject(g)?g:f};s.bind=function(a,b){if(p&&a.bind===p)return p.apply(a,k.call(arguments,1));if(!s.isFunction(a))throw new TypeError("Bind must be called on a function");var c=k.call(arguments,2),d=function(){return B(a,d,b,this,c.concat(k.call(arguments)))};return d},s.partial=function(a){var b=k.call(arguments,1),c=function(){for(var d=0,e=b.length,f=Array(e),g=0;e>g;g++)f[g]=b[g]===s?arguments[d++]:b[g];for(;d<arguments.length;)f.push(arguments[d++]);return B(a,c,this,this,f)};return c},s.bindAll=function(a){var b,c,d=arguments.length;if(1>=d)throw new Error("bindAll must be passed function names");for(b=1;d>b;b++)c=arguments[b],a[c]=s.bind(a[c],a);return a},s.memoize=function(a,b){var c=function(d){var e=c.cache,f=""+(b?b.apply(this,arguments):d);return s.has(e,f)||(e[f]=a.apply(this,arguments)),e[f]};return c.cache={},c},s.delay=function(a,b){var c=k.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},s.defer=s.partial(s.delay,s,1),s.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=c.leading===!1?0:s.now(),g=null,f=a.apply(d,e),g||(d=e=null)};return function(){var j=s.now();h||c.leading!==!1||(h=j);var k=b-(j-h);return d=this,e=arguments,0>=k||k>b?(g&&(clearTimeout(g),g=null),h=j,f=a.apply(d,e),g||(d=e=null)):g||c.trailing===!1||(g=setTimeout(i,k)),f}},s.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=s.now()-g;b>j&&j>=0?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),d||(f=e=null)))};return function(){f=this,e=arguments,g=s.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},s.wrap=function(a,b){return s.partial(b,a)},s.negate=function(a){return function(){return!a.apply(this,arguments)}},s.compose=function(){var a=arguments,b=a.length-1;return function(){for(var c=b,d=a[b].apply(this,arguments);c--;)d=a[c].call(this,d);return d}},s.after=function(a,b){return function(){return--a<1?b.apply(this,arguments):void 0}},s.before=function(a,b){var c;return function(){return--a>0&&(c=b.apply(this,arguments)),1>=a&&(b=null),c}},s.once=s.partial(s.before,2);var C=!{toString:null}.propertyIsEnumerable("toString"),D=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];s.keys=function(a){if(!s.isObject(a))return[];if(o)return o(a);var b=[];for(var c in a)s.has(a,c)&&b.push(c);return C&&d(a,b),b},s.allKeys=function(a){if(!s.isObject(a))return[];var b=[];for(var c in a)b.push(c);return C&&d(a,b),b},s.values=function(a){for(var b=s.keys(a),c=b.length,d=Array(c),e=0;c>e;e++)d[e]=a[b[e]];return d},s.mapObject=function(a,b,c){b=u(b,c);for(var d,e=s.keys(a),f=e.length,g={},h=0;f>h;h++)d=e[h],g[d]=b(a[d],d,a);return g},s.pairs=function(a){for(var b=s.keys(a),c=b.length,d=Array(c),e=0;c>e;e++)d[e]=[b[e],a[b[e]]];return d},s.invert=function(a){for(var b={},c=s.keys(a),d=0,e=c.length;e>d;d++)b[a[c[d]]]=c[d];return b},s.functions=s.methods=function(a){var b=[];for(var c in a)s.isFunction(a[c])&&b.push(c);return b.sort()},s.extend=v(s.allKeys),s.extendOwn=s.assign=v(s.keys),s.findKey=function(a,b,c){b=u(b,c);for(var d,e=s.keys(a),f=0,g=e.length;g>f;f++)if(d=e[f],b(a[d],d,a))return d},s.pick=function(a,b,c){var d,e,f={},g=a;if(null==g)return f;s.isFunction(b)?(e=s.allKeys(g),d=t(b,c)):(e=A(arguments,!1,!1,1),d=function(a,b,c){return b in c},g=Object(g));for(var h=0,i=e.length;i>h;h++){var j=e[h],k=g[j];d(k,j,g)&&(f[j]=k)}return f},s.omit=function(a,b,c){if(s.isFunction(b))b=s.negate(b);else{var d=s.map(A(arguments,!1,!1,1),String);b=function(a,b){return!s.contains(d,b)}}return s.pick(a,b,c)},s.defaults=v(s.allKeys,!0),s.clone=function(a){return s.isObject(a)?s.isArray(a)?a.slice():s.extend({},a):a},s.tap=function(a,b){return b(a),a},s.isMatch=function(a,b){var c=s.keys(b),d=c.length;if(null==a)return!d;for(var e=Object(a),f=0;d>f;f++){var g=c[f];if(b[g]!==e[g]||!(g in e))return!1}return!0};var E=function(a,b,c,d){if(a===b)return 0!==a||1/a===1/b;if(null==a||null==b)return a===b;a instanceof s&&(a=a._wrapped),b instanceof s&&(b=b._wrapped);var e=l.call(a);if(e!==l.call(b))return!1;switch(e){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}var f="[object Array]"===e;if(!f){if("object"!=typeof a||"object"!=typeof b)return!1;var g=a.constructor,h=b.constructor;if(g!==h&&!(s.isFunction(g)&&g instanceof g&&s.isFunction(h)&&h instanceof h)&&"constructor"in a&&"constructor"in b)return!1}c=c||[],d=d||[];for(var i=c.length;i--;)if(c[i]===a)return d[i]===b;if(c.push(a),d.push(b),f){if(i=a.length,i!==b.length)return!1;for(;i--;)if(!E(a[i],b[i],c,d))return!1}else{var j,k=s.keys(a);if(i=k.length,s.keys(b).length!==i)return!1;for(;i--;)if(j=k[i],!s.has(b,j)||!E(a[j],b[j],c,d))return!1}return c.pop(),d.pop(),!0};s.isEqual=function(a,b){return E(a,b)},s.isEmpty=function(a){return null==a?!0:y(a)&&(s.isArray(a)||s.isString(a)||s.isArguments(a))?0===a.length:0===s.keys(a).length},s.isElement=function(a){return!(!a||1!==a.nodeType)},s.isArray=n||function(a){return"[object Array]"===l.call(a)},s.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},s.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(a){s["is"+a]=function(b){return l.call(b)==="[object "+a+"]"}}),s.isArguments(arguments)||(s.isArguments=function(a){return s.has(a,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(s.isFunction=function(a){return"function"==typeof a||!1}),s.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},s.isNaN=function(a){return s.isNumber(a)&&a!==+a},s.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"===l.call(a)},s.isNull=function(a){return null===a},s.isUndefined=function(a){return void 0===a},s.has=function(a,b){return null!=a&&m.call(a,b)},s.noConflict=function(){return e._=f,this},s.identity=function(a){return a},s.constant=function(a){return function(){return a}},s.noop=function(){},s.property=function(a){return function(b){return null==b?void 0:b[a]}},s.propertyOf=function(a){return null==a?function(){}:function(b){return a[b]}},s.matcher=s.matches=function(a){return a=s.extendOwn({},a),function(b){return s.isMatch(b,a)}},s.times=function(a,b,c){var d=Array(Math.max(0,a));b=t(b,c,1);for(var e=0;a>e;e++)d[e]=b(e);return d},s.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},s.now=Date.now||function(){return(new Date).getTime()};var F={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},G=s.invert(F),H=function(a){var b=function(b){return a[b]},c="(?:"+s.keys(a).join("|")+")",d=RegExp(c),e=RegExp(c,"g");return function(a){return a=null==a?"":""+a,d.test(a)?a.replace(e,b):a}};s.escape=H(F),s.unescape=H(G),s.result=function(a,b,c){var d=null==a?void 0:a[b];return void 0===d&&(d=c),s.isFunction(d)?d.call(a):d};var I=0;s.uniqueId=function(a){var b=++I+"";return a?a+b:b},s.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var J=/(.)^/,K={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\u2028|\u2029/g,M=function(a){return"\\"+K[a]};s.template=function(a,b,c){!b&&c&&(b=c),b=s.defaults({},b,s.templateSettings);var d=RegExp([(b.escape||J).source,(b.interpolate||J).source,(b.evaluate||J).source].join("|")+"|$","g"),e=0,f="__p+='";a.replace(d,function(b,c,d,g,h){return f+=a.slice(e,h).replace(L,M),e=h+b.length,c?f+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":d?f+="'+\n((__t=("+d+"))==null?'':__t)+\n'":g&&(f+="';\n"+g+"\n__p+='"),b}),f+="';\n",b.variable||(f="with(obj||{}){\n"+f+"}\n"),f="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+f+"return __p;\n";try{var g=new Function(b.variable||"obj","_",f)}catch(h){throw h.source=f,h}var i=function(a){return g.call(this,a,s)},j=b.variable||"obj";return i.source="function("+j+"){\n"+f+"}",i},s.chain=function(a){var b=s(a);return b._chain=!0,b};var N=function(a,b){return a._chain?s(b).chain():b};s.mixin=function(a){s.each(s.functions(a),function(b){var c=s[b]=a[b];s.prototype[b]=function(){var a=[this._wrapped];return j.apply(a,arguments),N(this,c.apply(s,a))}})},s.mixin(s),s.each(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=g[a];s.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!==a&&"splice"!==a||0!==c.length||delete c[0],N(this,c)}}),s.each(["concat","join","slice"],function(a){var b=g[a];s.prototype[a]=function(){return N(this,b.apply(this._wrapped,arguments))}}),s.prototype.value=function(){return this._wrapped},s.prototype.valueOf=s.prototype.toJSON=s.prototype.value,s.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return s})}).call(this),function(a,b){a.Backbone=b(a,{},a._,a.jQuery||a.Zepto||a.ender||a.$)}(this,function(a,b,c,d){var e=a.Backbone,f=[],g=(f.push,f.slice);f.splice;b.VERSION="1.1.2",b.$=d,b.noConflict=function(){return a.Backbone=e,this},b.emulateHTTP=!1,b.emulateJSON=!1;var h=b.Events={on:function(a,b,c){if(!j(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,d){if(!j(this,"once",a,[b,d])||!b)return this;var e=this,f=c.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,d)},off:function(a,b,d){var e,f,g,h,i,k,l,m;if(!this._events||!j(this,"off",a,[b,d]))return this;if(!a&&!b&&!d)return this._events=void 0,this;for(h=a?[a]:c.keys(this._events),i=0,k=h.length;k>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=e=[],b||d)for(l=0,m=g.length;m>l;l++)f=g[l],(b&&b!==f.callback&&b!==f.callback._callback||d&&d!==f.context)&&e.push(f);e.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=g.call(arguments,1);if(!j(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&k(c,b),d&&k(d,arguments),this},stopListening:function(a,b,d){var e=this._listeningTo;if(!e)return this;var f=!b&&!d;d||"object"!=typeof b||(d=this),a&&((e={})[a._listenId]=a);for(var g in e)a=e[g],a.off(b,d,this),(f||c.isEmpty(a._events))&&delete this._listeningTo[g];return this}},i=/\s+/,j=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(i.test(c)){for(var f=c.split(i),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},k=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},l={listenTo:"on",listenToOnce:"once"};c.each(l,function(a,b){h[b]=function(b,d,e){var f=this._listeningTo||(this._listeningTo={}),g=b._listenId||(b._listenId=c.uniqueId("l"));return f[g]=b,e||"object"!=typeof d||(e=this),b[a](d,e,this),this}}),h.bind=h.on,h.unbind=h.off,c.extend(b,h);var m=b.Model=function(a,b){var d=a||{};b||(b={}),this.cid=c.uniqueId("c"),this.attributes={},b.collection&&(this.collection=b.collection),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this.changed={},this.initialize.apply(this,arguments)};c.extend(m.prototype,h,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(a){return c.clone(this.attributes)},sync:function(){return b.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return c.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,d){var e,f,g,h,i,j,k,l;if(null==a)return this;if("object"==typeof a?(f=a,d=b):(f={})[a]=b,d||(d={}),!this._validate(f,d))return!1;g=d.unset,i=d.silent,h=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=c.clone(this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in f&&(this.id=f[this.idAttribute]);for(e in f)b=f[e],c.isEqual(l[e],b)||h.push(e),c.isEqual(k[e],b)?delete this.changed[e]:this.changed[e]=b,g?delete l[e]:l[e]=b;if(!i){h.length&&(this._pending=d);for(var m=0,n=h.length;n>m;m++)this.trigger("change:"+h[m],this,l[h[m]],d)}if(j)return this;if(!i)for(;this._pending;)d=this._pending,this._pending=!1,
this.trigger("change",this,d);return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,void 0,c.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var d in this.attributes)b[d]=void 0;return this.set(b,c.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!c.isEmpty(this.changed):c.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?c.clone(this.changed):!1;var b,d=!1,e=this._changing?this._previousAttributes:this.attributes;for(var f in a)c.isEqual(e[f],b=a[f])||((d||(d={}))[f]=b);return d},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return c.clone(this._previousAttributes)},fetch:function(a){a=a?c.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=this,d=a.success;return a.success=function(c){return b.set(b.parse(c,a),a)?(d&&d(b,c,a),void b.trigger("sync",b,c,a)):!1},L(this,a),this.sync("read",this,a)},save:function(a,b,d){var e,f,g,h=this.attributes;if(null==a||"object"==typeof a?(e=a,d=b):(e={})[a]=b,d=c.extend({validate:!0},d),e&&!d.wait){if(!this.set(e,d))return!1}else if(!this._validate(e,d))return!1;e&&d.wait&&(this.attributes=c.extend({},h,e)),void 0===d.parse&&(d.parse=!0);var i=this,j=d.success;return d.success=function(a){i.attributes=h;var b=i.parse(a,d);return d.wait&&(b=c.extend(e||{},b)),c.isObject(b)&&!i.set(b,d)?!1:(j&&j(i,a,d),void i.trigger("sync",i,a,d))},L(this,d),f=this.isNew()?"create":d.patch?"patch":"update","patch"===f&&(d.attrs=e),g=this.sync(f,this,d),e&&d.wait&&(this.attributes=h),g},destroy:function(a){a=a?c.clone(a):{};var b=this,d=a.success,e=function(){b.trigger("destroy",b,b.collection,a)};if(a.success=function(c){(a.wait||b.isNew())&&e(),d&&d(b,c,a),b.isNew()||b.trigger("sync",b,c,a)},this.isNew())return a.success(),!1;L(this,a);var f=this.sync("delete",this,a);return a.wait||e(),f},url:function(){var a=c.result(this,"urlRoot")||c.result(this.collection,"url")||K();return this.isNew()?a:a.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(a){return this._validate({},c.extend(a||{},{validate:!0}))},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=c.extend({},this.attributes,a);var d=this.validationError=this.validate(a,b)||null;return d?(this.trigger("invalid",this,d,c.extend(b,{validationError:d})),!1):!0}});var n=["keys","values","pairs","invert","pick","omit"];c.each(n,function(a){m.prototype[a]=function(){var b=g.call(arguments);return b.unshift(this.attributes),c[a].apply(c,b)}});var o=b.Collection=function(a,b){b||(b={}),b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,c.extend({silent:!0},b))},p={add:!0,remove:!0,merge:!0},q={add:!0,remove:!1};c.extend(o.prototype,h,{model:m,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return b.sync.apply(this,arguments)},add:function(a,b){return this.set(a,c.extend({merge:!1},b,q))},remove:function(a,b){var d=!c.isArray(a);a=d?[a]:c.clone(a),b||(b={});var e,f,g,h;for(e=0,f=a.length;f>e;e++)h=a[e]=this.get(a[e]),h&&(delete this._byId[h.id],delete this._byId[h.cid],g=this.indexOf(h),this.models.splice(g,1),this.length--,b.silent||(b.index=g,h.trigger("remove",h,this,b)),this._removeReference(h,b));return d?a[0]:a},set:function(a,b){b=c.defaults({},b,p),b.parse&&(a=this.parse(a,b));var d=!c.isArray(a);a=d?a?[a]:[]:c.clone(a);var e,f,g,h,i,j,k,l=b.at,n=this.model,o=this.comparator&&null==l&&b.sort!==!1,q=c.isString(this.comparator)?this.comparator:null,r=[],s=[],t={},u=b.add,v=b.merge,w=b.remove,x=!o&&u&&w?[]:!1;for(e=0,f=a.length;f>e;e++){if(i=a[e]||{},g=i instanceof m?h=i:i[n.prototype.idAttribute||"id"],j=this.get(g))w&&(t[j.cid]=!0),v&&(i=i===h?h.attributes:i,b.parse&&(i=j.parse(i,b)),j.set(i,b),o&&!k&&j.hasChanged(q)&&(k=!0)),a[e]=j;else if(u){if(h=a[e]=this._prepareModel(i,b),!h)continue;r.push(h),this._addReference(h,b)}h=j||h,!x||!h.isNew()&&t[h.id]||x.push(h),t[h.id]=!0}if(w){for(e=0,f=this.length;f>e;++e)t[(h=this.models[e]).cid]||s.push(h);s.length&&this.remove(s,b)}if(r.length||x&&x.length)if(o&&(k=!0),this.length+=r.length,null!=l)for(e=0,f=r.length;f>e;e++)this.models.splice(l+e,0,r[e]);else{x&&(this.models.length=0);var y=x||r;for(e=0,f=y.length;f>e;e++)this.models.push(y[e])}if(k&&this.sort({silent:!0}),!b.silent){for(e=0,f=r.length;f>e;e++)(h=r[e]).trigger("add",h,this,b);(k||x&&x.length)&&this.trigger("sort",this,b)}return d?a[0]:a},reset:function(a,b){b||(b={});for(var d=0,e=this.models.length;e>d;d++)this._removeReference(this.models[d],b);return b.previousModels=this.models,this._reset(),a=this.add(a,c.extend({silent:!0},b)),b.silent||this.trigger("reset",this,b),a},push:function(a,b){return this.add(a,c.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return this.add(a,c.extend({at:0},b))},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(){return g.apply(this.models,arguments)},get:function(a){return null!=a?this._byId[a]||this._byId[a.id]||this._byId[a.cid]:void 0},at:function(a){return this.models[a]},where:function(a,b){return c.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),c.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(c.bind(this.comparator,this)),a.silent||this.trigger("sort",this,a),this},pluck:function(a){return c.invoke(this.models,"get",a)},fetch:function(a){a=a?c.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=a.success,d=this;return a.success=function(c){var e=a.reset?"reset":"set";d[e](c,a),b&&b(d,c,a),d.trigger("sync",d,c,a)},L(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?c.clone(b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var d=this,e=b.success;return b.success=function(a,c){b.wait&&d.add(a,b),e&&e(a,c,b)},a.save(null,b),a},parse:function(a,b){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof m)return a;b=b?c.clone(b):{},b.collection=this;var d=new this.model(a,b);return d.validationError?(this.trigger("invalid",this,d.validationError,b),!1):d},_addReference:function(a,b){this._byId[a.cid]=a,null!=a.id&&(this._byId[a.id]=a),a.collection||(a.collection=this),a.on("all",this._onModelEvent,this)},_removeReference:function(a,b){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"!==a&&"remove"!==a||c===this)&&("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))}});var r=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];c.each(r,function(a){o.prototype[a]=function(){var b=g.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}});var s=["groupBy","countBy","sortBy","indexBy"];c.each(s,function(a){o.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)}});var t=b.View=function(a){this.cid=c.uniqueId("view"),a||(a={}),c.extend(this,c.pick(a,v)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},u=/^(\S+)\s*(.*)$/,v=["model","collection","el","id","attributes","className","tagName","events"];c.extend(t.prototype,h,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(a,c){return this.$el&&this.undelegateEvents(),this.$el=a instanceof b.$?a:b.$(a),this.el=this.$el[0],c!==!1&&this.delegateEvents(),this},delegateEvents:function(a){if(!a&&!(a=c.result(this,"events")))return this;this.undelegateEvents();for(var b in a){var d=a[b];if(c.isFunction(d)||(d=this[a[b]]),d){var e=b.match(u),f=e[1],g=e[2];d=c.bind(d,this),f+=".delegateEvents"+this.cid,""===g?this.$el.on(f,d):this.$el.on(f,g,d)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(c.result(this,"el"),!1);else{var a=c.extend({},c.result(this,"attributes"));this.id&&(a.id=c.result(this,"id")),this.className&&(a["class"]=c.result(this,"className"));var d=b.$("<"+c.result(this,"tagName")+">").attr(a);this.setElement(d,!1)}}}),b.sync=function(a,d,e){var f=x[a];c.defaults(e||(e={}),{emulateHTTP:b.emulateHTTP,emulateJSON:b.emulateJSON});var g={type:f,dataType:"json"};if(e.url||(g.url=c.result(d,"url")||K()),null!=e.data||!d||"create"!==a&&"update"!==a&&"patch"!==a||(g.contentType="application/json",g.data=JSON.stringify(e.attrs||d.toJSON(e))),e.emulateJSON&&(g.contentType="application/x-www-form-urlencoded",g.data=g.data?{model:g.data}:{}),e.emulateHTTP&&("PUT"===f||"DELETE"===f||"PATCH"===f)){g.type="POST",e.emulateJSON&&(g.data._method=f);var h=e.beforeSend;e.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",f),h?h.apply(this,arguments):void 0}}"GET"===g.type||e.emulateJSON||(g.processData=!1),"PATCH"===g.type&&w&&(g.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var i=e.xhr=b.ajax(c.extend(g,e));return d.trigger("request",d,i,e),i};var w=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),x={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};b.ajax=function(){return b.$.ajax.apply(b.$,arguments)};var y=b.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},z=/\((.*?)\)/g,A=/(\(\?)?:\w+/g,B=/\*\w+/g,C=/[\-{}\[\]+?.,\\\^$|#\s]/g;c.extend(y.prototype,h,{initialize:function(){},route:function(a,d,e){c.isRegExp(a)||(a=this._routeToRegExp(a)),c.isFunction(d)&&(e=d,d=""),e||(e=this[d]);var f=this;return b.history.route(a,function(c){var g=f._extractParameters(a,c);f.execute(e,g),f.trigger.apply(f,["route:"+d].concat(g)),f.trigger("route",d,g),b.history.trigger("route",f,d,g)}),this},execute:function(a,b){a&&a.apply(this,b)},navigate:function(a,c){return b.history.navigate(a,c),this},_bindRoutes:function(){if(this.routes){this.routes=c.result(this,"routes");for(var a,b=c.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(C,"\\$&").replace(z,"(?:$1)?").replace(A,function(a,b){return b?a:"([^/?]+)"}).replace(B,"([^?]*?)"),new RegExp("^"+a+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(a,b){var d=a.exec(b).slice(1);return c.map(d,function(a,b){return b===d.length-1?a||null:a?decodeURIComponent(a):null})}});var D=b.History=function(){this.handlers=[],c.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},E=/^[#\/]|\s+$/g,F=/^\/+|\/+$/g,G=/msie [\w.]+/,H=/\/$/,I=/#.*$/;D.started=!1,c.extend(D.prototype,h,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=decodeURI(this.location.pathname+this.location.search);var c=this.root.replace(H,"");a.indexOf(c)||(a=a.slice(c.length))}else a=this.getHash();return a.replace(E,"")},start:function(a){if(D.started)throw new Error("Backbone.history has already been started");D.started=!0,this.options=c.extend({root:"/"},this.options,a),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var d=this.getFragment(),e=document.documentMode,f=G.exec(navigator.userAgent.toLowerCase())&&(!e||7>=e);if(this.root=("/"+this.root+"/").replace(F,"/"),f&&this._wantsHashChange){var g=b.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=g.hide().appendTo("body")[0].contentWindow,this.navigate(d)}this._hasPushState?b.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!f?b.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=d;var h=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&h.hash&&(this.fragment=this.getHash().replace(E,""),this.history.replaceState({},document.title,this.root+this.fragment))}return this.options.silent?void 0:this.loadUrl()},stop:function(){b.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),D.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){var b=this.getFragment();return b===this.fragment&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe))),b===this.fragment?!1:(this.iframe&&this.navigate(b),void this.loadUrl())},loadUrl:function(a){return a=this.fragment=this.getFragment(a),c.any(this.handlers,function(b){return b.route.test(a)?(b.callback(a),!0):void 0})},navigate:function(a,b){if(!D.started)return!1;b&&b!==!0||(b={trigger:!!b});var c=this.root+(a=this.getFragment(a||""));if(a=a.replace(I,""),this.fragment!==a){if(this.fragment=a,""===a&&"/"!==c&&(c=c.slice(0,-1)),this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}return b.trigger?this.loadUrl(a):void 0}},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b}}),b.history=new D;var J=function(a,b){var d,e=this;d=a&&c.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},c.extend(d,e,b);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&c.extend(d.prototype,a),d.__super__=e.prototype,d};m.extend=o.extend=y.extend=t.extend=D.extend=J;var K=function(){throw new Error('A "url" property or function must be specified')},L=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}};return b}),window.$pureChatJquery&&(Backbone.$=window.$pureChatJquery),function(a,b){b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";b.Relational={showWarnings:!0},b.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(a){if(this._permitsUsed>a)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=a}},b.BlockingQueue=function(){this._queue=[]},c.extend(b.BlockingQueue.prototype,b.Semaphore,{_queue:null,add:function(a){this.isBlocked()?this._queue.push(a):a()},process:function(){var a=this._queue;for(this._queue=[];a&&a.length;)a.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),b.Relational.eventQueue=new b.BlockingQueue,b.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[a]},c.extend(b.Store.prototype,b.Events,{initializeRelation:function(a,d,e){var f=c.isString(d.type)?b[d.type]||this.getObjectByName(d.type):d.type;if(f&&f.prototype instanceof b.Relation){new f(a,d,e)}else b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",d)},addModelScope:function(a){this._modelScopes.push(a)},removeModelScope:function(a){this._modelScopes=c.without(this._modelScopes,a)},addSubModels:function(a,b){this._subModels.push({superModelType:b,subModels:a})},setupSuperModel:function(a){c.find(this._subModels,function(b){return c.filter(b.subModels||[],function(c,d){var e=this.getObjectByName(c);return a===e?(b.superModelType._subModels[d]=a,a._superModel=b.superModelType,a._subModelTypeValue=d,a._subModelTypeAttribute=b.superModelType.prototype.subModelTypeAttribute,!0):void 0},this).length},this)},addReverseRelation:function(a){var b=c.any(this._reverseRelations,function(b){return c.all(a||[],function(a,c){return a===b[c]})});!b&&a.model&&a.type&&(this._reverseRelations.push(a),this._addRelation(a.model,a),this.retroFitRelation(a))},addOrphanRelation:function(a){var b=c.any(this._orphanRelations,function(b){return c.all(a||[],function(a,c){return a===b[c]})});!b&&a.model&&a.type&&this._orphanRelations.push(a)},processOrphanRelations:function(){c.each(this._orphanRelations.slice(0),function(a){var d=b.Relational.store.getObjectByName(a.relatedModel);d&&(this.initializeRelation(null,a),this._orphanRelations=c.without(this._orphanRelations,a))},this)},_addRelation:function(a,b){a.prototype.relations||(a.prototype.relations=[]),a.prototype.relations.push(b),c.each(a._subModels||[],function(a){this._addRelation(a,b)},this)},retroFitRelation:function(a){var b=this.getCollection(a.model,!1);b&&b.each(function(b){if(b instanceof a.model){new a.type(b,a)}},this)},getCollection:function(a,d){a instanceof b.RelationalModel&&(a=a.constructor);for(var e=a;e._superModel;)e=e._superModel;var f=c.find(this._collections,function(a){return a.model===e});return f||d===!1||(f=this._createCollection(e)),f},getObjectByName:function(a){var b=a.split("."),d=null;return c.find(this._modelScopes,function(a){return d=c.reduce(b||[],function(a,b){return a?a[b]:void 0},a),d&&d!==a?!0:void 0},this),d},_createCollection:function(a){var c;return a instanceof b.RelationalModel&&(a=a.constructor),a.prototype instanceof b.RelationalModel&&(c=new b.Collection,c.model=a,this._collections.push(c)),c},resolveIdForItem:function(a,d){var e=c.isString(d)||c.isNumber(d)?d:null;return null===e&&(d instanceof b.RelationalModel?e=d.id:c.isObject(d)&&(e=d[a.prototype.idAttribute])),e||0===e||(e=null),e},find:function(a,b){var c=this.resolveIdForItem(a,b),d=this.getCollection(a);if(d){var e=d.get(c);if(e instanceof a)return e}return null},register:function(a){var b=this.getCollection(a);if(b){var c=a.collection;b.add(a),a.collection=c}},checkId:function(a,c){var d=this.getCollection(a),e=d&&d.get(c);if(e&&a!==e)throw b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",e,a),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(a){var b=this.getCollection(a);b.contains(a)||this.register(a),b._onModelEvent("change:"+a.idAttribute,a,b),a.trigger("relational:change:id",a,b)},unregister:function(a){var d,e;a instanceof b.Model?(d=this.getCollection(a),e=[a]):a instanceof b.Collection?(d=this.getCollection(a.model),e=c.clone(a.models)):(d=this.getCollection(a),e=c.clone(d.models)),c.each(e,function(a){this.stopListening(a),c.invoke(a.getRelations(),"stopListening")},this),c.contains(this._collections,a)?d.reset([]):c.each(e,function(a){d.get(a)?d.remove(a):d.trigger("relational:remove",a,d)},this)},reset:function(){this.stopListening(),c.each(this._collections,function(a){this.unregister(a)},this),this._collections=[],this._subModels=[],this._modelScopes=[a]}}),b.Relational.store=new b.Store,b.Relation=function(a,d,e){if(this.instance=a,d=c.isObject(d)?d:{},this.reverseRelation=c.defaults(d.reverseRelation||{},this.options.reverseRelation),this.options=c.defaults(d,this.options,b.Relation.prototype.options),this.reverseRelation.type=c.isString(this.reverseRelation.type)?b[this.reverseRelation.type]||b.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,c.isUndefined(this.relatedModel)&&(this.relatedModel=this.model),!c.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof b.RelationalModel||(this.relatedModel=c.result(this,"relatedModel")),c.isString(this.relatedModel)&&(this.relatedModel=b.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&b.Relational.store.addReverseRelation(c.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),a)){var f=this.keySource;f!==this.key&&c.isObject(this.instance.get(this.key))&&(f=this.key),this.setKeyContents(this.instance.get(f)),this.relatedCollection=b.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(e),this.options.autoFetch&&this.instance.getAsync(this.key,c.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},b.Relation.extend=b.Model.extend,c.extend(b.Relation.prototype,b.Events,b.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var a=this.instance,d=this.key,e=this.model,f=this.relatedModel,g=b.Relational.showWarnings&&"undefined"!=typeof console;if(!e||!d||!f)return g&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,e,d,f),!1;if(!(e.prototype instanceof b.RelationalModel))return g&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,a),!1;if(!(f.prototype instanceof b.RelationalModel))return g&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,f),!1;if(this instanceof b.HasMany&&this.reverseRelation.type===b.HasMany)return g&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(a&&c.keys(a._relations).length){var h=c.find(a._relations,function(a){return a.key===d},this);if(h)return g&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,d,a,h),!1}return!0},setRelated:function(a){this.related=a,this.instance.attributes[this.key]=a},_isReverseRelation:function(a){return a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key},getReverseRelations:function(a){for(var b=[],d=c.isUndefined(a)?this.related&&(this.related.models||[this.related]):[a],e=null,f=null,g=0;g<(d||[]).length;g++){e=d[g].getRelations()||[];for(var h=0;h<e.length;h++)f=e[h],this._isReverseRelation(f)&&b.push(f)}return b},destroy:function(){this.stopListening(),this instanceof b.HasOne?this.setRelated(null):this instanceof b.HasMany&&this.setRelated(this._prepareCollection()),c.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance)},this)}}),b.HasOne=b.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(a){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var b=this.findRelated(a);this.setRelated(b),c.each(this.getReverseRelations(),function(b){b.addRelated(this.instance,a)},this)},findRelated:function(a){var b=null;if(a=c.defaults({parse:this.options.parse},a),this.keyContents instanceof this.relatedModel)b=this.keyContents;else if(this.keyContents||0===this.keyContents){var d=c.defaults({create:this.options.createModels},a);b=this.relatedModel.findOrCreate(this.keyContents,d)}return b&&(this.keyId=null),b},setKeyContents:function(a){this.keyContents=a,this.keyId=b.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(a,d,e){if(!this.isLocked()){this.acquire(),e=e?c.clone(e):{};var f=c.isUndefined(e.__related),g=f?this.related:e.__related;if(f){this.setKeyContents(d);var h=this.findRelated(e);this.setRelated(h)}if(g&&this.related!==g&&c.each(this.getReverseRelations(g),function(a){a.removeRelated(this.instance,null,e)},this),c.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this),!e.silent&&this.related!==g){var i=this;this.changed=!0,b.Relational.eventQueue.add(function(){i.instance.trigger("change:"+i.key,i.instance,i.related,e,!0),i.changed=!1})}this.release()}},tryAddRelated:function(a,b,c){!this.keyId&&0!==this.keyId||a.id!==this.keyId||(this.addRelated(a,c),this.keyId=null)},addRelated:function(a,b){var d=this;a.queue(function(){if(a!==d.related){var e=d.related||null;d.setRelated(a),d.onChange(d.instance,a,c.defaults({__related:e},b))}})},removeRelated:function(a,b,d){if(this.related&&a===this.related){var e=this.related||null;this.setRelated(null),this.onChange(this.instance,a,c.defaults({__related:e},d))}}}),b.HasMany=b.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:b.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(a){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,!c.isFunction(this.collectionType)||this.collectionType===b.Collection||this.collectionType.prototype instanceof b.Collection||(this.collectionType=c.result(this,"collectionType")),c.isString(this.collectionType)&&(this.collectionType=b.Relational.store.getObjectByName(this.collectionType)),this.collectionType!==b.Collection&&!(this.collectionType.prototype instanceof b.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var d=this.findRelated(a);this.setRelated(d)},_prepareCollection:function(a){if(this.related&&this.stopListening(this.related),!(a&&a instanceof b.Collection)){var d=c.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;a=new this.collectionType(null,d)}if(a.model=this.relatedModel,this.options.collectionKey){var e=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;a[e]&&a[e]!==this.instance?b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,e,this.options.collectionKey):e&&(a[e]=this.instance)}return this.listenTo(a,"relational:add",this.handleAddition).listenTo(a,"relational:remove",this.handleRemoval).listenTo(a,"relational:reset",this.handleReset),a},findRelated:function(a){var d=null;if(a=c.defaults({parse:this.options.parse},a),this.keyContents instanceof b.Collection)this._prepareCollection(this.keyContents),d=this.keyContents;else{var e=[];c.each(this.keyContents,function(b){var d=null;d=b instanceof this.relatedModel?b:this.relatedModel.findOrCreate(b,c.extend({merge:!0},a,{create:this.options.createModels})),d&&e.push(d)},this),d=this.related instanceof b.Collection?this.related:this._prepareCollection(),d.set(e,c.defaults({merge:!1,parse:!1},a))}return this.keyIds=c.difference(this.keyIds,c.pluck(d.models,"id")),d},setKeyContents:function(a){this.keyContents=a instanceof b.Collection?a:null,this.keyIds=[],this.keyContents||!a&&0!==a||(this.keyContents=c.isArray(a)?a:[a],c.each(this.keyContents,function(a){var c=b.Relational.store.resolveIdForItem(this.relatedModel,a);(c||0===c)&&this.keyIds.push(c)},this))},onChange:function(a,d,e){e=e?c.clone(e):{},this.setKeyContents(d),this.changed=!1;var f=this.findRelated(e);if(this.setRelated(f),!e.silent){var g=this;b.Relational.eventQueue.add(function(){g.changed&&(g.instance.trigger("change:"+g.key,g.instance,g.related,e,!0),g.changed=!1)})}},handleAddition:function(a,d,e){e=e?c.clone(e):{},this.changed=!0,c.each(this.getReverseRelations(a),function(a){a.addRelated(this.instance,e)},this);var f=this;!e.silent&&b.Relational.eventQueue.add(function(){f.instance.trigger("add:"+f.key,a,f.related,e)})},handleRemoval:function(a,d,e){e=e?c.clone(e):{},this.changed=!0,c.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,null,e)},this);var f=this;!e.silent&&b.Relational.eventQueue.add(function(){f.instance.trigger("remove:"+f.key,a,f.related,e)})},handleReset:function(a,d){var e=this;d=d?c.clone(d):{},!d.silent&&b.Relational.eventQueue.add(function(){e.instance.trigger("reset:"+e.key,e.related,d)})},tryAddRelated:function(a,b,d){var e=c.contains(this.keyIds,a.id);e&&(this.addRelated(a,d),this.keyIds=c.without(this.keyIds,a.id))},addRelated:function(a,b){var d=this;a.queue(function(){d.related&&!d.related.get(a)&&d.related.add(a,c.defaults({parse:!1},b))})},removeRelated:function(a,b,c){this.related.get(a)&&this.related.remove(a,c)}}),b.RelationalModel=b.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(a,d){if(d&&d.collection){var e=this,f=this.collection=d.collection;delete d.collection,this._deferProcessing=!0;var g=function(a){a===e&&(e._deferProcessing=!1,e.processQueue(),f.off("relational:add",g))};f.on("relational:add",g),c.defer(function(){g(e)})}b.Relational.store.processOrphanRelations(),b.Relational.store.listenTo(this,"relational:unregister",b.Relational.store.unregister),this._queue=new b.BlockingQueue,this._queue.block(),b.Relational.eventQueue.block();try{b.Model.apply(this,arguments)}finally{b.Relational.eventQueue.unblock()}},trigger:function(a){if(a.length>5&&0===a.indexOf("change")){var c=this,d=arguments;b.Relational.eventQueue.isLocked()?b.Relational.eventQueue.add(function(){var e=!0;if("change"===a)e=c.hasChanged()||c._attributeChangeFired,c._attributeChangeFired=!1;else{var f=a.slice(7),g=c.getRelation(f);g?(e=d[4]===!0,e?c.changed[f]=d[2]:g.changed||delete c.changed[f]):e&&(c._attributeChangeFired=!0)}e&&b.Model.prototype.trigger.apply(c,d)}):b.Model.prototype.trigger.apply(c,d)}else"destroy"===a?(b.Model.prototype.trigger.apply(this,arguments),b.Relational.store.unregister(this)):b.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(a){this.acquire(),this._relations={},c.each(this.relations||[],function(c){b.Relational.store.initializeRelation(this,c,a)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(a,b){this._isInitialized&&!this.isLocked()&&c.each(this._relations,function(c){if(!a||c.keySource in a||c.key in a){var d=this.attributes[c.keySource]||this.attributes[c.key],e=a&&(a[c.keySource]||a[c.key]);
(c.related!==d||null===d&&null===e)&&this.trigger("relational:change:"+c.key,this,d,b||{})}c.keySource!==c.key&&delete this.attributes[c.keySource]},this)},queue:function(a){this._queue.add(a)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(a){return this._relations[a]},getRelations:function(){return c.values(this._relations)},getIdsToFetch:function(a,d){var e=a instanceof b.Relation?a:this.getRelation(a),f=e?e.keyIds&&e.keyIds.slice(0)||(e.keyId||0===e.keyId?[e.keyId]:[]):[];if(d){var g=e.related&&(e.related.models||[e.related]);c.each(g,function(a){(a.id||0===a.id)&&f.push(a.id)})}return f},getAsync:function(a,d){d=c.extend({add:!0,remove:!1,refresh:!1},d);var e=this,f=[],g=this.getRelation(a),h=g&&this.getIdsToFetch(g,d.refresh),i=g.related instanceof b.Collection?g.related:g.relatedCollection;if(h&&h.length){var k,l=[],m=[],n=function(){l=c.map(h,function(a){var b=g.relatedModel.findModel(a);if(!b){var c={};c[g.relatedModel.prototype.idAttribute]=a,b=g.relatedModel.findOrCreate(c,d),m.push(b)}return b},this)};if(i instanceof b.Collection&&c.isFunction(i.url)){var o=i.url();k=i.url(h),k===o&&(n(),k=i.url(l),k===o&&(k=null))}if(k){var p=c.defaults({error:function(){c.each(m,function(a){a.trigger("destroy",a,a.collection,d)}),d.error&&d.error.apply(l,arguments)},url:k},d);f=[i.fetch(p)]}else l.length||n(),f=c.map(l,function(a){var b=c.defaults({error:function(){c.contains(m,a)&&a.trigger("destroy",a,a.collection,d),d.error&&d.error.apply(l,arguments)}},d);return a.fetch(b)},this)}return j.when.apply(null,f).then(function(){return b.Model.prototype.get.call(e,a)})},set:function(a,d,e){b.Relational.eventQueue.block();var f,g;c.isObject(a)||null==a?(f=a,e=d):(f={},f[a]=d);try{var h=this.id,i=f&&this.idAttribute in f&&f[this.idAttribute];b.Relational.store.checkId(this,i),g=b.Model.prototype.set.apply(this,arguments),this._isInitialized||this.isLocked()?i&&i!==h&&b.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),(i||0===i)&&b.Relational.store.register(this),this.initializeRelations(e)),f&&this.updateRelations(f,e)}finally{b.Relational.eventQueue.unblock()}return g},clone:function(){var a=c.clone(this.attributes);return c.isUndefined(a[this.idAttribute])||(a[this.idAttribute]=null),c.each(this.getRelations(),function(b){delete a[b.key]}),new this.constructor(a)},toJSON:function(a){if(this.isLocked())return this.id;this.acquire();var d=b.Model.prototype.toJSON.call(this,a);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in d||(d[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),c.each(this._relations,function(e){var f=d[e.key],g=e.options.includeInJSON,h=null;g===!0?f&&c.isFunction(f.toJSON)&&(h=f.toJSON(a)):c.isString(g)?(f instanceof b.Collection?h=f.pluck(g):f instanceof b.Model&&(h=f.get(g)),g===e.relatedModel.prototype.idAttribute&&(e instanceof b.HasMany?h=h.concat(e.keyIds):e instanceof b.HasOne&&(h=h||e.keyId,h||c.isObject(e.keyContents)||(h=e.keyContents||null)))):c.isArray(g)?f instanceof b.Collection?(h=[],f.each(function(a){var b={};c.each(g,function(c){b[c]=a.get(c)}),h.push(b)})):f instanceof b.Model&&(h={},c.each(g,function(a){h[a]=f.get(a)})):delete d[e.key],null===h&&a&&a.wait&&(h=f),g&&(d[e.keyDestination]=h),e.keyDestination!==e.key&&delete d[e.key]}),this.release(),d}},{setup:function(a){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?b.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,c.each(this.prototype.relations||[],function(a){if(a.model||(a.model=this),a.reverseRelation&&a.model===this){var d=!0;if(c.isString(a.relatedModel)){var e=b.Relational.store.getObjectByName(a.relatedModel);d=e&&e.prototype instanceof b.RelationalModel}d?b.Relational.store.initializeRelation(null,a):c.isString(a.relatedModel)&&b.Relational.store.addOrphanRelation(a)}},this),this},build:function(a,b){this.initializeModelHierarchy();var c=this._findSubModelType(this,a)||this;return new c(a,b)},_findSubModelType:function(a,b){if(a._subModels&&a.prototype.subModelTypeAttribute in b){var c=b[a.prototype.subModelTypeAttribute],d=a._subModels[c];if(d)return d;for(c in a._subModels)if(d=this._findSubModelType(a._subModels[c],b))return d}return null},initializeModelHierarchy:function(){if(this.inheritRelations(),this.prototype.subModelTypes){var a=c.keys(this._subModels),d=c.omit(this.prototype.subModelTypes,a);c.each(d,function(a){var c=b.Relational.store.getObjectByName(a);c&&c.initializeModelHierarchy()})}},inheritRelations:function(){if(c.isUndefined(this._superModel)||c.isNull(this._superModel))if(b.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var a=c.filter(this._superModel.prototype.relations||[],function(a){return!c.any(this.prototype.relations||[],function(b){return a.relatedModel===b.relatedModel&&a.key===b.key},this)},this);this.prototype.relations=a.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(a,b){b||(b={});var d=c.isObject(a)&&b.parse&&this.prototype.parse?this.prototype.parse(c.clone(a)):a,e=this.findModel(d);return c.isObject(a)&&(e&&b.merge!==!1?(delete b.collection,delete b.url,e.set(d,b)):e||b.create===!1||(e=this.build(d,c.defaults({parse:!1},b)))),e},find:function(a,b){return b||(b={}),b.create=!1,this.findOrCreate(a,b)},findModel:function(a){return b.Relational.store.find(this,a)}}),c.extend(b.RelationalModel.prototype,b.Semaphore),b.Collection.prototype.__prepareModel=b.Collection.prototype._prepareModel,b.Collection.prototype._prepareModel=function(a,d){var e;return a instanceof b.Model?(a.collection||(a.collection=this),e=a):(d=d?c.clone(d):{},d.collection=this,e="undefined"!=typeof this.model.findOrCreate?this.model.findOrCreate(a,d):new this.model(a,d),e&&e.validationError&&(this.trigger("invalid",this,a,d),e=!1)),e};var d=b.Collection.prototype.__set=b.Collection.prototype.set;b.Collection.prototype.set=function(a,e){if(!(this.model.prototype instanceof b.RelationalModel))return d.call(this,a,e);e&&e.parse&&(a=this.parse(a,e));var f=!c.isArray(a),g=[],h=[],i=null;a=f?a?[a]:[]:c.clone(a);for(var j=0;j<a.length;j++)i=a[j],i instanceof b.Model||(i=b.Collection.prototype._prepareModel.call(this,i,e)),i&&(h.push(i),this.get(i)||this.get(i.cid)?null!==i.id&&void 0!==i.id&&(this._byId[i.id]=i):g.push(i));h=f?h.length?h[0]:null:h;var k=d.call(this,h,c.defaults({merge:!1,parse:!1},e));for(j=0;j<g.length;j++)i=g[j],(this.get(i)||this.get(i.cid))&&this.trigger("relational:add",i,this,e);return k};var e=b.Collection.prototype.__remove=b.Collection.prototype.remove;b.Collection.prototype.remove=function(a,d){if(!(this.model.prototype instanceof b.RelationalModel))return e.call(this,a,d);var f=!c.isArray(a),g=[];a=f?a?[a]:[]:c.clone(a),d||(d={}),c.each(a,function(a){a=this.get(a)||a&&this.get(a.cid),a&&g.push(a)},this);var h=e.call(this,f?g.length?g[0]:null:g,d);return c.each(g,function(a){this.trigger("relational:remove",a,this,d)},this),h};var f=b.Collection.prototype.__reset=b.Collection.prototype.reset;b.Collection.prototype.reset=function(a,d){d=c.extend({merge:!0},d);var e=f.call(this,a,d);return this.model.prototype instanceof b.RelationalModel&&this.trigger("relational:reset",this,d),e};var g=b.Collection.prototype.__sort=b.Collection.prototype.sort;b.Collection.prototype.sort=function(a){var c=g.call(this,a);return this.model.prototype instanceof b.RelationalModel&&this.trigger("relational:reset",this,a),c};var h=b.Collection.prototype.__trigger=b.Collection.prototype.trigger;b.Collection.prototype.trigger=function(a){if(!(this.model.prototype instanceof b.RelationalModel))return h.apply(this,arguments);if("add"===a||"remove"===a||"reset"===a||"sort"===a){var d=this,e=arguments;c.isObject(e[3])&&(e=c.toArray(e),e[3]=c.clone(e[3])),b.Relational.eventQueue.add(function(){h.apply(d,e)})}else h.apply(this,arguments);return this},b.RelationalModel.extend=function(a,c){var d=b.Model.extend.call(this,a,c);return d.setup(this),d}}),function(a,b){a.Marionette=a.Mn=b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";!function(a,b){var c=a.ChildViewContainer;return a.ChildViewContainer=function(a,b){var c=function(a){this._views={},this._indexByModel={},this._indexByCustom={},this._updateLength(),b.each(a,this.add,this)};b.extend(c.prototype,{add:function(a,b){var c=a.cid;return this._views[c]=a,a.model&&(this._indexByModel[a.model.cid]=c),b&&(this._indexByCustom[b]=c),this._updateLength(),this},findByModel:function(a){return this.findByModelCid(a.cid)},findByModelCid:function(a){var b=this._indexByModel[a];return this.findByCid(b)},findByCustom:function(a){var b=this._indexByCustom[a];return this.findByCid(b)},findByIndex:function(a){return b.values(this._views)[a]},findByCid:function(a){return this._views[a]},remove:function(a){var c=a.cid;return a.model&&delete this._indexByModel[a.model.cid],b.any(this._indexByCustom,function(a,b){return a===c?(delete this._indexByCustom[b],!0):void 0},this),delete this._views[c],this._updateLength(),this},call:function(a){this.apply(a,b.tail(arguments))},apply:function(a,c){b.each(this._views,function(d){b.isFunction(d[a])&&d[a].apply(d,c||[])})},_updateLength:function(){this.length=b.size(this._views)}});var d=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck","reduce"];return b.each(d,function(a){c.prototype[a]=function(){var c=b.values(this._views),d=[c].concat(b.toArray(arguments));return b[a].apply(b,d)}}),c}(a,b),a.ChildViewContainer.VERSION="0.1.6",a.ChildViewContainer.noConflict=function(){return a.ChildViewContainer=c,this},a.ChildViewContainer}(b,c),function(a,b){var c=a.Wreqr,d=a.Wreqr={};return a.Wreqr.VERSION="1.3.1",a.Wreqr.noConflict=function(){return a.Wreqr=c,this},d.Handlers=function(a,b){var c=function(a){this.options=a,this._wreqrHandlers={},b.isFunction(this.initialize)&&this.initialize(a)};return c.extend=a.Model.extend,b.extend(c.prototype,a.Events,{setHandlers:function(a){b.each(a,function(a,c){var d=null;b.isObject(a)&&!b.isFunction(a)&&(d=a.context,a=a.callback),this.setHandler(c,a,d)},this)},setHandler:function(a,b,c){var d={callback:b,context:c};this._wreqrHandlers[a]=d,this.trigger("handler:add",a,b,c)},hasHandler:function(a){return!!this._wreqrHandlers[a]},getHandler:function(a){var b=this._wreqrHandlers[a];if(b)return function(){var a=Array.prototype.slice.apply(arguments);return b.callback.apply(b.context,a)}},removeHandler:function(a){delete this._wreqrHandlers[a]},removeAllHandlers:function(){this._wreqrHandlers={}}}),c}(a,b),d.CommandStorage=function(){var c=function(a){this.options=a,this._commands={},b.isFunction(this.initialize)&&this.initialize(a)};return b.extend(c.prototype,a.Events,{getCommands:function(a){var b=this._commands[a];return b||(b={command:a,instances:[]},this._commands[a]=b),b},addCommand:function(a,b){var c=this.getCommands(a);c.instances.push(b)},clearCommands:function(a){var b=this.getCommands(a);b.instances=[]}}),c}(),d.Commands=function(a){return a.Handlers.extend({storageType:a.CommandStorage,constructor:function(b){this.options=b||{},this._initializeStorage(this.options),this.on("handler:add",this._executeCommands,this);var c=Array.prototype.slice.call(arguments);a.Handlers.prototype.constructor.apply(this,c)},execute:function(a,b){a=arguments[0],b=Array.prototype.slice.call(arguments,1),this.hasHandler(a)?this.getHandler(a).apply(this,b):this.storage.addCommand(a,b)},_executeCommands:function(a,c,d){var e=this.storage.getCommands(a);b.each(e.instances,function(a){c.apply(d,a)}),this.storage.clearCommands(a)},_initializeStorage:function(a){var c,d=a.storageType||this.storageType;c=b.isFunction(d)?new d:d,this.storage=c}})}(d),d.RequestResponse=function(a){return a.Handlers.extend({request:function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);return this.hasHandler(a)?this.getHandler(a).apply(this,b):void 0}})}(d),d.EventAggregator=function(a,b){var c=function(){};return c.extend=a.Model.extend,b.extend(c.prototype,a.Events),c}(a,b),d.Channel=function(c){var d=function(b){this.vent=new a.Wreqr.EventAggregator,this.reqres=new a.Wreqr.RequestResponse,this.commands=new a.Wreqr.Commands,this.channelName=b};return b.extend(d.prototype,{reset:function(){return this.vent.off(),this.vent.stopListening(),this.reqres.removeAllHandlers(),this.commands.removeAllHandlers(),this},connectEvents:function(a,b){return this._connect("vent",a,b),this},connectCommands:function(a,b){return this._connect("commands",a,b),this},connectRequests:function(a,b){return this._connect("reqres",a,b),this},_connect:function(a,c,d){if(c){d=d||this;var e="vent"===a?"on":"setHandler";b.each(c,function(c,f){this[a][e](f,b.bind(c,d))},this)}}}),d}(d),d.radio=function(a){var c=function(){this._channels={},this.vent={},this.commands={},this.reqres={},this._proxyMethods()};b.extend(c.prototype,{channel:function(a){if(!a)throw new Error("Channel must receive a name");return this._getChannel(a)},_getChannel:function(b){var c=this._channels[b];return c||(c=new a.Channel(b),this._channels[b]=c),c},_proxyMethods:function(){b.each(["vent","commands","reqres"],function(a){b.each(d[a],function(b){this[a][b]=e(this,a,b)},this)},this)}});var d={vent:["on","off","trigger","once","stopListening","listenTo","listenToOnce"],commands:["execute","setHandler","setHandlers","removeHandler","removeAllHandlers"],reqres:["request","setHandler","setHandlers","removeHandler","removeAllHandlers"]},e=function(a,b,c){return function(d){var e=a._getChannel(d)[b],f=Array.prototype.slice.call(arguments,1);return e[c].apply(e,f)}};return new c}(d),a.Wreqr}(b,c);var d=a.Marionette,e=a.Mn,f=b.Marionette={};f.VERSION="2.4.1",f.noConflict=function(){return a.Marionette=d,a.Mn=e,this},b.Marionette=f,f.Deferred=b.$.Deferred,f.extend=b.Model.extend,f.isNodeAttached=function(a){return b.$.contains(document.documentElement,a)},f.mergeOptions=function(a,b){a&&c.extend(this,c.pick(a,b))},f.getOption=function(a,b){return a&&b?a.options&&void 0!==a.options[b]?a.options[b]:a[b]:void 0},f.proxyGetOption=function(a){return f.getOption(this,a)},f._getValue=function(a,b,d){return c.isFunction(a)&&(a=d?a.apply(b,d):a.call(b)),a},f.normalizeMethods=function(a){return c.reduce(a,function(a,b,d){return c.isFunction(b)||(b=this[b]),b&&(a[d]=b),a},{},this)},f.normalizeUIString=function(a,b){return a.replace(/@ui\.[a-zA-Z_$0-9]*/g,function(a){return b[a.slice(4)]})},f.normalizeUIKeys=function(a,b){return c.reduce(a,function(a,c,d){var e=f.normalizeUIString(d,b);return a[e]=c,a},{})},f.normalizeUIValues=function(a,b,d){return c.each(a,function(e,g){c.isString(e)?a[g]=f.normalizeUIString(e,b):c.isObject(e)&&c.isArray(d)&&(c.extend(e,f.normalizeUIValues(c.pick(e,d),b)),c.each(d,function(a){var d=e[a];c.isString(d)&&(e[a]=f.normalizeUIString(d,b))}))}),a},f.actAsCollection=function(a,b){var d=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"];c.each(d,function(d){a[d]=function(){var a=c.values(c.result(this,b)),e=[a].concat(c.toArray(arguments));return c[d].apply(c,e)}})};var g=f.deprecate=function(a,b){c.isObject(a)&&(a=a.prev+" is going to be removed in the future. Please use "+a.next+" instead."+(a.url?" See: "+a.url:"")),void 0!==b&&b||g._cache[a]||(g._warn("Deprecation warning: "+a),g._cache[a]=!0)};g._warn="undefined"!=typeof console&&(console.warn||console.log)||function(){},g._cache={},f._triggerMethod=function(){function a(a,b,c){return c.toUpperCase()}var b=/(^|:)(\w)/gi;return function(d,e,f){var g=arguments.length<3;g&&(f=e,e=f[0]);var h,i="on"+e.replace(b,a),j=d[i];return c.isFunction(j)&&(h=j.apply(d,g?c.rest(f):f)),c.isFunction(d.trigger)&&(g+f.length>1?d.trigger.apply(d,g?f:[e].concat(c.drop(f,0))):d.trigger(e)),h}}(),f.triggerMethod=function(a){return f._triggerMethod(this,arguments)},f.triggerMethodOn=function(a){var b=c.isFunction(a.triggerMethod)?a.triggerMethod:f.triggerMethod;return b.apply(a,c.rest(arguments))},f.MonitorDOMRefresh=function(a){function b(){a._isShown=!0,e()}function d(){a._isRendered=!0,e()}function e(){a._isShown&&a._isRendered&&f.isNodeAttached(a.el)&&c.isFunction(a.triggerMethod)&&a.triggerMethod("dom:refresh")}a.on({show:b,render:d})},function(a){function b(b,d,e,f){var g=f.split(/\s+/);c.each(g,function(c){var f=b[c];if(!f)throw new a.Error('Method "'+c+'" was configured as an event handler, but does not exist.');b.listenTo(d,e,f)})}function d(a,b,c,d){a.listenTo(b,c,d)}function e(a,b,d,e){var f=e.split(/\s+/);c.each(f,function(c){var e=a[c];a.stopListening(b,d,e)})}function f(a,b,c,d){a.stopListening(b,c,d)}function g(b,d,e,f,g){if(d&&e){if(!c.isObject(e))throw new a.Error({message:"Bindings must be an object or function.",url:"marionette.functions.html#marionettebindentityevents"});e=a._getValue(e,b),c.each(e,function(a,e){c.isFunction(a)?f(b,d,e,a):g(b,d,e,a)})}}a.bindEntityEvents=function(a,c,e){g(a,c,e,d,b)},a.unbindEntityEvents=function(a,b,c){g(a,b,c,f,e)},a.proxyBindEntityEvents=function(b,c){return a.bindEntityEvents(this,b,c)},a.proxyUnbindEntityEvents=function(b,c){return a.unbindEntityEvents(this,b,c)}}(f);var h=["description","fileName","lineNumber","name","message","number"];return f.Error=f.extend.call(Error,{urlRoot:"http://marionettejs.com/docs/v"+f.VERSION+"/",constructor:function(a,b){c.isObject(a)?(b=a,a=b.message):b||(b={});var d=Error.call(this,a);c.extend(this,c.pick(d,h),c.pick(b,h)),this.captureStackTrace(),b.url&&(this.url=this.urlRoot+b.url)},captureStackTrace:function(){Error.captureStackTrace&&Error.captureStackTrace(this,f.Error)},toString:function(){return this.name+": "+this.message+(this.url?" See: "+this.url:"")}}),f.Error.extend=f.extend,f.Callbacks=function(){this._deferred=f.Deferred(),this._callbacks=[]},c.extend(f.Callbacks.prototype,{add:function(a,b){var d=c.result(this._deferred,"promise");this._callbacks.push({cb:a,ctx:b}),d.then(function(c){b&&(c.context=b),a.call(c.context,c.options)})},run:function(a,b){this._deferred.resolve({options:a,context:b})},reset:function(){var a=this._callbacks;this._deferred=f.Deferred(),this._callbacks=[],c.each(a,function(a){this.add(a.cb,a.ctx)},this)}}),f.Controller=function(a){this.options=a||{},c.isFunction(this.initialize)&&this.initialize(this.options)},f.Controller.extend=f.extend,c.extend(f.Controller.prototype,b.Events,{destroy:function(){return f._triggerMethod(this,"before:destroy",arguments),f._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this},triggerMethod:f.triggerMethod,mergeOptions:f.mergeOptions,getOption:f.proxyGetOption}),f.Object=function(a){this.options=c.extend({},c.result(this,"options"),a),this.initialize.apply(this,arguments)},f.Object.extend=f.extend,c.extend(f.Object.prototype,b.Events,{initialize:function(){},destroy:function(){return this.triggerMethod("before:destroy"),this.triggerMethod("destroy"),this.stopListening(),this},triggerMethod:f.triggerMethod,mergeOptions:f.mergeOptions,getOption:f.proxyGetOption,bindEntityEvents:f.proxyBindEntityEvents,unbindEntityEvents:f.proxyUnbindEntityEvents}),f.Region=f.Object.extend({constructor:function(a){if(this.options=a||{},this.el=this.getOption("el"),this.el=this.el instanceof b.$?this.el[0]:this.el,!this.el)throw new f.Error({name:"NoElError",message:'An "el" must be specified for a region.'});this.$el=this.getEl(this.el),f.Object.call(this,a)},show:function(a,b){if(this._ensureElement()){this._ensureViewIsIntact(a);var c=b||{},d=a!==this.currentView,e=!!c.preventDestroy,g=!!c.forceShow,h=!!this.currentView,i=d&&!e,j=d||g;if(h&&this.triggerMethod("before:swapOut",this.currentView,this,b),this.currentView&&delete this.currentView._parent,i?this.empty():h&&j&&this.currentView.off("destroy",this.empty,this),j){a.once("destroy",this.empty,this),a.render(),a._parent=this,h&&this.triggerMethod("before:swap",a,this,b),this.triggerMethod("before:show",a,this,b),f.triggerMethodOn(a,"before:show",a,this,b),h&&this.triggerMethod("swapOut",this.currentView,this,b);var k=f.isNodeAttached(this.el),l=[],m=c.triggerBeforeAttach||this.triggerBeforeAttach,n=c.triggerAttach||this.triggerAttach;return k&&m&&(l=this._displayedViews(a),this._triggerAttach(l,"before:")),this.attachHtml(a),this.currentView=a,k&&n&&(l=this._displayedViews(a),this._triggerAttach(l)),h&&this.triggerMethod("swap",a,this,b),this.triggerMethod("show",a,this,b),f.triggerMethodOn(a,"show",a,this,b),this}return this}},triggerBeforeAttach:!0,triggerAttach:!0,_triggerAttach:function(a,b){var d=(b||"")+"attach";c.each(a,function(a){f.triggerMethodOn(a,d,a,this)},this)},_displayedViews:function(a){return c.union([a],c.result(a,"_getNestedViews")||[])},_ensureElement:function(){if(c.isObject(this.el)||(this.$el=this.getEl(this.el),this.el=this.$el[0]),!this.$el||0===this.$el.length){if(this.getOption("allowMissingEl"))return!1;throw new f.Error('An "el" '+this.$el.selector+" must exist in DOM")}return!0},_ensureViewIsIntact:function(a){if(!a)throw new f.Error({name:"ViewNotValid",message:"The view passed is undefined and therefore invalid. You must pass a view instance to show."});if(a.isDestroyed)throw new f.Error({name:"ViewDestroyedError",message:'View (cid: "'+a.cid+'") has already been destroyed and cannot be used.'})},getEl:function(a){return b.$(a,f._getValue(this.options.parentEl,this))},attachHtml:function(a){this.$el.contents().detach(),this.el.appendChild(a.el)},empty:function(a){var b=this.currentView,c=f._getValue(a,"preventDestroy",this);return b?(b.off("destroy",this.empty,this),this.triggerMethod("before:empty",b),c||this._destroyView(),this.triggerMethod("empty",b),delete this.currentView,c&&this.$el.contents().detach(),this):void 0},_destroyView:function(){var a=this.currentView;a.destroy&&!a.isDestroyed?a.destroy():a.remove&&(a.remove(),a.isDestroyed=!0)},attachView:function(a){return this.currentView=a,this},hasView:function(){return!!this.currentView},reset:function(){return this.empty(),this.$el&&(this.el=this.$el.selector),delete this.$el,this}},{buildRegion:function(a,b){if(c.isString(a))return this._buildRegionFromSelector(a,b);if(a.selector||a.el||a.regionClass)return this._buildRegionFromObject(a,b);if(c.isFunction(a))return this._buildRegionFromRegionClass(a);throw new f.Error({message:"Improper region configuration type.",url:"marionette.region.html#region-configuration-types"})},_buildRegionFromSelector:function(a,b){return new b({el:a})},_buildRegionFromObject:function(a,b){var d=a.regionClass||b,e=c.omit(a,"selector","regionClass");return a.selector&&!e.el&&(e.el=a.selector),new d(e)},_buildRegionFromRegionClass:function(a){return new a}}),f.RegionManager=f.Controller.extend({constructor:function(a){this._regions={},this.length=0,f.Controller.call(this,a),this.addRegions(this.getOption("regions"))},addRegions:function(a,b){return a=f._getValue(a,this,arguments),c.reduce(a,function(a,d,e){return c.isString(d)&&(d={selector:d}),d.selector&&(d=c.defaults({},d,b)),a[e]=this.addRegion(e,d),a},{},this)},addRegion:function(a,b){var c;return c=b instanceof f.Region?b:f.Region.buildRegion(b,f.Region),this.triggerMethod("before:add:region",a,c),c._parent=this,this._store(a,c),this.triggerMethod("add:region",a,c),c},get:function(a){return this._regions[a]},getRegions:function(){return c.clone(this._regions)},removeRegion:function(a){var b=this._regions[a];return this._remove(a,b),b},removeRegions:function(){var a=this.getRegions();return c.each(this._regions,function(a,b){this._remove(b,a)},this),a},emptyRegions:function(){var a=this.getRegions();return c.invoke(a,"empty"),a},destroy:function(){return this.removeRegions(),f.Controller.prototype.destroy.apply(this,arguments)},_store:function(a,b){this._regions[a]||this.length++,this._regions[a]=b},_remove:function(a,b){this.triggerMethod("before:remove:region",a,b),b.empty(),b.stopListening(),delete b._parent,delete this._regions[a],this.length--,this.triggerMethod("remove:region",a,b)}}),f.actAsCollection(f.RegionManager.prototype,"_regions"),f.TemplateCache=function(a){this.templateId=a},c.extend(f.TemplateCache,{templateCaches:{},get:function(a,b){var c=this.templateCaches[a];return c||(c=new f.TemplateCache(a),this.templateCaches[a]=c),c.load(b)},clear:function(){var a,b=c.toArray(arguments),d=b.length;if(d>0)for(a=0;d>a;a++)delete this.templateCaches[b[a]];else this.templateCaches={}}}),c.extend(f.TemplateCache.prototype,{load:function(a){if(this.compiledTemplate)return this.compiledTemplate;var b=this.loadTemplate(this.templateId,a);return this.compiledTemplate=this.compileTemplate(b,a),this.compiledTemplate},loadTemplate:function(a,c){var d=b.$(a).html();if(!d||0===d.length)throw new f.Error({name:"NoTemplateError",message:'Could not find template: "'+a+'"'});return d},compileTemplate:function(a,b){return c.template(a,b)}}),f.Renderer={render:function(a,b){if(!a)throw new f.Error({name:"TemplateNotFoundError",message:"Cannot render the template since its false, null or undefined."});var d=c.isFunction(a)?a:f.TemplateCache.get(a);return d(b)}},f.View=b.View.extend({isDestroyed:!1,constructor:function(a){c.bindAll(this,"render"),a=f._getValue(a,this),this.options=c.extend({},c.result(this,"options"),a),this._behaviors=f.Behaviors(this),b.View.call(this,this.options),f.MonitorDOMRefresh(this)},getTemplate:function(){return this.getOption("template")},serializeModel:function(a){return a.toJSON.apply(a,c.rest(arguments))},mixinTemplateHelpers:function(a){a=a||{};var b=this.getOption("templateHelpers");return b=f._getValue(b,this),c.extend(a,b)},normalizeUIKeys:function(a){var b=c.result(this,"_uiBindings");return f.normalizeUIKeys(a,b||c.result(this,"ui"))},normalizeUIValues:function(a,b){var d=c.result(this,"ui"),e=c.result(this,"_uiBindings");return f.normalizeUIValues(a,e||d,b)},configureTriggers:function(){if(this.triggers){var a=this.normalizeUIKeys(c.result(this,"triggers"));return c.reduce(a,function(a,b,c){return a[c]=this._buildViewTrigger(b),a},{},this)}},delegateEvents:function(a){return this._delegateDOMEvents(a),this.bindEntityEvents(this.model,this.getOption("modelEvents")),this.bindEntityEvents(this.collection,this.getOption("collectionEvents")),c.each(this._behaviors,function(a){a.bindEntityEvents(this.model,a.getOption("modelEvents")),a.bindEntityEvents(this.collection,a.getOption("collectionEvents"))},this),this},_delegateDOMEvents:function(a){var d=f._getValue(a||this.events,this);d=this.normalizeUIKeys(d),c.isUndefined(a)&&(this.events=d);var e={},g=c.result(this,"behaviorEvents")||{},h=this.configureTriggers(),i=c.result(this,"behaviorTriggers")||{};c.extend(e,g,d,h,i),b.View.prototype.delegateEvents.call(this,e)},undelegateEvents:function(){return b.View.prototype.undelegateEvents.apply(this,arguments),this.unbindEntityEvents(this.model,this.getOption("modelEvents")),this.unbindEntityEvents(this.collection,this.getOption("collectionEvents")),c.each(this._behaviors,function(a){a.unbindEntityEvents(this.model,a.getOption("modelEvents")),a.unbindEntityEvents(this.collection,a.getOption("collectionEvents"))},this),this},_ensureViewIsIntact:function(){if(this.isDestroyed)throw new f.Error({name:"ViewDestroyedError",message:'View (cid: "'+this.cid+'") has already been destroyed and cannot be used.'})},destroy:function(){if(this.isDestroyed)return this;var a=c.toArray(arguments);return this.triggerMethod.apply(this,["before:destroy"].concat(a)),this.isDestroyed=!0,this.triggerMethod.apply(this,["destroy"].concat(a)),this.unbindUIElements(),this.isRendered=!1,this.remove(),c.invoke(this._behaviors,"destroy",a),this},bindUIElements:function(){this._bindUIElements(),c.invoke(this._behaviors,this._bindUIElements)},_bindUIElements:function(){if(this.ui){this._uiBindings||(this._uiBindings=this.ui);var a=c.result(this,"_uiBindings");this.ui={},c.each(a,function(a,b){this.ui[b]=this.$(a)},this)}},unbindUIElements:function(){this._unbindUIElements(),c.invoke(this._behaviors,this._unbindUIElements)},_unbindUIElements:function(){this.ui&&this._uiBindings&&(c.each(this.ui,function(a,b){delete this.ui[b]},this),this.ui=this._uiBindings,delete this._uiBindings)},_buildViewTrigger:function(a){var b=c.isObject(a),d=c.defaults({},b?a:{},{preventDefault:!0,stopPropagation:!0}),e=b?d.event:a;return function(a){a&&(a.preventDefault&&d.preventDefault&&a.preventDefault(),a.stopPropagation&&d.stopPropagation&&a.stopPropagation());var b={view:this,model:this.model,collection:this.collection};this.triggerMethod(e,b)}},setElement:function(){var a=b.View.prototype.setElement.apply(this,arguments);return c.invoke(this._behaviors,"proxyViewProperties",this),a},triggerMethod:function(){var a=f._triggerMethod(this,arguments);return this._triggerEventOnBehaviors(arguments),this._triggerEventOnParentLayout(arguments[0],c.rest(arguments)),a},_triggerEventOnBehaviors:function(a){for(var b=f._triggerMethod,c=this._behaviors,d=0,e=c&&c.length;e>d;d++)b(c[d],a)},_triggerEventOnParentLayout:function(a,b){var d=this._parentLayoutView();if(d){var e=f.getOption(d,"childViewEventPrefix"),g=e+":"+a;f._triggerMethod(d,[g,this].concat(b));var h=f.getOption(d,"childEvents"),i=d.normalizeMethods(h);i&&c.isFunction(i[a])&&i[a].apply(d,[this].concat(b))}},_getImmediateChildren:function(){return[]},_getNestedViews:function(){var a=this._getImmediateChildren();return a.length?c.reduce(a,function(a,b){return b._getNestedViews?a.concat(b._getNestedViews()):a},a):a},_getAncestors:function(){for(var a=[],b=this._parent;b;)a.push(b),b=b._parent;return a},_parentLayoutView:function(){var a=this._getAncestors();return c.find(a,function(a){return a instanceof f.LayoutView})},normalizeMethods:f.normalizeMethods,mergeOptions:f.mergeOptions,getOption:f.proxyGetOption,bindEntityEvents:f.proxyBindEntityEvents,unbindEntityEvents:f.proxyUnbindEntityEvents}),f.ItemView=f.View.extend({constructor:function(){f.View.apply(this,arguments)},serializeData:function(){if(!this.model&&!this.collection)return{};var a=[this.model||this.collection];return arguments.length&&a.push.apply(a,arguments),this.model?this.serializeModel.apply(this,a):{items:this.serializeCollection.apply(this,a)}},serializeCollection:function(a){return a.toJSON.apply(a,c.rest(arguments))},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderTemplate(),this.isRendered=!0,this.bindUIElements(),this.triggerMethod("render",this),this},_renderTemplate:function(){var a=this.getTemplate();if(a!==!1){if(!a)throw new f.Error({name:"UndefinedTemplateError",message:"Cannot render the template since it is null or undefined."});var b=this.mixinTemplateHelpers(this.serializeData()),c=f.Renderer.render(a,b,this);return this.attachElContent(c),this}},attachElContent:function(a){return this.$el.html(a),this}}),f.CollectionView=f.View.extend({childViewEventPrefix:"childview",sort:!0,constructor:function(a){this.once("render",this._initialEvents),this._initChildViewStorage(),f.View.apply(this,arguments),this.on("show",this._onShowCalled),this.initRenderBuffer()},initRenderBuffer:function(){this._bufferedChildren=[]},startBuffering:function(){this.initRenderBuffer(),this.isBuffering=!0},endBuffering:function(){this.isBuffering=!1,this._triggerBeforeShowBufferedChildren(),this.attachBuffer(this),this._triggerShowBufferedChildren(),this.initRenderBuffer()},_triggerBeforeShowBufferedChildren:function(){this._isShown&&c.each(this._bufferedChildren,c.partial(this._triggerMethodOnChild,"before:show"))},_triggerShowBufferedChildren:function(){this._isShown&&(c.each(this._bufferedChildren,c.partial(this._triggerMethodOnChild,"show")),this._bufferedChildren=[]);
},_triggerMethodOnChild:function(a,b){f.triggerMethodOn(b,a)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.getOption("sort")&&this.listenTo(this.collection,"sort",this._sortViews))},_onCollectionAdd:function(a,b,d){var e;if(e=void 0!==d.at?d.at:c.indexOf(this._filteredSortedModels(),a),this._shouldAddChild(a,e)){this.destroyEmptyView();var f=this.getChildView(a);this.addChild(a,f,e)}},_onCollectionRemove:function(a){var b=this.children.findByModel(a);this.removeChildView(b),this.checkEmpty()},_onShowCalled:function(){this.children.each(c.partial(this._triggerMethodOnChild,"show"))},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderChildren(),this.isRendered=!0,this.triggerMethod("render",this),this},reorder:function(){var a=this.children,b=this._filteredSortedModels(),d=c.find(b,function(b){return!a.findByModel(b)});if(d)this.render();else{var e=c.map(b,function(b){return a.findByModel(b).el});this.triggerMethod("before:reorder"),this._appendReorderedChildren(e),this.triggerMethod("reorder")}},resortView:function(){f.getOption(this,"reorderOnSort")?this.reorder():this.render()},_sortViews:function(){var a=this._filteredSortedModels(),b=c.find(a,function(a,b){var c=this.children.findByModel(a);return!c||c._index!==b},this);b&&this.resortView()},_emptyViewIndex:-1,_appendReorderedChildren:function(a){this.$el.append(a)},_renderChildren:function(){this.destroyEmptyView(),this.destroyChildren(),this.isEmpty(this.collection)?this.showEmptyView():(this.triggerMethod("before:render:collection",this),this.startBuffering(),this.showCollection(),this.endBuffering(),this.triggerMethod("render:collection",this),this.children.isEmpty()&&this.showEmptyView())},showCollection:function(){var a,b=this._filteredSortedModels();c.each(b,function(b,c){a=this.getChildView(b),this.addChild(b,a,c)},this)},_filteredSortedModels:function(){var a,b=this.getViewComparator();return a=b?c.isString(b)||1===b.length?this.collection.sortBy(b,this):c.clone(this.collection.models).sort(c.bind(b,this)):this.collection.models,this.getOption("filter")&&(a=c.filter(a,function(a,b){return this._shouldAddChild(a,b)},this)),a},showEmptyView:function(){var a=this.getEmptyView();if(a&&!this._showingEmptyView){this.triggerMethod("before:render:empty"),this._showingEmptyView=!0;var c=new b.Model;this.addEmptyView(c,a),this.triggerMethod("render:empty")}},destroyEmptyView:function(){this._showingEmptyView&&(this.triggerMethod("before:remove:empty"),this.destroyChildren(),delete this._showingEmptyView,this.triggerMethod("remove:empty"))},getEmptyView:function(){return this.getOption("emptyView")},addEmptyView:function(a,b){var d=this.getOption("emptyViewOptions")||this.getOption("childViewOptions");c.isFunction(d)&&(d=d.call(this,a,this._emptyViewIndex));var e=this.buildChildView(a,b,d);e._parent=this,this.proxyChildEvents(e),this._isShown&&f.triggerMethodOn(e,"before:show"),this.children.add(e),this.renderChildView(e,this._emptyViewIndex),this._isShown&&f.triggerMethodOn(e,"show")},getChildView:function(a){var b=this.getOption("childView");if(!b)throw new f.Error({name:"NoChildViewError",message:'A "childView" must be specified'});return b},addChild:function(a,b,c){var d=this.getOption("childViewOptions");d=f._getValue(d,this,[a,c]);var e=this.buildChildView(a,b,d);return this._updateIndices(e,!0,c),this._addChildView(e,c),e._parent=this,e},_updateIndices:function(a,b,c){this.getOption("sort")&&(b&&(a._index=c),this.children.each(function(c){c._index>=a._index&&(c._index+=b?1:-1)}))},_addChildView:function(a,b){this.proxyChildEvents(a),this.triggerMethod("before:add:child",a),this._isShown&&!this.isBuffering&&f.triggerMethodOn(a,"before:show"),this.children.add(a),this.renderChildView(a,b),this._isShown&&!this.isBuffering&&f.triggerMethodOn(a,"show"),this.triggerMethod("add:child",a)},renderChildView:function(a,b){return a.render(),this.attachHtml(this,a,b),a},buildChildView:function(a,b,d){var e=c.extend({model:a},d);return new b(e)},removeChildView:function(a){return a&&(this.triggerMethod("before:remove:child",a),a.destroy?a.destroy():a.remove&&a.remove(),delete a._parent,this.stopListening(a),this.children.remove(a),this.triggerMethod("remove:child",a),this._updateIndices(a,!1)),a},isEmpty:function(){return!this.collection||0===this.collection.length},checkEmpty:function(){this.isEmpty(this.collection)&&this.showEmptyView()},attachBuffer:function(a){a.$el.append(this._createBuffer(a))},_createBuffer:function(a){var b=document.createDocumentFragment();return c.each(a._bufferedChildren,function(a){b.appendChild(a.el)}),b},attachHtml:function(a,b,c){a.isBuffering?a._bufferedChildren.splice(c,0,b):a._insertBefore(b,c)||a._insertAfter(b)},_insertBefore:function(a,b){var c,d=this.getOption("sort")&&b<this.children.length-1;return d&&(c=this.children.find(function(a){return a._index===b+1})),c?(c.$el.before(a.el),!0):!1},_insertAfter:function(a){this.$el.append(a.el)},_initChildViewStorage:function(){this.children=new b.ChildViewContainer},destroy:function(){return this.isDestroyed?this:(this.triggerMethod("before:destroy:collection"),this.destroyChildren(),this.triggerMethod("destroy:collection"),f.View.prototype.destroy.apply(this,arguments))},destroyChildren:function(){var a=this.children.map(c.identity);return this.children.each(this.removeChildView,this),this.checkEmpty(),a},_shouldAddChild:function(a,b){var d=this.getOption("filter");return!c.isFunction(d)||d.call(this,a,b,this.collection)},proxyChildEvents:function(a){var b=this.getOption("childViewEventPrefix");this.listenTo(a,"all",function(){var d=c.toArray(arguments),e=d[0],f=this.normalizeMethods(c.result(this,"childEvents"));d[0]=b+":"+e,d.splice(1,0,a),"undefined"!=typeof f&&c.isFunction(f[e])&&f[e].apply(this,d.slice(1)),this.triggerMethod.apply(this,d)})},_getImmediateChildren:function(){return c.values(this.children._views)},getViewComparator:function(){return this.getOption("viewComparator")}}),f.CompositeView=f.CollectionView.extend({constructor:function(){f.CollectionView.apply(this,arguments)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this._renderChildren),this.getOption("sort")&&this.listenTo(this.collection,"sort",this._sortViews))},getChildView:function(a){var b=this.getOption("childView")||this.constructor;return b},serializeData:function(){var a={};return this.model&&(a=c.partial(this.serializeModel,this.model).apply(this,arguments)),a},render:function(){return this._ensureViewIsIntact(),this._isRendering=!0,this.resetChildViewContainer(),this.triggerMethod("before:render",this),this._renderTemplate(),this._renderChildren(),this._isRendering=!1,this.isRendered=!0,this.triggerMethod("render",this),this},_renderChildren:function(){(this.isRendered||this._isRendering)&&f.CollectionView.prototype._renderChildren.call(this)},_renderTemplate:function(){var a={};a=this.serializeData(),a=this.mixinTemplateHelpers(a),this.triggerMethod("before:render:template");var b=this.getTemplate(),c=f.Renderer.render(b,a,this);this.attachElContent(c),this.bindUIElements(),this.triggerMethod("render:template")},attachElContent:function(a){return this.$el.html(a),this},attachBuffer:function(a){var b=this.getChildViewContainer(a);b.append(this._createBuffer(a))},_insertAfter:function(a){var b=this.getChildViewContainer(this,a);b.append(a.el)},_appendReorderedChildren:function(a){var b=this.getChildViewContainer(this);b.append(a)},getChildViewContainer:function(a,b){if("$childViewContainer"in a)return a.$childViewContainer;var c,d=f.getOption(a,"childViewContainer");if(d){var e=f._getValue(d,a);if(c="@"===e.charAt(0)&&a.ui?a.ui[e.substr(4)]:a.$(e),c.length<=0)throw new f.Error({name:"ChildViewContainerMissingError",message:'The specified "childViewContainer" was not found: '+a.childViewContainer})}else c=a.$el;return a.$childViewContainer=c,c},resetChildViewContainer:function(){this.$childViewContainer&&delete this.$childViewContainer}}),f.LayoutView=f.ItemView.extend({regionClass:f.Region,options:{destroyImmediate:!1},childViewEventPrefix:"childview",constructor:function(a){a=a||{},this._firstRender=!0,this._initializeRegions(a),f.ItemView.call(this,a)},render:function(){return this._ensureViewIsIntact(),this._firstRender?this._firstRender=!1:this._reInitializeRegions(),f.ItemView.prototype.render.apply(this,arguments)},destroy:function(){return this.isDestroyed?this:(this.getOption("destroyImmediate")===!0&&this.$el.remove(),this.regionManager.destroy(),f.ItemView.prototype.destroy.apply(this,arguments))},showChildView:function(a,b){return this.getRegion(a).show(b)},getChildView:function(a){return this.getRegion(a).currentView},addRegion:function(a,b){var c={};return c[a]=b,this._buildRegions(c)[a]},addRegions:function(a){return this.regions=c.extend({},this.regions,a),this._buildRegions(a)},removeRegion:function(a){return delete this.regions[a],this.regionManager.removeRegion(a)},getRegion:function(a){return this.regionManager.get(a)},getRegions:function(){return this.regionManager.getRegions()},_buildRegions:function(a){var b={regionClass:this.getOption("regionClass"),parentEl:c.partial(c.result,this,"el")};return this.regionManager.addRegions(a,b)},_initializeRegions:function(a){var b;this._initRegionManager(),b=f._getValue(this.regions,this,[a])||{};var d=this.getOption.call(a,"regions");d=f._getValue(d,this,[a]),c.extend(b,d),b=this.normalizeUIValues(b,["selector","el"]),this.addRegions(b)},_reInitializeRegions:function(){this.regionManager.invoke("reset")},getRegionManager:function(){return new f.RegionManager},_initRegionManager:function(){this.regionManager=this.getRegionManager(),this.regionManager._parent=this,this.listenTo(this.regionManager,"before:add:region",function(a){this.triggerMethod("before:add:region",a)}),this.listenTo(this.regionManager,"add:region",function(a,b){this[a]=b,this.triggerMethod("add:region",a,b)}),this.listenTo(this.regionManager,"before:remove:region",function(a){this.triggerMethod("before:remove:region",a)}),this.listenTo(this.regionManager,"remove:region",function(a,b){delete this[a],this.triggerMethod("remove:region",a,b)})},_getImmediateChildren:function(){return c.chain(this.regionManager.getRegions()).pluck("currentView").compact().value()}}),f.Behavior=f.Object.extend({constructor:function(a,b){this.view=b,this.defaults=c.result(this,"defaults")||{},this.options=c.extend({},this.defaults,a),this.ui=c.extend({},c.result(b,"ui"),c.result(this,"ui")),f.Object.apply(this,arguments)},$:function(){return this.view.$.apply(this.view,arguments)},destroy:function(){return this.stopListening(),this},proxyViewProperties:function(a){this.$el=a.$el,this.el=a.el}}),f.Behaviors=function(a,b){function c(a,d){return b.isObject(a.behaviors)?(d=c.parseBehaviors(a,d||b.result(a,"behaviors")),c.wrap(a,d,b.keys(g)),d):{}}function d(a,b){this._view=a,this._behaviors=b,this._triggers={}}function e(a){return a._uiBindings||a.ui}var f=/^(\S+)\s*(.*)$/,g={behaviorTriggers:function(a,b){var c=new d(this,b);return c.buildBehaviorTriggers()},behaviorEvents:function(c,d){var g={};return b.each(d,function(c,d){var h={},i=b.clone(b.result(c,"events"))||{};i=a.normalizeUIKeys(i,e(c));var j=0;b.each(i,function(a,e){var g=e.match(f),i=g[1]+"."+[this.cid,d,j++," "].join(""),k=g[2],l=i+k,m=b.isFunction(a)?a:c[a];h[l]=b.bind(m,c)},this),g=b.extend(g,h)},this),g}};return b.extend(c,{behaviorsLookup:function(){throw new a.Error({message:"You must define where your behaviors are stored.",url:"marionette.behaviors.html#behaviorslookup"})},getBehaviorClass:function(b,d){return b.behaviorClass?b.behaviorClass:a._getValue(c.behaviorsLookup,this,[b,d])[d]},parseBehaviors:function(a,d){return b.chain(d).map(function(d,e){var f=c.getBehaviorClass(d,e),g=new f(d,a),h=c.parseBehaviors(a,b.result(g,"behaviors"));return[g].concat(h)}).flatten().value()},wrap:function(a,c,d){b.each(d,function(d){a[d]=b.partial(g[d],a[d],c)})}}),b.extend(d.prototype,{buildBehaviorTriggers:function(){return b.each(this._behaviors,this._buildTriggerHandlersForBehavior,this),this._triggers},_buildTriggerHandlersForBehavior:function(c,d){var f=b.clone(b.result(c,"triggers"))||{};f=a.normalizeUIKeys(f,e(c)),b.each(f,b.bind(this._setHandlerForBehavior,this,c,d))},_setHandlerForBehavior:function(a,b,c,d){var e=d.replace(/^\S+/,function(a){return a+".behaviortriggers"+b});this._triggers[e]=this._view._buildViewTrigger(c)}}),c}(f,c),f.AppRouter=b.Router.extend({constructor:function(a){this.options=a||{},b.Router.apply(this,arguments);var c=this.getOption("appRoutes"),d=this._getController();this.processAppRoutes(d,c),this.on("route",this._processOnRoute,this)},appRoute:function(a,b){var c=this._getController();this._addAppRoute(c,a,b)},_processOnRoute:function(a,b){if(c.isFunction(this.onRoute)){var d=c.invert(this.getOption("appRoutes"))[a];this.onRoute(a,d,b)}},processAppRoutes:function(a,b){if(b){var d=c.keys(b).reverse();c.each(d,function(c){this._addAppRoute(a,c,b[c])},this)}},_getController:function(){return this.getOption("controller")},_addAppRoute:function(a,b,d){var e=a[d];if(!e)throw new f.Error('Method "'+d+'" was not found on the controller');this.route(b,d,c.bind(e,a))},mergeOptions:f.mergeOptions,getOption:f.proxyGetOption,triggerMethod:f.triggerMethod,bindEntityEvents:f.proxyBindEntityEvents,unbindEntityEvents:f.proxyUnbindEntityEvents}),f.Application=f.Object.extend({constructor:function(a){this._initializeRegions(a),this._initCallbacks=new f.Callbacks,this.submodules={},c.extend(this,a),this._initChannel(),f.Object.call(this,a)},execute:function(){this.commands.execute.apply(this.commands,arguments)},request:function(){return this.reqres.request.apply(this.reqres,arguments)},addInitializer:function(a){this._initCallbacks.add(a)},start:function(a){this.triggerMethod("before:start",a),this._initCallbacks.run(a,this),this.triggerMethod("start",a)},addRegions:function(a){return this._regionManager.addRegions(a)},emptyRegions:function(){return this._regionManager.emptyRegions()},removeRegion:function(a){return this._regionManager.removeRegion(a)},getRegion:function(a){return this._regionManager.get(a)},getRegions:function(){return this._regionManager.getRegions()},module:function(a,b){var d=f.Module.getClass(b),e=c.toArray(arguments);return e.unshift(this),d.create.apply(d,e)},getRegionManager:function(){return new f.RegionManager},_initializeRegions:function(a){var b=c.isFunction(this.regions)?this.regions(a):this.regions||{};this._initRegionManager();var d=f.getOption(a,"regions");return c.isFunction(d)&&(d=d.call(this,a)),c.extend(b,d),this.addRegions(b),this},_initRegionManager:function(){this._regionManager=this.getRegionManager(),this._regionManager._parent=this,this.listenTo(this._regionManager,"before:add:region",function(){f._triggerMethod(this,"before:add:region",arguments)}),this.listenTo(this._regionManager,"add:region",function(a,b){this[a]=b,f._triggerMethod(this,"add:region",arguments)}),this.listenTo(this._regionManager,"before:remove:region",function(){f._triggerMethod(this,"before:remove:region",arguments)}),this.listenTo(this._regionManager,"remove:region",function(a){delete this[a],f._triggerMethod(this,"remove:region",arguments)})},_initChannel:function(){this.channelName=c.result(this,"channelName")||"global",this.channel=c.result(this,"channel")||b.Wreqr.radio.channel(this.channelName),this.vent=c.result(this,"vent")||this.channel.vent,this.commands=c.result(this,"commands")||this.channel.commands,this.reqres=c.result(this,"reqres")||this.channel.reqres}}),f.Module=function(a,b,d){this.moduleName=a,this.options=c.extend({},this.options,d),this.initialize=d.initialize||this.initialize,this.submodules={},this._setupInitializersAndFinalizers(),this.app=b,c.isFunction(this.initialize)&&this.initialize(a,b,this.options)},f.Module.extend=f.extend,c.extend(f.Module.prototype,b.Events,{startWithParent:!0,initialize:function(){},addInitializer:function(a){this._initializerCallbacks.add(a)},addFinalizer:function(a){this._finalizerCallbacks.add(a)},start:function(a){this._isInitialized||(c.each(this.submodules,function(b){b.startWithParent&&b.start(a)}),this.triggerMethod("before:start",a),this._initializerCallbacks.run(a,this),this._isInitialized=!0,this.triggerMethod("start",a))},stop:function(){this._isInitialized&&(this._isInitialized=!1,this.triggerMethod("before:stop"),c.invoke(this.submodules,"stop"),this._finalizerCallbacks.run(void 0,this),this._initializerCallbacks.reset(),this._finalizerCallbacks.reset(),this.triggerMethod("stop"))},addDefinition:function(a,b){this._runModuleDefinition(a,b)},_runModuleDefinition:function(a,d){if(a){var e=c.flatten([this,this.app,b,f,b.$,c,d]);a.apply(this,e)}},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new f.Callbacks,this._finalizerCallbacks=new f.Callbacks},triggerMethod:f.triggerMethod}),c.extend(f.Module,{create:function(a,b,d){var e=a,f=c.drop(arguments,3);b=b.split(".");var g=b.length,h=[];return h[g-1]=d,c.each(b,function(b,c){var g=e;e=this._getModule(g,b,a,d),this._addModuleDefinition(g,e,h[c],f)},this),e},_getModule:function(a,b,d,e,f){var g=c.extend({},e),h=this.getClass(e),i=a[b];return i||(i=new h(b,d,g),a[b]=i,a.submodules[b]=i),i},getClass:function(a){var b=f.Module;return a?a.prototype instanceof b?a:a.moduleClass||b:b},_addModuleDefinition:function(a,b,c,d){var e=this._getDefine(c),f=this._getStartWithParent(c,b);e&&b.addDefinition(e,d),this._addStartWithParent(a,b,f)},_getStartWithParent:function(a,b){var d;return c.isFunction(a)&&a.prototype instanceof f.Module?(d=b.constructor.prototype.startWithParent,c.isUndefined(d)?!0:d):c.isObject(a)?(d=a.startWithParent,c.isUndefined(d)?!0:d):!0},_getDefine:function(a){return!c.isFunction(a)||a.prototype instanceof f.Module?c.isObject(a)?a.define:null:a},_addStartWithParent:function(a,b,c){b.startWithParent=b.startWithParent&&c,b.startWithParent&&!b.startWithParentIsConfigured&&(b.startWithParentIsConfigured=!0,a.addInitializer(function(a){b.startWithParent&&b.start(a)}))}}),f});var k={linkify:/(^|&nbsp;|\s)(www\.)?(?=[a-zA-Z0-9])(([-a-zA-Z0-9@:%_\+\/\/=]){1,256}\.)+([a-zA-Z]{2,15})\b(:[0-9]{2,})?([?\/#]([-a-zA-Z0-9,@:%_\+.~#!?&\/\/=\[\]]|[^\x00-\x7F])*)?/gim,email:/^[a-zA-Z]([a-zA-Z0-9\._%\+\-])*@([a-zA-Z0-9\.\-])*\.[a-zA-Z]{2,10}$/,brTags:/(<br>|<br\/>)/gi,tagRemoval:/<.+?>/g},l={regex:{happy:e("(:\\)|:-\\)|\\(happy\\))"),sad:e("(:\\(|:-\\(|\\(sad\\))"),grin:e("(:D|:-D|\\(grin\\))"),sealed:e("(:x|:-x|\\(sealed\\))"),wink:e("(;\\)|;-\\)|\\(wink\\))"),yawn:e("(\\(yawn\\))"),smirk:e("(\\(smirk\\))"),starstruck:e("(\\(starstruck\\))"),depressed:e("(:C|:-C|\\(depressed\\))"),sadnerd:e("(8\\(|8-\\(|\\(sadnerd\\))"),zomg:e("(D:|\\(zomg\\))"),speechless:e("(:\\||:-\\||\\(speechless\\))"),crying:e("(:'\\(|:'-\\(|\\(crying\\))"),relieved:e("(\\(relieved\\))"),satisfied:e("(\\(satisfied\\))"),determined:e("(\\(determined\\))"),tongue:e("(:p|:-p|\\(tongue\\))"),unsure:e("(:-\\/|\\(unsure\\))"),sleep:e("(-_-|\\(sleep\\))"),disguise:e("(8{|8-{|\\(disguise\\))"),cool:e("(B\\)|B-\\)|\\(cool\\))"),nerd:e("(8\\)|8-\\)|\\(nerd\\))"),lovestruck:e("(\\(lovestruck\\))"),angry:e("\\(angry\\)"),evil:e("(\\(evil\\))"),sick:e("(:s|:-s|\\(sick\\))"),embarassed:e("(\\/_\\\\|\\(embarassed\\))"),mustache:e("(:{|\\(mustache\\))"),surprised:e("(:o|:-o|\\(surprised\\))"),tease:e("(;p|;-p|\\(tease\\))"),ninja:e("\\(ninja\\)"),zombie:e("\\(zombie\\)")},imageMappings:{happy:"emote-happy",sad:"emote-sad",grin:"emote-grin",sealed:"emote-sealed",wink:"emote-wink",yawn:"emote-yawn",smirk:"emote-smirk",starstruck:"emote-starstruck",depressed:"emote-depressed",sadnerd:"emote-sadnerd",zomg:"emote-zomg",speechless:"emote-speechless",crying:"emote-crying",relieved:"emote-relieved",satisfied:"emote-satisfied",determined:"emote-determined",tongue:"emote-tongue",unsure:"emote-unsure",sleep:"emote-sleep",disguise:"emote-disguised",cool:"emote-cool",nerd:"emote-nerd",lovestruck:"emote-lovestruck",angry:"emote-angry",evil:"emote-evil",sick:"emote-sick",embarassed:"emote-embarassed",mustache:"emote-mustache",surprised:"emote-surprised",tease:"emote-tease",ninja:"emote-ninja",zombie:"emote-zombie"},parse:function(a){if(a)for(var b in l.regex)a=a.replace(l.regex[b],'$1<div class="emoticon '+l.imageMappings[b]+'" title="'+b+'"></div>');return a}};purechatApp=new Marionette.Application,purechatApp.start(),Backbone.Relational.showWarnings=!1,purechatApp.module("Constants",function(a,b,c,d,e,f){a.WidgetType={Tab:1,Button:2,Image:3,ImageTab:4},a.BasicWidgetType=1,a.PersonalChatType=2,a.WidgetStates={Initializing:"PCStateInitializing",Inactive:"PCStateInactive",Activating:"PCStateActivating",Chatting:"PCStateChatting",Closed:"PCStateClosed",Unavailable:"PCStateUnavailable",Unsupported:"PCStateUnsupported",EmailForm:"PCStateEmailForm"},a.Features={VisitorTracking:1},a.FeatureStatus={Disabled:0,Enabled:1,Off:-1}}),(window.pcDashboard||purechatApp).module("Logging",function(a,b,c,d,e,f){b._logAllAjaxRequests=!1;var g=function(a,b){this.level=a,this.name=b};g.prototype={toString:function(){return this.name},equals:function(a){try{return this.level==a.level}catch(b){return!1}},isGreaterOrEqual:function(a){try{return this.level>=a.level}catch(b){return!1}}},g.ALL=new g(Number.MIN_VALUE,"ALL"),g.TRACE=new g(1e4,"TRACE"),g.DEBUG=new g(2e4,"DEBUG"),g.INFO=new g(3e4,"INFO"),g.WARN=new g(4e4,"WARN"),g.ERROR=new g(5e4,"ERROR"),g.FATAL=new g(6e4,"FATAL"),g.OFF=new g(Number.MAX_VALUE,"OFF");window.onerror=function(b,c,d,e,f){"undefined"!=typeof window.pcDashboard&&a.logger&&a.logger.log("ERROR",b+" [line:"+d+"] "+c,null!=exceptionObject?f.stack:null,!1,CurrentUser?CurrentUser.get("chatServerUrl"):null,CurrentUser?CurrentUser.get("accountId"):null)};var h=d.Controller.extend({_logAllAjaxRequests:!1,getQueryStringParams:function(){var a={},b=window.location.search.substr(window.location.search.indexOf("?")+1);if(b.length>0){var c=b.split("&");c.forEach(function(b){var c=b.split("=");a[c[0]]="undefined"!=typeof c[1]?c[1]:null})}return a},initialize:function(){var a=this.getQueryStringParams();b._logAllAjaxRequests=a.application_debug||!1,b._logAllAjaxRequests},log:function(a,c,d,h,i,j){f.isString(a)&&(a=g[a]);var k=b.LogLevel||g.ERROR;if(k.isGreaterOrEqual(a))try{e.ajax({url:(b.pureServerUrl||"")+"/AjaxLogger/Log",dataType:"jsonp",data:{level:a.toString(),message:c,stackTrace:encodeURIComponent(d.substr(0,h?150:75)),chatServerUrl:encodeURIComponent(i),accountId:j},ignoreLogging:!0,timeout:2e4,success:function(a){},error:function(a,b,c){}})}catch(l){console.log(l)}}});a.addInitializer(function(){a.logger=new h,d.Controller.prototype.log=f.bind(a.logger.log,a.logger)}),a.addFinalizer(function(){a.log=null})}),purechatApp.module("Utils",function(a,b,c,d,e,f){e.throttle=function(a,b,c,d){function f(){function e(){h=+new Date,c.apply(i,k)}function f(){g=void 0}var i=this,j=+new Date-h,k=arguments;d&&!g&&e(),g&&clearTimeout(g),void 0===d&&j>a?e():b!==!0&&(g=setTimeout(d?f:e,void 0===d?a-j:a))}var g,h=0;return"boolean"!=typeof b&&(d=c,c=b,b=void 0),e.guid&&(f.guid=c.guid=c.guid||e.guid++),f},a.convertTimeFromUtc=function(a,b){return a},a.linkify=function(a){return a?(a=a.replace(/&amp;/gm,"&"),a=a.replace(k.brTags," <br/> "),linkifiedMessage=a.replace(k.linkify,function(a){var b=a.trim();return b=b.replace(/&nbsp;/gim,""),-1!=b.indexOf("@")?'<a href="mailto:'+b+'" target="_blank">'+a+"</a>":'<a href="'+(0!=b.indexOf("http")?"http://"+b:b)+'" target="_blank">'+a+"</a>"}),linkifiedMessage):null},a.formatWhitespace=function(a){var b=a.replace(/\n|\r/gm," <br/> ");return b=b.replace(/\t/gm," &nbsp; &nbsp; "),b.replace(/\s\s/g," &nbsp;")},a.parseEmoticons=function(a){return l.parse(a)},a.GaEvent=function(a,b,c){var d="GAEventCategory",e=!1,f=function(){if(window._gaq||window.ga){if(window.ga)try{window.ga("create",a.get("GoogId")),window.ga("send","event",a.get(d),a.get(c))}catch(b){e=!0,console.log("Unable to push event to Google via _gaq")}if(window.ga&&e&&window._gaq||!e&&window._gaq)try{window._gaq.push(["_setAccount",a.get("GoogId")]),window._gaq.push(["_trackEvent",a.get(d),a.get(c)])}catch(b){console.log("Unable to push event to Google via _gaq")}}};a.get("UsingGa")&&a.get(b)&&a.get(c)&&(window._gaq||window.ga||this.isOperator?this.isOperator||f():!function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=!1;a.onreadystatechange=a.onload=function(a){b||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(window._gaq=window._gaq||[],f(),b=!0)},document.getElementsByTagName("head").item(0).appendChild(a)}())},a.Notifier=function(){this.isTitleModified=!1,this.windowNotifyTimeout=null,this.timeoutId=null,this.active=!1,this.mobileActive=!1,this.mobileAnimationInterval=null},a.Notifier.prototype.notify=function(a,b,c){var d=this;if(!d.active){d.active=!0;var f=document.title;b&&(originalElementTitle=b.text());var g=function(){return 0==d.active?(document.title=f,b&&b.text(originalElementTitle),void(d.isTitleModified=!1)):(1==d.isTitleModified?(d.isTitleModified=!1,document.title=f,b&&b.text(originalElementTitle)):(d.isTitleModified=!0,document.title=a,b&&b.text(a)),void(d.timeoutId=setTimeout(g,900)))};d.timeoutId=setTimeout(g,900),c?c.on("mousemove.notifier",function(){d.stop()}):e(document).on("mousemove.notifier",function(){d.stop()})}},a.Notifier.prototype.stop=function(){this.active=!1,mouseStopElement?mouseStopElement.off("mousemove.notifier"):e(document).off("mousemove.notifier")},a.stripDangerousTags=function(a){return a.replace(/<script>.+<\/script>/gim,"")},a.stripOpenCloseTage=function(a){return a.replace(/<.+?>/gim,"")},a.escapeHtml=function(a,b){var c=e("<div/>");return a=c.text(a||"").html(),a.replace(/"/g,"")},a.addInitializer(function(a){"function"!=typeof Date.prototype.toHourMinuteString&&(Date.prototype.toHourMinuteString=function(){var a=this.getHours(),b=this.getMinutes(),c=this.getSeconds(),d=a>=12?" PM":" AM",e=0==a?12:a>12?a-12:a;return e+":"+(10>b?"0"+b:b)+":"+(10>c?"0"+c:c)+d})}),a.addFinalizer(function(a){Date.prototype.toHourMinuteString=null})}),GetReasonFromResponse=function(a){return 1==a?"Available":2==a?"NoOperators":3==a?"ServerDowntime":4==a?"AccountActivity":5==a?"ChatQuotaExceeded":6==a?"WidgetDisabled":7==a?"IpIsbanned":""},_PCcb=function(a){window._checkChatAvailableDeferred.resolve({available:1==a.a,reason:GetReasonFromResponse(a.r)}),window._checkChatAvailableDeferred=null},!function(a,b){var c=b._;this.templates=this.templates||{},this.templates.ChatConnecting=function(a){var b="";return c.escape,b+='<div class="spinnerContainer" style="height: 200px;"></div>'},this.templates.ClosedMessage=function(a){var b,d="",e=c.escape,f=(Array.prototype.join,a.getResource("button_cta_url")),g=new RegExp("(https|http)://");return f=0!=f.search(g)?"http://"+f:f,d+='<p class="purechat-message-note" data-resourcekey="closed_message">'+e(a.getResource("closed_message"))+"</p>",a.AskForRating&&(d+='<div class="purechat-thumbs-container"><p class="purechat-message-note" data-resourcekey="closed_askForRating">'+e(a.getResource("closed_askForRating"))+'</p><div class="purechat-thumbs purechat-thumbs-up purechat-thumbs-selectable pc-icon-thumbs-up"></div><div class="purechat-thumbs purechat-thumbs-down purechat-thumbs-selectable pc-icon-thumbs-down"></div></div><p class="purechat-rating-thanks purechat-message-note"></p>'),a.CtaButton&&(d+='<form class="purechat-form purechat-ended-form" action=""><a href="'+(null==(b=f)?"":b)+'" data-resourcekey="button_cta" class="btn purechat-cta-button '+(null==(b=a.isPersonalChat?"button green":"")?"":b)+'" target="_blank">'+e(a.getResource("button_cta"))+"</a></form>"),a.DownloadTranscript&&(d+='<p class="purechat-download-container purechat-message-note"><a data-resourcekey="closed_downloadTrans" target="_blank" href="'+(null==(b=a.get("pureServerUrl"))?"":b)+"/VisitorWidget/Transcript?chatId="+(null==(b=(a.get("dataController")||a.get("oldDataController")).connectionInfo.get("chatId"))?"":b)+"&authToken="+(null==(b=(a.get("dataController")||a.get("oldDataController")).connectionInfo.get("authToken"))?"":b)+'">'+e(a.getResource("closed_downloadTrans"))+"</a></p>"),d},this.templates.ClosedMessageOperator=function(a){var b,d="",e=c.escape,f=(Array.prototype.join,a.get("room").roomType==PureChat.enums.roomType.operator);if(d+='<script>!function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0];if (!d.getElementById(id)) {js = d.createElement(s);js.id = id;js.src = "https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js, fjs);}}(document, "script", "twitter-wjs");</script><div class="purechat-message-display-container"><div class="purechat-message-display purechat-clearfix"></div></div><div class="purechat-user-status"></div><div class="purechat-send-form-container"><form class="purechat-send-form" action=""><div class="operator-close-actions"><div class="header"><p class="italic">',d+=0==a.closedReasonCode?"This chat was closed by the visitor.":1==a.closedReasonCode?"This chat was closed because the visitor left the page or lost internet connectivity.":2==a.closedReasonCode?"This chat was closed because there was no activity for this conversation in the past hour.":3==a.closedReasonCode?"This chat was closed by an operator.":e(a.getResource("closed_opMessage")),d+='</p><p class="smaller italic">What would you like to do next?</p></div><div class="button-bar">',1!=a.get("room").roomType){var g=a.visitorName&&"Visitor"!=a.visitorName?"%20with%20"+a.visitorName+"!":"!";d+='<a href="https://twitter.com/intent/tweet?original_referer='+(null==(b=escape(pcDashboard.Settings.get("siteRootUrl")))?"":b)+"&text=Just%20had%20a%20great%20chat"+(null==(b=g)?"":b)+'&tw_p=tweetbutton&url=%20&via=PureChat" target="_blank"><i class="pcfont pcfont-twitter-no-border"></i><span class="tip">Share</span></a><a href="#" data-command="exportTranscript" data-command-params="'+(null==(b=a.getExportParams())?"":b)+'"><i class="pcfont pcfont-export"></i><span class="tip">Export</span></a><a href="/Chat/Download/'+(null==(b=a.roomId)?"":b)+'" data-chatid="'+(null==(b=a.roomId)?"":b)+'" target="_blank"><i class="pcfont pcfont-download"></i><span class="tip">Download</span></a><a href="#" data-chatid="'+(null==(b=a.roomId)?"":b)+'" data-command="transcript:email" data-command-params="'+(null==(b=a.roomId)?"":b)+'"><i class="pcfont pcfont-email"></i><span class="tip">Email</span></a>';var h={chatId:a.roomId,visitorIPAddressId:a.visitorIPAddressId,visitorIPAddress:a.visitorIPAddress,performBan:!0},i=escape(JSON.stringify(h));f||a.visitorIPAddressId>-1&&(d+='<a href="#" data-chatid="'+(null==(b=a.roomId)?"":b)+"\" data-request='ban:ip' data-request-params=\""+(null==(b=i)?"":b)+'"><i class="pcfont pcfont-prohibitory"></i><span class="tip">Ban IP</span></a>')}return d+='<a href="#" data-command="removeWidget"><i class="pcfont pcfont-close-chat"></i><span class="tip">Close</span></a></div></div><textarea class="purechat-send-form-message" name="purechat-send-form-message" disabled="disabled"/></form></div>'},this.templates.EmailForm=function(a){var b,d="",e=c.escape;return Array.prototype.join,d+='<div class="purechat-enterinfo-container"><p data-resourcekey="noOperators_email_message">'+(null==(b=purechatApp.Utils.linkify(c.escape(a.getResource("emailForm_message"))))?"":b)+'</p></div><form class="purechat-form purechat-email-form" action=""><p class="alert alert-error init-error general-error" style="display: none;"></p>',a.get("AskForFirstName")&&(d+='<p class="alert alert-error init-error please-enterfirstname" style="display: none;">'+e(a.getResource("error_enterFirstName"))+'</p><input type="text" class="purechat-firstname-input" autocomplete="off" name="purechat-firstname-input" id="purechat-firstname-input" maxlength="40" value="'+e(a.InitialVisitorFirstName)+'" placeholder="'+e(a.getResource("placeholder_firstName"))+'"/>'),
a.get("AskForLastName")&&(d+='<p class="alert alert-error init-error please-enterlastname" style="display: none;">'+e(a.getResource("error_enterLastName"))+'</p><input type="text" class="purechat-lastname-input" autocomplete="off" name="purechat-lastname-input" id="purechat-lastname-input" maxlength="40" value="'+e(a.InitialVisitorLastName)+'" placeholder="'+e(a.getResource("placeholder_lastName"))+'"/>'),d+='<p class="alert alert-error init-error please-enteremail" style="display: none;">'+e(a.getResource("error_enterEmail"))+'</p><input type="email" class="purechat-email-input" name="purechat-email-input" id="purechat-email-input" maxlength="100" value="'+e(a.InitialVisitorEmail)+'" placeholder="'+e(a.getResource("placeholder_email"))+'"/>',a.get("AskForPhoneNumber")&&(d+='<p class="alert alert-error init-error please-enterphonenumber" style="display: none;">'+e(a.getResource("error_enterPhoneNumber"))+'</p><input type="text" class="purechat-phonenumber-input" name="purechat-phonenumber-input" id="purechat-phonenumber-input" maxlength="30" value="'+e(a.InitialVisitorPhoneNumber)+'" placeholder="'+e(a.getResource("placeholder_phonenumber"))+'"/>'),a.get("AskForPhone")&&(d+='<p class="alert alert-error init-error please-enterunavailablephone" style="display: none;">'+e(a.getResource("error_enterPhoneNumber"))+'</p><input type="text" class="purechat-unavailablephone-input" id="purechat-unavailablephone-input" name="purechat-unavailablephone-input" maxlength="30" value="'+e(a.InitialVisitorPhoneNumber)+'" placeholder="'+e(a.getResource("noOperators_placeholder_phone"))+'"/>'),a.get("AskForCompany")&&(d+='<p class="alert alert-error init-error please-entercompany" style="display: none;">'+e(a.getResource("error_enterCompany"))+'</p><input type="text" class="purechat-company-input" name="purechat-company-input" id="purechat-company-input" maxlength="30" value="'+e(a.InitialVisitorCompany)+'" placeholder="'+e(a.getResource("placeholder_company"))+'"/>'),d+='<p class="alert alert-error init-error please-enterquestion" style="display: none;">'+e(a.getResource("error_enterQuestion"))+'</p><textarea class="purechat-question-input" name="purechat-question-input" id="purechat-question-input" rows="3" placeholder="'+e(a.getResource("placeholder_question"))+'">'+e(a.InitialVisitorQuestion)+'</textarea><input type="submit" class="btn" id="purechat-name-submit" value="'+e(a.getResource("button_sendEmail"))+'" style="display: inline;"/><span class="purechat-email-error">An Error Occurred</span></form>'},this.templates.EmailSent=function(a){var b,d="";return c.escape,d+='<div class="purechat-enterinfo-container purechat-email-success"><p>Email Sent!</p><table><tr><td>Name: </td><td>'+(null==(b=a.Name)?"":b)+"</td></tr><tr><td>Email: </td><td>"+(null==(b=a.Email)?"":b)+"</td></tr><tr><td>Question: </td><td>"+(null==(b=a.Question)?"":b)+"</td></tr></table></div>"},this.templates.Empty=function(a){var b="";return c.escape,b+=""},this.templates.MessageList=function(a){var b="",d=c.escape;return Array.prototype.join,b+='<div class="purechat-message-display-container"><div class="showPrevious"><a href="#">See Previous Conversation</a></div><div class="purechat-message-display purechat-clearfix"></div></div><div class="purechat-user-status"></div><div class="purechat-send-form-container"><form class="purechat-send-form" action=""><textarea class="purechat-send-form-message" name="purechat-send-form-message" placeholder="'+d(a.getResource("chat_pressEnter"))+'"></textarea><div class="disableTextArea" style=""/>',a.isMobile()&&(b+='<button type="submit" class="button green send-message">Send</button>'),b+='</form></div><div class="purechat-confirm-close-modal" style="display: none;"><span class="message">Are you sure you want to close the chat?</span><div class="modal-button-bar"><button type="button" class="btn kill-chat">Yes</button><button type="button" class="btn cancel">No</button></div></div><div class="purchat-confirm-close-modal-overlay" style="display: none;"></div>'},this.templates.MessageView=function(a){var b,d="";if(c.escape,Array.prototype.join,"note"==a.type)d+='<p class="purechat-message-note important" data-username="'+(null==(b=a.username)?"":b)+'" data-resourcekey="'+(null==(b=a.resourceKey||"")?"":b)+'">'+(null==(b=a.message)?"":b)+"</p>";else if("separator"==a.type)d+='<p class="purechat-message-note important separator" data-username="'+(null==(b=a.username)?"":b)+'" data-resourcekey="'+(null==(b=a.resourceKey||"")?"":b)+'">'+(null==(b=a.message)?"":b)+"<hr/></p>";else if("message"==a.type&&a.message){var e=purechatApp.Utils.parseEmoticons(a.message);e=purechatApp.Utils.linkify(e),d+='<div data-resourcekey="'+(null==(b=a.resourceKey||"")?"":b)+'" class="purechat-message-container '+(null==(b=a.myMessage?"purechat-message-right":"purechat-message-left")?"":b)+'"><img class="gravitar operator-gravatar '+(null==(b=a.myMessage?"right":"left")?"":b)+'" height="50" width="50" src="'+(null==(b=a.avatarUrl)?"":b)+'" alt="Operator avatar"/><div class="timestamp">',a.time&&(d+='<span class="time">'+(null==(b=a.time.replace(/(\d{1,2}:\d{1,2}):\d{1,2} ([AP]M)/gi,"$1 $2"))?"":b)+"</span>"),d+='</div><div class="purechat-message">',a.userName&&(d+='<span class="purechat-displayname">'+(null==(b=a.userName)?"":b)+'</span><span class="name-message-separator">:</span>'),d+='<span class="purechat-message-actual"><span class="purechat-new-thought">'+(null==(b=e)?"":b)+'</span></span><span class="message-time-separator">-</span></div></div>'}return d},this.templates.PersonalChatDetails=function(a){var b,d="";c.escape,Array.prototype.join,d+='<div class="purechat-personal-avatar-and-details-wrapper"><div class="purechat-personal-avatar"><div class="editor-section hide"></div><div class="content-section">';var e=a.pureServerUrl+"/content/images/Avatars/operator-avatar.png";return null!==a.UserWidgetSettings.get("PersonalAvatarImage")&&/[a-zA-Z1-9]/g.test(a.UserWidgetSettings.get("PersonalAvatarImage").FileId)&&(e=a.pureServerUrl+"/files/download/"+a.UserWidgetSettings.get("PersonalAvatarImage").FileId+"."+a.UserWidgetSettings.get("PersonalAvatarImage").FileExtension),d+='<div class="avatar-image" style="background-image: url(\''+(null==(b=e)?"":b)+"');\"></div>",a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-personal-avatar">Change Personal Avatar<span class="image-dimensions tooltip"><span class="arrow"></span><span class="body">Image will be resized to 200px x 200px after upload.</span></span></a>'),d+='</div></div><div class="purechat-additional-details-container"><div class="purechat-person"><div class="purechat-name"><div class="editor-section"></div><div class="content-section">'+(null==(b=a.UserWidgetSettings.get("DisplayName"))?"":b)+'<div class="purechat-italic">'+(null==(b=a.UserWidgetSettings.get("Company"))?"":b)+"</div>",a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-name"><i class="pcfont pcfont-edit"></i></a>'),d+='</div></div><div class="purechat-social-buttons"><div class="editor-section"></div><div class="content-section">',a.UserWidgetSettings.get("TwitterId")?d+='<a href="https://twitter.com/'+(null==(b=a.UserWidgetSettings.get("TwitterId"))?"":b)+'" target="_blank" class="purechat-twitter" data-tooltiptext="View '+(null==(b=a.UserWidgetSettings.get("DisplayName"))?"":b)+'\'s Twitter profile"><i class="pcfont pcfont-twitter-no-border"></i></a>':a.isInEditorMode&&(d+='<a href="https://twitter.com" target="_blank" class="purechat-twitter faded" data-tooltiptext="Add your Twitter username to allow people to tweet you"><i class="pcfont pcfont-twitter-no-border"></i></a>'),a.UserWidgetSettings.get("FacebookId")?d+='<a href="https://'+(null==(b=a.UserWidgetSettings.get("FacebookId"))?"":b)+'" target="_blank" class="purechat-facebook" data-tooltiptext="View '+(null==(b=a.UserWidgetSettings.get("DisplayName"))?"":b)+'\'s Facebook page"><i class="pcfont pcfont-facebook-no-border"></i></a>':a.isInEditorMode&&(d+='<a href="https://www.facebook.com/" target="_blank" class="purechat-facebook faded" data-tooltiptext="Add your Facebook Id to allow people to post on your wall"><i class="pcfont pcfont-facebook-no-border"></i></a>'),a.UserWidgetSettings.get("LinkedInId")?d+='<a href="https://'+(null==(b=a.UserWidgetSettings.get("LinkedInId"))?"":b)+'" target="_blank" class="purechat-linked-in" data-tooltiptext="View '+(null==(b=a.UserWidgetSettings.get("DisplayName"))?"":b)+'\'s LinkedIn profile"><i class="pcfont pcfont-linked-in-no-border"></i></a>':a.isInEditorMode&&(d+='<a href="https://www.linkedin.com/" target="_blank" class="purechat-linked-in faded" data-tooltiptext="Add your public LinkedIn url to allow people to view your LinkedIn profile"><i class="pcfont pcfont-linked-in-no-border"></i></a>'),a.UserWidgetSettings.get("Email")?d+='<a href="mailto:'+(null==(b=a.UserWidgetSettings.get("Email"))?"":b)+'" target="_blank" class="purechat-send-email" data-tooltiptext="Send email to '+(null==(b=a.UserWidgetSettings.get("Email"))?"":b)+'"><i class="pcfont pcfont-email"></i></a>':a.isInEditorMode&&(d+='<a href="#" target="_blank" class="purechat-linked-in faded" data-tooltiptext="Add an email address to give people another method of contacting you"><i class="pcfont pcfont-email"></i></a>'),a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-social-buttons"><i class="pcfont pcfont-edit"></i></a>'),d+='</div></div></div><div class="purechat-contact-details">',(a.isInEditorMode||a.UserWidgetSettings.get("Website"))&&(d+='<div class="purechat-website"><div class="editor-section"></div><div class="content-section"><a href="'+(null==(b=a.UserWidgetSettings.get("Website")?-1!=a.UserWidgetSettings.get("Website").search("http")?a.UserWidgetSettings.get("Website"):"http://"+a.UserWidgetSettings.get("Website"):"#")?"":b)+'" target="_blank"><i class="pcfont pcfont-website"></i><span class="text">'+(null==(b=a.UserWidgetSettings.get("Website")||'<span class="faded">Enter a website</span>')?"":b)+"</span></a>",a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-website"><i class="pcfont pcfont-edit"></i></a>'),d+="</div></div>"),(a.isInEditorMode||a.UserWidgetSettings.get("PhoneNumber"))&&(d+='<div class="purechat-phone personal"><div class="editor-section"></div><div class="content-section"><a title="Personal" href="tel:'+(null==(b=a.UserWidgetSettings.get("PhoneNumber"))?"":b)+'" target="_blank"><i class="pcfont pcfont-mobile"></i><span class="text">'+(null==(b=a.UserWidgetSettings.get("PhoneNumber")||'<span class="faded">Enter a phone number</span>')?"":b)+"</span></a>",a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-phone"><i class="pcfont pcfont-edit"></i></a>'),d+="</div></div>"),(a.isInEditorMode||a.UserWidgetSettings.get("Location"))&&(d+='<div class="purechat-location"><div class="editor-section"></div><div class="content-section"><!--<div class="purechat-personal-google-map-container" style="width: 100%; height: 200px;"></div>--><a title="Work" href="https://maps.google.com?q='+(null==(b=a.UserWidgetSettings.get("Location"))?"":b)+'&zoom=12" target="_blank"><i class="pcfont pcfont-location"></i><span class="text">'+(null==(b=a.UserWidgetSettings.get("Location")||'<span class="faded">Enter a location</span>')?"":b)+"</span></a>",a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-location"><i class="pcfont pcfont-edit"></i></a>'),d+="</div></div>"),d+='</div><div class="purechat-bio">',(a.isInEditorMode||a.UserWidgetSettings.get("Bio"))&&(d+='<div class="purechat-bio-text"><div class="editor-section"></div><div class="content-section">'+(null==(b=(a.UserWidgetSettings.get("Bio")||'<span class="faded">Add additional information</span>').replace(/\n/g,"<br/>"))?"":b),a.isInEditorMode&&(d+='<a class="purechat-edit-button" data-editorfor=".purechat-bio"><i class="pcfont pcfont-edit"></i></a>'),d+="</div></div>"),d+="</div></div></div>",a.RequestFromMobileDevice&&(d+='<div class="purechat-start-chat-button-container"><button type="button" class="button green start-chat">Start Chat</button></div>'),d},this.templates.Spinner=function(a){var b="";return c.escape,b+='<div class="purechat-spinner"></div>'},this.templates.StartChatForm=function(a){var b,d="",e=c.escape;return Array.prototype.join,a.EmailForm?d+='<div class="purechat-enterinfo-container"><p data-resourcekey="emailForm_message">'+(null==(b=purechatApp.Utils.linkify(c.escape(a.getResource("emailForm_message"))))?"":b)+"</p></div>":(a.AskForPhoneNumber||a.AskForFirstName||a.AskForLastName||a.AskForCompany||a.AskForEmail||a.AskForQuestion)&&(d+='<div class="purechat-enterinfo-container"><p data-resourcekey="label_initial">'+(null==(b=purechatApp.Utils.linkify(a.getResource("label_initial")))?"":b)+"</p></div>"),d+='<form class="purechat-form '+(null==(b=a.EmailForm?"purechat-email-form":"purechat-init-form")?"":b)+'" action=""><p class="alert alert-error init-error init-error-inline general-error" style="display: none;"></p>',a.AskForFirstName&&(d+='<p class="alert alert-error init-error init-error-inline please-enterfirstname" style="display: none;">'+e(a.getResource("error_enterFirstName"))+'</p><input type="text" class="purechat-firstname-input" autocomplete="off" name="purechat-firstname-input" id="purechat-firstname-input" maxlength="40" value="'+e(a.InitialVisitorFirstName)+'" placeholder="'+e(a.getResource("placeholder_firstName"))+'" required/>'),a.AskForLastName&&(d+='<p class="alert alert-error init-error init-error-inline please-enterlastname" style="display: none;">'+e(a.getResource("error_enterLastName"))+'</p><input type="text" class="purechat-lastname-input" autocomplete="off" name="purechat-lastname-input" id="purechat-lastname-input" maxlength="40" value="'+e(a.InitialVisitorLastName)+'" placeholder="'+e(a.getResource("placeholder_lastName"))+'" required/>'),a.AskForEmail&&(d+='<p class="alert alert-error init-error init-error-inline please-enteremail" style="display: none;">'+e(a.getResource("error_enterEmail"))+'</p><input type="email" class="purechat-email-input" name="purechat-email-input" id="purechat-email-input" maxlength="100" value="'+e(a.InitialVisitorEmail)+'" placeholder="'+e(a.getResource("placeholder_email"))+'" required/>'),a.AskForPhoneNumber&&(d+='<p class="alert alert-error init-error init-error-inline please-enterphonenumber" style="display: none;">'+e(a.getResource("error_enterPhoneNumber"))+'</p><input type="text" class="purechat-phonenumber-input" name="purechat-phonenumber-input" id="purechat-phonenumber-input" maxlength="30" value="'+e(a.InitialVisitorPhoneNumber)+'" placeholder="'+e(a.getResource("placeholder_phonenumber"))+'" required/>'),a.EmailForm&&a.UnavailableAskForPhone&&(d+='<p class="alert alert-error init-error init-error-inline please-enterunavailablephone" style="display: none;">'+e(a.getResource("error_enterPhoneNumber"))+'</p><input type="text" class="purechat-unavailablephone-input" id="purechat-unavailablephone-input" name="purechat-unavailablephone-input" maxlength="30" value="'+e(a.InitialVisitorPhoneNumber)+'" placeholder="'+e(a.getResource("noOperators_placeholder_phone"))+'" required/>'),a.AskForCompany&&(d+='<p class="alert alert-error init-error init-error-inline please-entercompany" style="display: none;">'+e(a.getResource("error_enterCompany"))+'</p><input type="text" class="purechat-company-input" name="purechat-company-input" id="purechat-company-input" maxlength="100" value="'+e(a.InitialVisitorCompany)+'" placeholder="'+e(a.getResource("placeholder_company"))+'" required/>'),a.AskForQuestion&&(d+='<p class="alert alert-error init-error init-error-inline please-enterquestion" style="display: none;">'+e(a.getResource("error_enterQuestion"))+'</p><textarea class="purechat-question-input" name="purechat-question-input" id="purechat-question-input" rows="3" placeholder="'+e(a.getResource("placeholder_question"))+'" required>'+e(a.InitialVisitorQuestion)+"</textarea>"),d+=a.EmailForm?'<input type="submit" class="btn" id="purechat-name-submit" value="'+e(a.getResource("button_sendEmail"))+'" style="'+(null==(b=a.AskForFirstName||a.AskForLastName||a.AskForCompany||a.AskForQuestion||a.AskForEmail?"":"margin-top: 20px !important;")?"":b)+'display: inline"><span class="purechat-email-error">An Error Occurred</span>':'<input type="submit" class="btn" id="purechat-name-submit" value="'+e(a.getResource("button_startChat"))+'" style="'+(null==(b=a.AskForFirstName||a.AskForLastName||a.AskForCompany||a.AskForQuestion||a.AskForEmail?"":"margin-top: 20px !important;")?"":b)+'">',d+="</form>"},this.templates.StartChatFormAutomatically=function(a){var b,d="",e=c.escape;return Array.prototype.join,d+='<div class="purechat-widget-content '+(null==(b=a.isMobile()?"mobile fake-chat":"")?"":b)+'" style=""><div class="message-list-view"><div class="purechat-message-display-container"><div class="purechat-message-display purechat-clearfix"><div class="purechat-message-wrapper purechat-clearfix"><div data-resourcekey="" class="purechat-message-container purechat-message-left">',(a.isPersonalChat()||a.isMobile())&&(d+='<img class="gravitar operator-gravatar left" height="50" width="50" src="'+(null==(b=a.personalAvatarUrl())?"":b)+'" alt="Operator avatar"/>'),d+='<div class="timestamp"><span class="time">&nbsp;</span></div><div class="purechat-message" style="margin-right: 0;"><span class="name-message-separator">:</span><span class="purechat-message-actual"><span class="purechat-new-thought">'+e(a.getResource("chat_startedMessage"))+'</span></span><span class="message-time-separator" style="display: none;">-</span></div></div></div></div></div><div class="purechat-user-status"></div><div class="purechat-send-form-container"><form class="purechat-send-form purechat-form" action=""><p class="alert alert-error init-error general-error" style="display: none;"></p><textarea class="purechat-send-form-message purechat-question-input" placeholder="'+e(a.getResource("chat_pressEnter"))+'" name="purechat-question-input" id="purechat-question-input" rows="3">'+(null==(b=a.InitialVisitorQuestion)?"":b)+"</textarea>",a.isMobile()&&(d+='<button type="submit" class="button green send-message">Send</button>'),d+='</form></div><div class="purechat-confirm-close-modal" style="display: none;"><span class="message">Are you sure you want to close the chat?</span><div class="modal-button-bar"><button type="button" class="btn kill-chat">Yes</button><button type="button" class="btn cancel">No</button></div></div></div></div>'},this.templates.UnsupportedBrowser=function(a){var b="";return c.escape,b+='<p class="purechat-message-note purechat-unitalic">Sorry, but it appears that you are using a browser that is incompatible with Pure Chat\'s technology. <i class="emoticon emote-sad"></i></p><p class="purechat-message-note purechat-unitalic">In order to use Pure Chat\'s live chat capabilities, please upgrade your browser to a newer version, or use one of these recommended alternative browsers:<ul><li><a href="https://www.google.com/chrome" target="_blank">Google Chrome</a></li><li><a href="https://www.mozilla.org/firefox/new" target="_blank">Mozilla Firefox</a></li></ul></p>'},this.templates.Widget=function(a){var b,d="",e=c.escape,f=(Array.prototype.join,a.get("RequestFromMobileDevice")&&a.get("AllowWidgetOnMobile")&&!a.isDesktopDimension()),g=a.get("RequestFromMobileDevice"),h=a.get("isPersonalChat");return d+='<div class="purechat-expanded"><div class="purechat-collapsed-outer"><div class="purechat-widget-inner purechat-clearfix">',a.get("isPersonalChat")&&(d+='<div class="purechat-personal-details-container '+(null==(b=a.get("isInEditorMode")?"personal-editor-active":"")?"":b)+'"></div>'),d+='<div class="'+(null==(b=a.get("isPersonalChat")?"purechat-personal-widget-content-wrapper":"purechat-widget-content-wrapper")?"":b)+'"><div class="purechat-widget-header" data-trigger="collapse">',d+=h?'<div class="purechat-menu btn-toolbar"><button data-trigger="restartChat" class="btn btn-mini btn-restart" title="Start a new chat" style="display: none;"><i class="pc-icon-repeat" title="Start a new chat"></i></button><button data-trigger="closeChat" class="btn btn-mini btn-close" title="Close chat session" style="display: none;"><i class="pc-icon-remove"></i></button></div>':'<div class="purechat-menu btn-toolbar"><button data-trigger="restartChat" class="btn btn-mini btn-restart" title="Start a new chat" style="display: inline-block;"><i class="pc-icon-repeat" title="Start a new chat"></i></button><button data-trigger="popOutChat" class="btn btn-mini btn-pop-out" title="Pop out" style="display: inline-block;"><i class="pc-icon-share"></i></button><button data-trigger="expand" class="btn btn-mini actions btn-expand" title="Expand Widget" style="display: inline-block;"><i class="pc-icon-plus"></i></button><button data-trigger="collapse" class="btn btn-mini actions btn-collapse" title="Collapse Widget" style="display: inline-block;"><i class="pc-icon-minus"></i></button><button data-trigger="closeChat" class="btn btn-mini btn-close" title="Close chat session" style="display: inline-block;"><i class="pc-icon-remove"></i></button></div>',d+='<div class="purechat-widget-title">',h&&f&&(d+='<a class="purechat-show-personal-details" href="#"><i class="fa fa-chevron-left"></i></a>'),d+='&nbsp;<span class="purechat-widget-room-avatar" style="display: none;"></span><span class="purechat-widget-title-link"></span></div></div><div class="purechat-content-wrapper purechat-clearfix"><div class="purechat-content"></div>',a.get("RemoveBranding")?a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'):h?(d+='<div class="purechat-poweredby-container"><div class="purechat-poweredby"><span>'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'">Pure Chat</a></div></div>',a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>')):f?(d+='<div style="display: block; width: 100% !important; font-size: 10px !important; margin-bottom: 10px !important; position: absolute !important; bottom: 0 !important; left: 0 !important;"><span style="font-size: 10px !important;">'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'" style="font-size: 10px !important;">Pure Chat</a>',a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'),d+="</div>"):(d+='<div style="display: block; font-size: 10px !important; margin-bottom: 10px !important; padding-right: 10px !important;"><span style="font-size: 10px !important;">'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'" style="font-size: 10px !important; text-decoration: underline !important;">Pure Chat</a>',a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'),d+="</div>"),d+='</div></div></div></div></div><div class="purechat-button-expand purechat-collapsed '+(null==(b=a.get("CollapsedWidgetImageUrl")?"purechat-collapsed-image":"purechat-collapsed-default")?"":b)+'"><div class="purechat-collapsed-outer" data-trigger="expand" style="display: '+(null==(b=a.showTab()?"none":"block")?"":b)+'"><div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-header">',f&&(d+='<button type="button" class="purechat-expand-mobile-button">'+e(a.getResource("mobile_expandButton"))+"</button>"),d+='<div class="purechat-menu btn-toolbar">',f||g||a.get("isDirectAccess")||!a.get("ShowMinimizeWidgetButton")||(d+='<button type="button" data-trigger="superMinimize" class="btn btn-mini actions purechat-super-minimize-link-button" style="display: none;"><i class="pc-icon-caret-down"></i></button>'),d+='<button data-trigger="expand" class="btn btn-mini actions btn-expand" title="Expand Widget" style="display: inline-block;"><i class="pc-icon-plus"></i></button><button data-trigger="collapse" class="btn btn-mini actions btn-collapse" title="Collapse Widget" style="display: inline-block;"><i class="pc-icon-minus"></i></button></div><div class="purechat-widget-title">',h&&f&&(d+='<a class="purechat-show-personal-details" href="#"><i class="fa fa-chevron-left"></i></a>'),d+='&nbsp;<span class="purechat-widget-room-avatar" style="display: none;"></span><span class="purechat-widget-title-link">'+e(a.getResource("title_initial"))+'</span></div></div></div></div></div><div class="purechat-mobile-overlay hide"></div>'},this.templates.WidgetDirectAccess=function(a){var b,d="",e=c.escape;return Array.prototype.join,d+='<div class="purechat-expanded"><div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-header"><div class="purechat-menu btn-toolbar"><button data-trigger="restartChat" class="btn btn-mini btn-restart" title="Start a new chat"><i class="pc-icon-repeat" title="Start a new chat"></i></button><button data-trigger="closeChat" class="btn btn-mini btn-close" title="Close chat session"><i class="pc-icon-remove"></i></button></div><div class="purechat-widget-title"><span class="purechat-widget-room-avatar" style="display: none;"></span><span class="purechat-widget-title-link"></span></div></div><div class="purechat-content-wrapper purechat-clearfix"><div class="purechat-content"></div>',a.get("RemoveBranding")||(d+='<div class="purechat-poweredby-container"><span class="purechat-poweredby">'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'">Pure Chat</a></div>'),a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left '+(null==(b=a.get("RemoveBranding")?"kill-positioning":"")?"":b)+'"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'),d+="</div></div></div>"},this.templates.WidgetDirectAccessMobile=function(a){var b,d="",e=c.escape;return Array.prototype.join,d+='<div class="purechat-expanded"><div class="purechat-collapsed-outer"><div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-content-wrapper"><div class="purechat-widget-header"><div class="purechat-menu btn-toolbar"><button data-trigger="restartChat" class="btn btn-mini btn-restart" title="Start a new chat"><i class="pc-icon-repeat" title="Start a new chat"></i></button><button data-trigger="closeChat" class="btn btn-mini btn-close" title="Close chat session"><i class="pc-icon-remove"></i></button></div><div class="purechat-widget-title"><span class="purechat-widget-room-avatar" style="display: none;"></span><span class="purechat-widget-title-link"></span></div></div><div class="purechat-content-wrapper"><div class="purechat-content"></div>',a.get("RemoveBranding")||(d+='<div class="purechat-poweredby-container"><span class="purechat-poweredby">'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'">PureChat</a></div>'),a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'),d+="</div></div></div></div></div>"},this.templates.WidgetOperator=function(a){var b="";return c.escape,Array.prototype.join,b+='<div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-header"><div class="menu btn-toolbar"><span data-trigger="cannedResponses" class="purechat-canned-responses btn-group"><a class="dropdown-toggle btn" data-toggle="dropdown" data-ajax="false">&nbsp;<i class="icon-ellipsis-horizontal icon-white"></i>&nbsp;</a><ul class="dropdown-menu bottom-up"></ul></span>',b+=a.attributes.isInvisible?'<button data-trigger="requeueChat" class="btn btn-mini requeue-button"><i class="fa fa-reply"></i><span class="text">Leave</span></button><button data-trigger="removeWidget" class="btn btn-mini closewidget-button"><span class="text">Done</span></button>':'<button data-trigger="exportToOntime" class="btn btn-mini leave-button"><span class="text">Export</span></button><button data-trigger="requeueChat" class="btn btn-mini requeue-button"><i class="fa fa-reply"></i><span class="text">Requeue</span></button><button data-trigger="removeWidget" class="btn btn-mini closewidget-button"><span class="text">Done</span></button><button data-trigger="closeChat" data-trigger-params=\'{"confirmation": "Are you sure you want to close this chat?"}\' class="btn btn-mini requeue close-button"><span class="text">End Chat</span></button>',b+='</div><div class="purechat-widget-title"><a class="purechat-widget-title-link"></a></div></div><div class="purechat-chat-info"></div><div class="purechat-content"></div><div class="purechat-poweredby-container"></div></div>'},this.templates.WidgetPoppedOut=function(a){var b,d="",e=c.escape;return Array.prototype.join,d+='<div class="purechat-window purechat-expanded"><div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-header"><div class="purechat-menu btn-toolbar"><button data-trigger="restartChat" class="btn btn-mini btn-restart" title="Start a new chat"><i class="pc-icon-repeat" title="Start a new chat"></i></button><button data-trigger="closeChat" class="btn btn-mini btn-close" title="Close chat session"><i class="pc-icon-remove"></i></button></div><div class="purechat-widget-title">',d+=a.get("RequestFromMobileDevice")&&a.get("AllowWidgetOnMobile")?'<span class="purechat-widget-title-link">PureChat</span>':'<span class="purechat-widget-title-link">PureChat</span>&nbsp;<span class="purechat-widget-room-avatar" style="display: none;"></span>',d+='</div></div><div class="purechat-content-wrapper"><div class="purechat-content"></div>',a.get("RemoveBranding")||(d+='<div class="purechat-poweredby-container"><span class="purechat-poweredby">'+e(a.getResource("poweredby"))+' </span><a target="_blank" href="'+(null==(b=a.poweredByUrl())?"":b)+'">Pure Chat</a></div>'),a.showPlaySoundCheckbox()&&(d+='<a href="#" class="purechat-toggle-audio-notifications purechat-bottom-left"><i class="fa '+(null==(b=a.playSoundOnNewMessage()?"pc-icon-unmute":"pc-icon-mute")?"":b)+'"></i></a>'),d+='</div></div></div><div class="purechat-widget purechat-collapsed">',d+=a.get("CollapsedWidgetImageUrl")?'<img src="'+(null==(b=a.get("CollapsedWidgetImageUrl"))?"":b)+'" data-trigger="expand"/>':'<div class="purechat-widget-inner purechat-clearfix"><div class="purechat-widget-header"><div class="purechat-menu btn-toolbar"><button data-trigger="expand" class="btn btn-mini actions btn-expand" title="Expand Widget"><i class="pc-icon-plus"></i></button><button data-trigger="collapse" class="btn btn-mini actions btn-collapse" title="Collapse Widget"><i class="pc-icon-minus"></i></button></div><div class="purechat-widget-title"><span class="purechat-widget-title-link">PureChat</span></div></div></div>',d+="</div>"},b["true"]=a}({},function(){return this}()),purechatApp.module("Models",function(a,b,c,d,e,f){function g(a){return e("<div/>").html(a).text()}a.Chat=c.RelationalModel.extend({defaults:function(){return{participants:new a.ChatParticipantCollection}},relations:[{type:c.HasMany,key:"messages",relatedModel:"Message",collectionType:"MessageCollection",reverseRelation:{key:"chat"}},{type:c.HasMany,key:"operators",relatedModel:"Operator",collectionType:"OperatorCollection",reverseRelation:{key:"chat"}},{type:c.HasMany,key:"participants",
relatedModel:"ChatParticipant",collectionType:"ChatParticipantCollection",reverseRelation:{key:"chat"}}],getFullName:function(){var a,b=this.get("visitorFirstName"),c=this.get("visitorLastName");return b?(a=b,c&&(a+=" "+c)):c&&(a=c),a||(a="Visitor"),a},restartChat:function(){this.set("visitorQuestion",null),this.get("operators").reset(),this.get("messages").reset(),this.set("state",b.Constants.WidgetStates.Inactive),this.trigger("chat:restart")},chatUserNames:function(){var a="";return this.get("operators").forEach(function(b){""!=a&&(a+=", "),a+=b.get("userDisplayName")}),a},isInChat:function(){return this.get("userId")&&this.get("chatId")&&this.get("authToken")},initialize:function(){var a=this;this.get("operators").on("add",function(b){a.trigger("operator:join",b)}).on("remove",function(b){a.trigger("operator:leave",b)})}}),a.Message=c.RelationalModel.extend({events:{"change:messageResource":function(){alert("test")}}}),a.MessageCollectionMessagesGrouped=c.Collection.extend({initialize:function(a,c){var d=this;this.proxy=c.collection,this.listenTo(this.proxy,"add",function(a,c,e){a.set("message",b.Utils.formatWhitespace(a.get("message")));var f=a.toJSON(),g=null;c.every(function(b){if(b.cid==a.cid){if(null==g||"message"!=g.get("type")||"message"!=b.get("type")||g.get("userId")!=b.get("userId")){var c=d.add(f);return a.set("relatedCid",c.cid),!1}var e=d.get(g.get("relatedCid"));if(e){var h=e.get("message");h=h+" <div class='purechat-line-break'></div> "+b.get("message"),e.set("message",h),e.set("time",b.get("time")),a.set("relatedCid",g.get("relatedCid"))}}return g=b,!0})})},comparator:function(a,b){var c=a.get("date").getTime()-b.get("date").getTime();return 0==c?a.cid<b.cid?-1:1:c}}),a.MessageCollection=c.Collection.extend({model:a.Message,add:function(a,b){if(a){var d=f.isArray(a)?a:[a];d.forEach(function(a){a.timeAdded=(new Date).getTime()})}return c.Collection.prototype.add.apply(this,arguments)},comparator:function(a,b){var c=a.get("date").getTime()-b.get("date").getTime();return 0==c?a.cid<b.cid?-1:1:c}}),a.Operator=c.RelationalModel.extend({idAttribute:"userId"}),a.OperatorCollection=c.Collection.extend({model:a.Operator}),a.ChatParticipant=c.RelationalModel.extend({idAttribute:"userId"}),a.ChatParticipantCollection=c.Collection.extend({model:a.ChatParticipant,getOperatorTypingText:function(a){var b=this.where({isTyping:!0});if(b&&0!==b.length){var c="";return f.each(b,function(b,d){0!=d&&(c+=", ");var h=e.trim(b.get("displayName"));c="<span data-resourcekey='chat_typing'>"+g(c+f.escape(a.getResource("chat_typing",{displayName:h})))+"...</span>"}),c}return""}}),a.WidgetSettings=c.RelationalModel.extend({getResource:function(a,b){var c=this.get("StringResources");if(!c)return a;if(b){var d=c[a]||"";return d+="",b.displayName||(d=d.replace("{displayName}","")),b.chatUserNames||(d=d.replace("{chatUserNames}","")),self.compiledResources||(self.compiledResources={}),self.compiledResources[d]||(self.compiledResources[d]=m.template(d,null,{interpolate:/\{(.+?)\}/g})),self.compiledResources[d](b)}return c[a]},isTabTop:function(){return 3==this.get("Position")||4==this.get("Position")},isTabLeft:function(){return 1==this.get("Position")||3==this.get("Position")},_isDesktopDimension:null,isDesktopDimension:function(){if(!this._isDesktopDimension){var a=e(window).height(),b=e(window).width(),c=625,d=625;this._isDesktopDimension=a>=c&&b>=d}return this._isDesktopDimension},isMobileRequest:function(){return this.get("RequestFromMobileDevice")},isAllowedOnMobile:function(){return this.get("AllowWidgetOnMobile")||this.get("Demo")},useMobile:function(){return this.isMobileRequest()&&this.isAllowedOnMobile()},showTab:function(){var a=this.useMobile(),c=this.isDesktopDimension();return this.get("CollapsedStyle")==b.Constants.WidgetType.Tab||this.get("CollapsedStyle")==b.Constants.WidgetType.ImageTab||a&&!c&&this.get("CollapsedStyle")!=b.Constants.WidgetType.Button},showImage:function(){return this.get("CollapsedStyle")==b.Constants.WidgetType.Image||this.get("CollapsedStyle")==b.Constants.WidgetType.ImageTab},collapsedImageCss:function(a){var b=a?this.get("AvailableImageScale"):this.get("UnavailableImageScale"),c=b/100,d=(a?this.get("AvailableImageWidth"):this.get("UnavailableImageWidth"))*c,e=(a?this.get("AvailableImageHeight"):this.get("UnavailableImageHeight"))*c,f=0,g=a?this.get("AvailableImageYOffset"):this.get("UnavailableImageYOffset");this.isTabTop()?(f=this.showTab()?60:0,f+=g||0):(f=-(e+(g||0)),this.showTab()||(f-=10));var h=a?this.get("AvailableImageWidth"):this.get("UnavailableImageWidth"),i=(a?this.get("AvailableImageHeight"):this.get("UnavailableImageHeight"),a?this.get("AvailableImageTop"):this.get("UnavailableImageTop")),j=["position:absolute;","margin-top: "+f+"px;","width: "+h*c+"px;","max-width: "+h*c+"px;","top: 0px;","z-index: "+(i?2:0)+";"],k=a?this.get("AvailableImageXOffset"):this.get("UnavailableImageXOffset");this.showTab()?(j.push("left: 50%;"),j.push("margin-left: "+-(d/2-(k||0))+"px;")):this.isTabLeft()?(j.push("left: 50%;"),j.push("margin-left: "+(k||0)+"px;")):(j.push("right: 50%;"),j.push("margin-right: "+-(k||0)+"px;"));var l=j.join("");return l},poweredByUrl:function(){return"http://www.purechat.com?utm_source="+encodeURIComponent(location.hostname)+"&utm_medium=widget&utm_campaign=poweredby"},absoluteCollapsedImageUrl:function(a){return a?this.absoluteUrl(this.get("AvailableCollapsedWidgetImageUrl")):this.absoluteUrl(this.get("UnavailableCollapsedWidgetImageUrl"))},absoluteUrl:function(a){a=(a||"").trim();var b=0==a.indexOf("~");return 1==a.length&&b?null:b?this.get("cdnServerUrl")+a.substring(1):a},formatDateTime:function(a){var b=new Date(a),c=b.getMonth()+1+"/"+b.getDate()+"/"+b.getFullYear();return c+=" "+(b.getHours()%12==0?"12":b.getHours()%12)+":"+(b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes())+(b.getHours()>=12?"PM":"AM")},browserIsUnsupported:function(){var a=!1,b=this.get("BrowserDetails");switch(b.Version=parseFloat(b.Version),b.Browser.toLowerCase().replace(/s+/g,"")){case"internetexplorer":case"ie":b.Version<=9&&(a=!0);break;case"safari":b.Version<5&&(a=!0);break;case"opera":b.Version<12&&(a=!0)}return a}}),a.WidgetSettingsCollection=c.Collection.extend({model:a.WidgetSettings}),a.ChatConnection=c.Model.extend({defaults:{chatClosed:!1},initialize:function(a,b){var c=this;b.isOperator||b.poppedOut||setInterval(function(){c.loadFromLocalStorage()},2e3),this.listenTo(this,"change:userId, change:authToken, change:chatClosed",function(){this.trigger("change:isInChat",this,this.isInChat())})},persistedKeys:["userId","authToken","roomId","chatId","visitorName","disabled","chatActiveInOtherWindow","chatClosed","expandSource"],persistLocalStorage:function(){var a=this;return f.each(a.persistedKeys,function(b){void 0!=a.get(b)&&(localStorage[b]=a.get(b))}),a},clearLocalStorage:function(){var a=this;return f.each(a.persistedKeys,function(a){delete localStorage[a]}),this.clear(),a},loadFromLocalStorage:function(){var a=this;return f.each(a.persistedKeys,function(b){a.set(b,localStorage[b])}),a},isInChat:function(){return this.get("userId")&&this.get("authToken")&&(f.isUndefined(this.get("chatClosed"))||"false"==this.get("chatClosed")||!this.get("chatClosed"))}})}),Backbone.View.prototype.getResource=function(a,b){return o.getOption(this,"rm").getResource(a,m.defaults(b||{},{chatUserNames:""}))},Marionette.View.prototype.mixinTemplateHelpers=function(a){a=a||{};var b=this.templateHelpers||{};return m.isFunction(b)&&(b=b.call(this)),a.getResource=m.bind(n.View.prototype.getResource,this),m.extend(a,b)},Marionette.Renderer.render=function(a,b){var c=purechatApp.templates||templates;"string"==typeof a&&c[a]&&(a=c[a]);var d="function"==typeof a?a:Marionette.TemplateCache.get(a),e=d(b);return e.trim()},purechatApp.module("Views",function(a,b,c,d,e,f,g){var j=new b.Utils.Notifier;a.Spinner=d.ItemView.extend({template:"Spinner",className:"purechat-spinner-wrapper"}),a.WidgetLayout=d.LayoutView.extend({template:null,className:"purechat",optionsStepShown:!1,maxWidth:700,_audioNotificationLocalStorageKey:"_purechatVisitorWidgetPlaySound",regions:{content:".purechat-content",personalDetails:".purechat-personal-details-container"},events:{"click [data-trigger]":"executeCommand",mouseenter:"peekWidget",mouseleave:"unpeekWidget","click .purechat-show-personal-details":"showPersonalDetailsOnMobile","click .purechat-toggle-audio-notifications":"updatePlayAudioLocalStorage"},childEvents:{roomHostChanged:function(a,b){this.showRoomHostAvatar(b.get("roomHostAvatarUrl"),b.get("expanded"))}},modelEvents:{"change:operatorsAvailable":"operatorsAvailableChanged","api:change":"apiRoomDetailsChanged"},ui:{content:".purechat-content",purechatCollapsed:".purechat-collapsed",collapsedTabWrapper:".purechat-collapsed .purechat-collapsed-outer",titleWrapper:".purechat-collapsed .purechat-widget-title",title:".purechat-expanded .purechat-widget-title-link",collapsedTitle:".purechat-collapsed .purechat-widget-title-link",popoutButton:'[data-trigger="popOutChat"]',closeButton:'[data-trigger="closeChat"]',removeWidgetButton:'[data-trigger="removeWidget"]',restartButton:'[data-trigger="restartChat"]',requeueButton:'[data-trigger="requeueChat"]',leaveButton:'[data-trigger="leaveChat"]',widgetCollapsed:".purechat-collapsed",widgetExpanded:".purechat-expanded",collapseImage:".collapsed-image",personalDetails:".purechat-personal-details-container",expandMobileButton:".purechat-expand-mobile-button",menuBar:".purechat-collapsed .purechat-menu",poweredBy:".purechat-content-wrapper div:last-child",poweredByHosted:".purechat-poweredby-container",roomAvatarUrl:".purechat-widget-room-avatar",purechatTitleImage:".purechat-title-image",superMinimizeButton:".purechat-super-minimize-link-button"},templateHelpers:function(){var a=this;return e.extend({isDesktopDimension:function(){return a.options.viewController.isDesktopDimension()}},this.settings)},apiRoomDetailsChanged:function(a,b,c){this.options.viewController.apiRoomDetailsChanged(a,b,c)},updatePlayAudioLocalStorage:function(a){var b=e(a.currentTarget),c=b.find("i");return c.hasClass("pc-icon-unmute")?(localStorage[this._audioNotificationLocalStorageKey]=!1,c.removeClass("pc-icon-unmute").addClass("pc-icon-mute")):(localStorage[this._audioNotificationLocalStorageKey]=!0,c.addClass("pc-icon-unmute").removeClass("pc-icon-mute")),!1},hideRoomHostAvatar:function(){this.ui.roomAvatarUrl.removeAttr("style").hide(),this.ui.title.removeClass("purechat-has-room-avatar"),this.ui.purechatTitleImage.show(),(this.$el.hasClass("purechat-top")||this.settings.get("poppedOut"))&&this.$el.removeClass("purechat-adjust-for-avatar")},showRoomHostAvatar:function(a,b){"undefined"!=typeof b&&(a&&b?(this.ui.roomAvatarUrl.css({"background-image":"url("+a+")"}).show(),this.ui.title.addClass("purechat-has-room-avatar"),this.ui.purechatTitleImage.hide(),(this.$el.hasClass("purechat-top")||this.settings.get("poppedOut"))&&this.$el.addClass("purechat-adjust-for-avatar")):this.hideRoomHostAvatar())},updateRoomHostName:function(a){a?this.setTitle(this.getResource("chat_nowChattingWith",{chatUserNames:[a]}),"chat_nowChattingWith"):this.setTitle(this.getResource("title_initial"),null,"title_initial")},showPersonalDetailsOnMobile:function(){var a=this;return this.$el.find(".purechat-personal-details-container").removeClass("purechat-hide"),setTimeout(function(){a.$el.find(".purechat-personal-details-container").css({left:0})},10),!1},resetPoweredBy:function(){var a=this.settings.useMobile()&&!this.settings.isDesktopDimension();this.settings.get("RemoveBranding")||this.settings.get("isOperator")||a||(this.ui.poweredBy.html(this._originalPoweredBy),this.ui.poweredByHosted.html(this._originalPoweredBy),this.settings.get("isPersonalChat")||(this.ui.poweredBy.css({"text-align":"right"}),this.ui.poweredByHosted.css({"text-align":"right"})))},updatePoweredBy:function(a){var b=this.settings.useMobile()&&!this.settings.isDesktopDimension();this.settings.get("isOperator")||!a||this.settings.get("RemoveBranding")||b||(this.ui.poweredBy.html(a),this.ui.poweredByHosted.html(a),this.settings.get("isPersonalChat")||(this.ui.poweredBy.css({"text-align":"center"}),this.ui.poweredByHosted.css({"text-align":"center"})))},showSpinner:function(b){if(!b)throw new Error("No jquery element was specified when trying to create a Pure Chat spinner");b="function"==typeof b.data?b:e(b);var c=new a.Spinner;c.render(),c.$el.appendTo(b),b.data("purechatSpinner",c)},hideSpinner:function(a){if(!a)throw new Error("No jquery element was specified when trying to create a Pure Chat spinner");a="function"==typeof a.data?a:e(a);var b=a.data("purechatSpinner");b&&b.destroy(),a.removeData("purechatSpinner")},bindAppCommands:function(){var a=this;try{b.commands.removeHandler("poweredby:update"),b.commands.removeHandler("poweredby:reset"),b.commands.removehandler("spinner:show"),b.commands.removehandler("spinner:hide")}catch(c){}finally{b.commands.setHandler("poweredby:update",function(){a.updatePoweredBy.apply(a,arguments)}),b.commands.setHandler("poweredby:reset",function(){a.resetPoweredBy.apply(a,arguments)}),b.commands.setHandler("spinner:show",function(){a.showSpinner.apply(a,arguments)}),b.commands.setHandler("spinner:hide",function(){a.hideSpinner.apply(a,arguments)})}},repositionWidget:function(){var a={1:"purechat-bottom purechat-bottom-left",2:"purechat-bottom purechat-bottom-right",3:"purechat-top purechat-top-left",4:"purechat-top purechat-top-right",9999:"purechat-widget-button"};for(var c in a)this.$el.removeClass(a[c]);this.model.get("isPoppedOut")||this.settings.get("isDirectAccess")||(this.settings.get("WidgetType")==b.Constants.WidgetType.Button?this.$el.addClass(a[9999]):this.$el.addClass(a[this.settings.get("Position")]))},chooseWidgetTemplate:function(){var a=this.settings.useMobile(),b=this.settings.isMobileRequest()&&this.settings.get("isPersonalChat");this.settings.get("isDirectAccess")?(a?this.template="WidgetDirectAccessMobile":this.template="WidgetDirectAccess",this.$el.addClass("purechat-widget purechat-hosted-widget")):a&&this.settings.get("isDemo")?this.template="WidgetDirectAccessMobile":this.settings.get("isOperator")?(this.template="WidgetOperator",this.$el.addClass("purechat-operator")):this.settings.get("poppedOut")?(this.template="WidgetPoppedOut",this.$el.addClass("purechat-window purechat-popped-out-widget")):(this.template="Widget",this.$el.addClass("purechat-widget hide"),!a||b||this.settings.isDesktopDimension()||this.$el.removeClass().addClass("purechat-mobile-widget-button"))},showHideMinimizeButton:function(){this.settings.get("ShowMinimizeWidgetButton")?this.ui.superMinimizeButton.show():this.ui.superMinimizeButton.hide()},bindWidgetSettingsChanges:function(){this.listenTo(this.settings,"change",f.bind(this.updateImageTransform,this)),this.listenTo(this.settings,"change:ShowMinimizeWidgetButton",f.bind(this.showHideMinimizeButton,this)),this.listenTo(this.settings,"change:CollapsedStyle",f.bind(this.updateCollapsedStyle,this)),this.listenTo(this.settings,"change:AvailableCollapsedWidgetImageUrl",f.bind(this.updateImageSource,this)),this.listenTo(this.settings,"change:UnavailableCollapsedWidgetImageUrl",f.bind(this.updateImageSource,this)),this.listenTo(this.settings,"change:AvailableImageXOffset",f.bind(this.updateImageTransform,this)),this.listenTo(this.settings,"change:AvailableImageYOffset",f.bind(this.updateImageTransform,this)),this.listenTo(this.settings,"change:UnavailableImageXOffset",f.bind(this.updateImageTransform,this)),this.listenTo(this.settings,"change:UnavailableImageYOffset",f.bind(this.updateImageTransform,this))},getOperatorsAvailable:function(){return"undefined"!=typeof this.model.get("operatorsAvailable")?this.model.get("operatorsAvailable"):!0},updateCollapsedStyle:function(){var a=this.settings.useMobile(),c=this.getOperatorsAvailable()||this.options.widgetSettings.get("UseAvailableImageForBoth"),d=this.settings.absoluteCollapsedImageUrl(c);if(d){var f=' <img class="collapsed-image" src="'+d+'" data-trigger="expand" style="'+this.settings.collapsedImageCss(c)+'" />';this.ui.collapseImage&&(this.ui.collapseImage.remove(),this.ui.collapseImage=null),(!a||a&&this.settings.isDesktopDimension())&&this.settings.showImage()&&(f=e(f),c&&this.settings.get("AvailableCollapsedWidgetImageUrl")?this.ui.collapseImage=f:!c&&this.settings.get("UnavailableCollapsedWidgetImageUrl")&&(this.ui.collapseImage=f),this.ui.collapseImage&&(this.settings.isTabTop()?(this.ui.collapseImage=e(f),this.ui.purechatCollapsed.append(this.ui.collapseImage)):(this.ui.collapseImage=e(f),this.ui.purechatCollapsed.prepend(this.ui.collapseImage))))}this.settings.showTab()?this.ui.collapsedTabWrapper.show():this.ui.collapsedTabWrapper.hide(),this.settings.get("CollapsedStyle")==b.Constants.WidgetType.Button&&e(".purechat-button-expand").css("visibility","visible")},initialize:function(){var a=this;this.model.set("superMinimize","true"==(window.localStorage.superMinimize||"false").toLowerCase()),d.LayoutView.prototype.initialize.call(this),this.settings=d.getOption(this,"widgetSettings"),this.chooseWidgetTemplate(),this.repositionWidget(),this.bindWidgetSettingsChanges(),this.bindAppCommands(),this.settings.showPlaySoundCheckbox=function(){return(!a.settings.get("isOperator")||a.settings.get("isPersonalChat"))&&!a.settings.useMobile()},this.settings.playSoundOnNewMessage=function(){return"true"==(localStorage[a._audioNotificationLocalStorageKey]||"false").toLowerCase()}},setTitle:function(a,b){this.ui.title.text(a).attr("title",a),this.ui.title.attr("data-resourcekey",b),this.ui.collapsedTitle.text(a).attr("title",a),this.ui.collapsedTitle.attr("data-resourcekey",b),this.options.widgetSettings.get("isPersonalChat")&&this.options.widgetSettings.get("isInEditorMode")?(this.ui.title.data("isTitleEditor",!0),this.ui.collapsedTitle.data("isTitleEditor",!0),window.pcPersonalEditor.execute("editButton:show",[this.ui.title,this.ui.collapsedTitle])):this.model.get("isPoppedOut")&&(window.document.title=a)},updateImageSource:function(){var a=this,b=this.getOperatorsAvailable()||this.options.widgetSettings.get("UseAvailableImageForBoth");if(this.ui.collapseImage){var c=new Image;c.src=b?this.options.widgetSettings.get("AvailableCollapsedWidgetImageUrl"):this.options.widgetSettings.get("UnavailableCollapsedWidgetImageUrl"),c.onload=function(){a.options.widgetSettings.set({ImageHeight:c.naturalHeight,ImageWidth:c.naturalWidth},{silent:!0}),a.ui.collapseImage.attr("src",b?a.options.widgetSettings.get("AvailableCollapsedWidgetImageUrl"):a.options.widgetSettings.get("UnavailableCollapsedWidgetImageUrl")),a.updateImageTransform(),setTimeout(function(){delete c},0)}}},updateImageTransform:function(){var a=this.getOperatorsAvailable()||this.options.widgetSettings.get("UseAvailableImageForBoth");this.options.widgetSettings.set("AvailableImageScale",Math.min(100,this.options.widgetSettings.get("AvailableImageScale")),{silent:!0}),this.options.widgetSettings.set("UnavailableImageScale",Math.min(100,this.options.widgetSettings.get("UnavailableImageScale")),{silent:!0}),this.ui.collapseImage&&this.ui.collapseImage.attr&&this.ui.collapseImage.attr("style",this.options.widgetSettings.collapsedImageCss(a))},hideAdditionalDetails:function(a){this.$el.find(".purechat-widget-sliding-panel").removeClass("expanded").addClass("collapsed"),this.$el.find(".additional-details").removeClass("purechat-hide"),this.$el.find(".purechat-widget-inner").removeClass("expanded"),this.$el.css({width:this.maxWidth-200})},showAdditionalDetails:function(){var a=this,b=a.$el.find(".purechat-widget-sliding-panel"),c=b.find(".spinner");c.removeClass("purechat-hide");var d=a.$el.find(".purechat-widget-inner .purechat-widget-header").outerHeight();a.$el.find(".purechat-widget-inner").addClass("expanded"),b.find(".purechat-widget-header").css({height:d,lineHeight:d+"px"}),b.find(".purechat-additional-content").css({top:d}),b.removeClass("collapsed").addClass("expanded"),c.addClass("purechat-hide")},executeCommand:function(a){if(a.preventDefault(),a.stopPropagation(),!this.settings.get("isInEditorMode")){var b=e(a.currentTarget),c=b.data("trigger"),d=b.data("trigger-params");return this.minimizeOnLoadTimeout&&(this.minimizeOnLoadTimeout=clearTimeout(this.minimizeOnLoadTimeout)),this.triggerMethod(c,d,a)}},focusInput:function(){this.options.widgetSettings.get("isDemo")||this.settings.isMobileRequest()||this.$el.find(".purechat-name-input, .purechat-email-input, .purechat-question-input, .purechat-send-form-message").first().focus()},getResizedImageDimensions:function(a,b,c){return{height:a*c,width:b*c}},clearAutoExpandTimeout:function(){this._autoExpandTimeout&&(this._autoExpandTimeout=clearTimeout(this._autoExpandTimeout))},normalizeMilliseconds:function(a){return 1e3*a},setAutoExpandTimeout:function(){var a=this;this._autoExpandTimeout=setTimeout(function(){a.expand(),a.clearAutoExpandTimeout()},this.normalizeMilliseconds(this.settings.get("ExpandWidgetTimeout")))},onSuperMinimize:function(a,b,c){var d=this.model.get("poppedOut")||this.model.get("isPoppedOut");if(!d){b&&b.stopPropagation();var e=this,f=function(){e.$el.removeClass("purechat-widget-expanded purechat-widget-collapsed"),e.$el.addClass("purechat-widget-super-collapsed"),e.$el.find(".btn-toolbar .btn-expand").show(),e.$el.find(".btn-toolbar .btn-collapse, .purechat-widget-content, .collapsed-image, .purechat-super-minimize-link-button").hide();var a=2*-(e.$el.outerHeight()/4)-4;e.$el.hasClass("purechat-bottom-right")||e.$el.hasClass("purechat-bottom-left")?e.$el.css({bottom:a}):e.$el.css({top:a}),e.model.set("superMinimized",!0),window.localStorage.superMinimize=!0};c?this.minimizeOnLoadTimeout=setTimeout(f,1e3):f(),this.trigger("minimized")}return!1},peekWidget:function(){this.settings.isMobileRequest()||this.$el.removeAttr("style")},unpeekWidget:function(){var a=this;!this.settings.isMobileRequest()&&a.$el.hasClass("purechat-widget-super-collapsed")&&(a.$el.hasClass("purechat-bottom-right")||a.$el.hasClass("purechat-bottom-left")?a.$el.css({bottom:2*-(a.$el.outerHeight()/4)-4}):a.$el.css({top:2*-(a.$el.outerHeight()/4)-4}))},operatorsAvailableChanged:function(){this.settings.get("isWidget")&&(this.model.get("operatorsAvailable")?(this.$el.addClass("purechat-button-available"),this.$el.removeClass("purechat-button-unavailable"),this.$el.removeAttr("disabled","disabled")):(this.$el.removeClass("purechat-button-available"),this.$el.addClass("purechat-button-unavailable"),0===this.options.widgetSettings.get("UnavailableBehavior")&&(this.$el.addClass("purechat-button-hidden"),this.$el.attr("disabled","disabled"))),this.updateCollapsedStyle())},onExpand:function(a,b){var c=b.collapse,d=b.superMinimize,e=this,f=e.options.widgetSettings.get("poppedOut")||e.options.widgetSettings.get("isDirectAccess"),g=!e.settings.get("isDemo")&&(!e.settings.get("isDirectAccess")&&e.settings.get("ForcePopout")&&!e.model.get("isPoppedOut")||e.settings.get("usePrototypeFallback")),h=this.settings.useMobile()&&!this.settings.isDesktopDimension();if(!h&&!g||f||e.options.widgetSettings.get("widgetWasPoppedOut"))e.options.widgetSettings.get("dataController").checkChatAvailable().done(function(a){e.model.set("operatorsAvailable",a.available),c||d||e.expand()});else{var i=e.options.viewController,j=e.options.viewController.getDataController();i.popoutChatOnExpand(j,j.options,i.chatModel,i.state,h),e.options.widgetSettings.set("widgetWasPoppedOut",!0)}},mobileResize:function(){this.collapseMobile()},expandMobile:function(a,b){var c=this,d=c.$el;d.find(".purechat-widget-content"),d.find(".purechat-poweredby-container"),d.find(".purechat-widget-header");e(window).off("resize.RepositionWidget"),d.removeClass("slide-out-of-way").css({left:0}),this.ui.expandMobileButton.hide(),(b||function(){}).call(c)},expand:function(a,b,c){var d=this;d.$el.removeClass("purechat-widget-super-collapsed");var e=function(){var a=function(){d.$el.find(".btn-toolbar .btn-expand").hide(),d.$el.find(".btn-toolbar .btn-collapse").show(),d.$el.find(".purechat-widget-content").show(),d.$el.find(".purechat-widget-content").parent().find("div:last").show(),d.showRoomHostAvatar(d.options.model.get("roomHostAvatarUrl")),d.ui.widgetCollapsed.hide(),d.ui.widgetExpanded.show();var a=d.$el.find("input[type=text]:first");d.settings.isMobileRequest()||d.options.widgetSettings.get("isDemo")||(a.length>0?a.trigger("focus"):d.$el.find("textarea:first").trigger("focus")),d.$el.removeClass("purechat-widget-collapsed"),d.$el.addClass("purechat-widget-expanded")};b||"PCStateChatting"==d.model.get("state")||"PCStateClosed"==d.model.get("state")||!d.settings.get("StartChatImmediately")||d.settings.get("isInEditorMode"),a(),d.model.set({expanded:!0}),c&&c.expandSource&&(localStorage.expandSource=c.expandSource),d.trigger("expanded"),d.triggerResizedEvent()};window.localStorage.superMinimize=!1,d.settings.get("isDemo")||(localStorage.expanded=!0),d.settings.useMobile()&&!d.settings.isDesktopDimension()?(d.expandMobile(a,e),a&&(e(),d.$el.off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd"))):e()},collapseMobile:function(a,b){var c=this;if(!c.settings.get("isDirectAccess")&&!this.options.widgetSettings.get("isPersonalChat")&&!c.model.get("isPoppedOut")){this.ui.titleWrapper.hide(),this.ui.menuBar.hide(),a||this.ui.expandMobileButton.show();var d=c.$el,f=e(window).width(),g=this.ui.expandMobileButton;g.outerWidth();this.options.widgetSettings.get("killForPreview")||this.settings.isMobileRequest()||this.options.viewController.isAllowedOnMobile()||this.options.widgetSettings.get("isPersonalChat")||(d.addClass("slide-out-of-way").css({left:f-g.outerWidth()}),g.removeAttr("style")),(b||function(){}).call(c)}},onCollapse:function(a){var b=this;if(!this.settings.get("isPersonalChat")){localStorage.removeItem("expandSource"),b.settings.get("isDemo")||(localStorage.expanded=!1),b.$el.removeClass("purechat-widget-expanded"),b.$el.addClass("purechat-widget-collapsed"),b.$el.find(".btn-toolbar .btn-expand, .collapsed-image, .purechat-super-minimize-link-button").show(),this.showHideMinimizeButton(),b.$el.find(".btn-toolbar .btn-collapse, .purechat-widget-content").hide(),b.$el.find(".purechat-widget-content").parent().find("div:last").hide();var c=b.model.get("roomId")||b.settings.get("dataController").checkInRoom();this.hideRoomHostAvatar(),c&&2==b.settings.get("Type")?(b.ui.widgetCollapsed.hide(),b.ui.widgetExpanded.show(),b.settings.useMobile()&&!b.settings.isDesktopDimension()&&(b.$el.find(".purechat-expanded .purechat-menu .btn-expand").hide(),b.ui.widgetExpanded.off("click.ExpandWidgetForMobile").on("click.ExpandWidgetForMobile",function(){b.ui.widgetExpanded.off("click.ExpandWidgetForMobile"),b.expand()}))):(b.ui.widgetCollapsed.show(),b.ui.widgetExpanded.hide()),b.model.set("expanded",!1),b.trigger("collapsed"),b.triggerResizedEvent(),!b.settings.useMobile()||b.settings.isDesktopDimension()||a?(this.ui.titleWrapper.show(),this.ui.menuBar.show()):b.collapseMobile(a,function(){})}},onHide:function(){this.$el.addClass("purechat-button-hidden")},onShow:function(){var a=this;if((0!=a.settings.get("UnavailableBehavior")||a.model.get("isPoppedOut")||a.model.get("operatorsAvailable")||a.model.get("userId"))&&a.$el.removeClass("purechat-button-hidden"),!a.model.get("superMinimize")){var b=a.settings.get("PageLoadAnimation")||a.settings.get("DisplayWidgetAnimation");b&&!a.model.get("expanded")&&a.$el.addClass("purechat-"+b+" purechat-animated")}a.triggerResizedEvent()},triggerResizedEvent:function(){this.options.viewController.triggerResizedEvent()},flashNotification:function(a){j.notify(a,this.ui.title,this.$el)},onRender:function(){this.updateCollapsedStyle(),this.ui.expandMobileButton.hide(),this.ui.menuBar.hide(),this.ui.titleWrapper.hide(),this.settings.get("isWidget")?(this.ui.content.addClass("purechat-widget-content"),this.settings.isMobileRequest()&&this.ui.content.css({"overflow-y":"auto"})):(this.$el.addClass("purechat-window"),this.ui.content.addClass("purechat-window-content")),this.operatorsAvailableChanged(),this.setTitle(this.settings.get("title")||"");var a=null!==this.settings.get("dataController").checkInRoom()&&"undefined"!=typeof this.settings.get("dataController").checkInRoom();this.settings.get("isDemo")||"true"!=localStorage.expanded||this.settings.get("ForcePopout")||this.settings.get("usePrototypeFallback")||!a&&this.settings.get("StartChatImmediately")?this.model.get("superMinimize")?(this.onCollapse(!0),this.onSuperMinimize(null,null,!0)):this.onCollapse(!0):this.expand(!0,a),this.$el.hasClass("purechat-top")&&this.$el.find(".pc-icon-caret-down").removeClass("pc-icon-caret-down").addClass("pc-icon-caret-up"),this.settings.get("isPersonalChat")&&(1==this.settings.get("UserWidgetSettings").get("BackgroundType")&&this.settings.get("UserWidgetSettings").get("CustomBackgroundImage")&&this.settings.get("UserWidgetSettings").get("CustomBackgroundImage").FileId?e("#background-image").css({"background-image":'url("'+this.settings.get("pureServerUrl")+"/files/download/"+this.settings.get("UserWidgetSettings").get("CustomBackgroundImage").FileId+"."+this.settings.get("UserWidgetSettings").get("CustomBackgroundImage").FileExtension+'")'}):2==this.settings.get("UserWidgetSettings").get("BackgroundType")&&this.settings.get("UserWidgetSettings").get("StockBackgroundImage")&&"none"!=this.settings.get("UserWidgetSettings").get("StockBackgroundImage").Url.toLowerCase()?e("#background-image").css({"background-image":'url("'+this.settings.get("pureServerUrl")+this.settings.get("UserWidgetSettings").get("StockBackgroundImage").Url+'")'}):(e("#background-image").addClass("purechat-hide"),e("body").css({backgroundColor:"#"+this.settings.get("UserWidgetSettings").get("BackgroundColor")}))),this._originalPoweredBy=this.ui.poweredBy.html()||this.ui.poweredByHosted.html(),this.showHideMinimizeButton()},onAfterInsertion:function(){var a=this,b=!1;this.model.get("isOperator")||this.settings.useMobile()&&!this.settings.isDesktopDimension()&&(a.$el.hasClass("purechat-widget-expanded")?(a.expandMobile(),b=!0):a.collapseMobile(!0))}}),a.StartChatForm=d.ItemView.extend({template:"StartChatForm",className:"purechat-start-chat-form",events:{"submit form":"startChatSubmit","keydown textarea":"keyDown"},ui:{form:".purechat-form",userDisplayName:".purechat-name-input",userDisplayFirstName:".purechat-firstname-input",userDisplayLastName:".purechat-lastname-input",userDisplayCompany:".purechat-company-input",email:".purechat-email-input",question:".purechat-question-input",userDisplayNameError:".please-entername",emailError:".please-enteremail",questionError:".please-enterquestion",phoneNumber:".purechat-phonenumber-input",unavailablePhoneNumber:".purechat-unavailablephone-input",phoneNumberError:".please-enterphonenumber",unavailablePhoneError:".please-enterunavailablephone",userDisplayFirstNameError:".please-enterfirstname",userDisplayLastNameError:".please-enterlastname",userDisplayCompanyError:".please-entercompany"},keyDown:function(a){},startChatSubmit:function(a){a.preventDefault();var c=this;if(!this.submitDelay){this.submitDelay=!0,setTimeout(function(){delete c.submitDelay},500);var f=d.getOption(this,"FormType"),g=this.model.get("EmailForm"),h=this.options.settings.get("StartChatImmediately"),i=this.model.get("AskForFirstName")&&(g||!h),j=this.model.get("AskForLastName")&&(g||!h),k=this.model.get("AskForCompany")&&(g||!h),l=this.model.get("AskForEmail")&&(g||!h),m=this.model.get("AskForQuestion")||h,n=this.model.get("AskForPhoneNumber")&&(g||!h),o=null,p=null;i&&(p=e.trim(this.ui.userDisplayFirstName.val()));var q=null;j&&(q=e.trim(this.ui.userDisplayLastName.val()));var r=null;k&&(r=e.trim(this.ui.userDisplayCompany.val()));var s=null;(l||"email"===f)&&(s=this.ui.email.val());var t=this.ui.question.val()||this.model.get("InitialVisitorQuestion");if(this.ui.form.find('[class*="please"]').hide(),"string"==typeof p&&0==p.length)return this.ui.userDisplayFirstNameError.show(),
c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof q&&0==q.length)return this.ui.userDisplayLastNameError.show(),c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof s&&0==s.length)return this.ui.emailError.show(),c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof r&&0==r.length)return this.ui.userDisplayCompanyError.show(),c.options.viewController.triggerResizedEvent(),!1;var u=this.ui.phoneNumber.val()||this.ui.unavailablePhoneNumber.val()||this.model.get("InitialVisitorPhoneNumber");if(n){if(0==u.length)return this.ui.phoneNumberError.show(),c.options.viewController.triggerResizedEvent(),!1;this.ui.phoneNumberError.hide(),c.options.viewController.triggerResizedEvent(),this.ui.phoneNumber.val(u)}else if("email"==f&&this.model.get("UnavailableAskForPhone")){if(0==u.length)return this.ui.unavailablePhoneError.show(),c.options.viewController.triggerResizedEvent(),!1;this.ui.unavailablePhoneError.hide(),c.options.viewController.triggerResizedEvent(),this.ui.unavailablePhoneNumber.val(u)}if(m&&(null===t||""==e.trim(t)))return this.ui.questionError.show(),c.options.viewController.triggerResizedEvent(),!1;p=p||c.options.viewController.getPublicApi().get("visitor_firstName")||this.model.get("InitialVisitorFirstName"),q=q||c.options.viewController.getPublicApi().get("visitor_lastName")||this.model.get("InitialVisitorLastName"),r=r||c.options.viewController.getPublicApi().get("visitor_company")||this.model.get("InitialVisitorCompany"),s=s||c.options.viewController.getPublicApi().get("visitor_email")||this.model.get("InitialVisitorEmail"),t=t||c.options.viewController.getPublicApi().get("visitor_question"),u=u||c.options.viewController.getPublicApi().get("visitor_phonenumber"),p?(o=p,q&&(o+=q)):q?o=q:(o="Visitor",p="Visitor"),o=p+" "+q,this.model.set({Name:o,FirstName:p,LastName:q,Company:r,Email:s,Question:t,PhoneNumber:u}),this.model.trigger("formSubmit",{visitorName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(o||""),!0),visitorFirstName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(p||""),!0),visitorLastName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(q||""),!0),visitorCompany:b.Utils.escapeHtml(b.Utils.stripDangerousTags(r||""),!0),visitorEmail:b.Utils.escapeHtml(b.Utils.stripDangerousTags(s||""),!0),visitorQuestion:b.Utils.escapeHtml(b.Utils.stripDangerousTags(t||""),!1),visitorPhoneNumber:b.Utils.escapeHtml(b.Utils.stripDangerousTags(u||""),!0)})}},isMobile:function(){return this.options.settings.useMobile()&&this.options.settings.isDesktopDimension()},onClose:function(){this.options.settings.get("isPersonalChat")&&this.options.settings.get("isInEditorMode")&&window.pcPersonalEditor&&window.pcPersonalEditor.execute("editButton:hide",this.$el.find("[data-resourcekey]"))},onRender:function(){(this.options.settings.get("isPersonalChat")||this.isMobile())&&(this.$el.find("#purechat-name-submit").addClass("button"),this.options.settings.get("isInEditorMode")&&window.pcPersonalEditor&&(this.$el.find("input, textarea").prop("disabled",!0),window.pcPersonalEditor.execute("editButton:show",this.$el.find("[data-resourcekey]"))))}}),a.StartChatFormAutomatically=a.StartChatForm.extend({template:"StartChatFormAutomatically",templateHelpers:function(){var a=this;return{isMobile:function(){return a.isMobile()},personalAvatarUrl:function(){return"undefined"!=typeof personalAvatarUrl?personalAvatarUrl:a.PureServerUrl()+"/content/images/avatars/1avatar-operator-skinny.png"},isPersonalChat:function(){return a.isPersonalChat()}}},isPersonalChat:function(){return this.options.settings.get("isPersonalChat")},PureServerUrl:function(){return this.options.settings.get("pureServerUrl")},isMobile:function(){return this.options.settings.useMobile()&&!this.options.settings.isDesktopDimension()},keyDown:function(a){return 13!==a.keyCode||a.shiftKey?!0:a.ctrlKey?(this.ui.question.val(this.ui.question.val()+"\n"),!0):(this.startChatSubmit(a),!1)},initialize:function(){var a=this;this._originalOnRender=this.onRender,this.onRender=function(){a._originalOnRender(),a.isMobile()&&a.$el.removeClass("purechat-start-chat-form")}},onRender:function(){this.isMobile()&&this.$el.addClass("mobile"),this.isPersonalChat()&&this.$el.addClass("personal"),this.options.settings.get("isPersonalChat")&&this.options.settings.get("isInEditorMode")&&this.$el.find("textarea.purechat-send-form-message").prop("disabled",!0)}}),a.EmailSent=d.ItemView.extend({template:"EmailSent",className:""}),a.MessageView=d.ItemView.extend({template:"MessageView",className:"purechat-message-wrapper purechat-clearfix",ui:{},modelEvents:{change:"render"},onRender:function(){window.pcPersonalEditorSettings&&window.pcPersonalEditorSettings.get("isPersonalChat")&&window.pcPersonalEditorSettings.get("isInEditorMode")&&window.pcPersonalEditor&&window.pcPersonalEditor.execute("editButton:show",this.$el.find("[data-resourcekey]")),this.$el.attr({"data-userid":this.model.get("userId")});var a=this.model.get("type")||"";this.$el.addClass("message"!=a.toLowerCase()?a:""),this.$el.addClass(this.model.get("isClosedChat")?"closed":"")}}),a.EmptyView=d.ItemView.extend({template:"Empty",className:"empty-item",events:{}}),a.MessageListView=d.CompositeView.extend({scrollBottom:0,template:"MessageList",className:"message-list-view",cannedResponseCollection:null,ui:{messageListContainer:".purechat-message-display",textInput:"textarea",disableTextArea:".disableTextArea",form:"form",displayContainer:".purechat-message-display-container",userStatus:".purechat-user-status",showPrevious:".showPrevious"},childView:a.MessageView,emptyView:a.EmptyView,childViewContainer:".purechat-message-display",templateHelpers:function(){var a=this,b=this.options.settings,c={isPersonalChat:function(){return b.get("isPersonalChat")||!1},isMobile:function(){return a.options.settings.useMobile()&&!a.options.settings.isDesktopDimension()}};return c},collectionEvents:{change:"listChanged",add:"listChanged"},listChanged:function(a,b,c){var d=this;this.showMessages||(this.showMessages=setTimeout(function(){d.ui.messageListContainer.show()},100)),a.get("isClosedChat")||0==d.scrollBottom||0!=d.ui.displayContainer.scrollTop()||(d.scrollBottom=d.ui.displayContainer[0].scrollHeight-d.ui.displayContainer.height()),a.get("isClosedChat")||this.model.get("userId")!=a.get("userId")||(d.scrollBottom=0),d.scrollBottom<=20&&(d.scrollBottom=0),(0==d.scrollBottom||a.get("isClosedChat"))&&(d.scrollTimeout&&(clearTimeout(d.scrollTimeout),d.scrollTimeout=null),d.scrollTimeout=setTimeout(function(){d.scrollTimeout=null,d.updateScroll()},0))},updateScroll:function(){var a=this;a.ui.displayContainer.scrollTop(a.ui.displayContainer[0].scrollHeight-a.ui.displayContainer.height()-a.scrollBottom)},modelEvents:{change:function(a){this.triggerMethod("roomHostChanged",a)},"change:HasMoreTransactions":"updatePreviousVisibility"},events:{"keydown textarea":"keyDown","keyup textarea":"keyUp","submit form":"postMessage","refreshAutoCompleteSource textarea":function(){var a=this;a.cannedResponseCollection=[],pcDashboard.CannedResponses.ResponseCollection.forEach(function(b){a.cannedResponseCollection.push({label:b.get("Content"),value:e("<div/>").html(b.get("Content")).text()})}),a.ui.textInput.trigger("disableAutoComplete").trigger("enableAutoComplete")},"disableAutoComplete textarea":function(){this.ui.textInput.autocomplete("destroy")},"enableAutoComplete textarea":function(){var a=this;this.ui.textInput.autocomplete({source:function(b,c){var d=(CurrentUser.get("cannedResponseSettings").get("MatchStartOfCannedResponse")?"^":"")+e.ui.autocomplete.escapeRegex(b.term),f=new RegExp(d,"im");c(e.grep(a.cannedResponseCollection,function(a){return f.test(a.label||a.value)}))},delay:100,position:{my:"bottom",at:"top"},open:function(){var a=e(this).autocomplete("widget");e("<div />").addClass("arrow pure-chat-auto-complete-arrow").appendTo("body").position({my:"center",at:"left+32 bottom+5",of:a}).css({zIndex:parseInt(a.css("z-index"))+1})},close:function(){e(".pure-chat-auto-complete-arrow").remove()}}),this.ui.textInput.autocomplete("widget").addClass("canned-responses-autocomplete")},"focus textarea":"expandForm","click textarea":"expandForm","blur textarea":"collapseForm","click .showPrevious":"showPrevious"},showPrevious:function(){this.triggerMethod("showPrevious")},getLastMessageWithId:function(a){var b=null;return this.collection.forEach(function(c){c.get("userId")&&c.get("messageId")!=a&&(b=c)}),b},onDestroy:function(){e(window).off("resize.ScrollToTopMobile"),this.$el.find(".purechat-message-display-container").off("scroll")},updatePreviousVisibility:function(){this.model.get("HasMoreTransactions")?this.ui.showPrevious.show():this.ui.showPrevious.hide()},onRender:function(){window.test=this;var a=this;if(a.ui.messageListContainer.hide(),this.ui.displayContainer.on("scroll.displayContainer",function(){a.scrollBottom=a.ui.displayContainer[0].scrollHeight-a.ui.displayContainer.height()-a.ui.displayContainer.scrollTop(),a.model.set("scrollBottom",a.scrollBottom)}),this.options.settings.get("isInvisible")&&(this.ui.textInput.attr("disabled","disabled"),this.ui.disableTextArea.show()),this.options.settings.get("isOperator")){if(this.cannedResponseCollection=pcDashboard.CannedResponses.ResponseCollection,0==this.cannedResponseCollection.length){this.cannedResponseCollection=[];var b=this.options.settings.get("cannedResponses");for(i in b)if("===separator==="!==b[i].content){var c={label:b[i].content,value:e("<div/>").html(b[i].content).text()};this.cannedResponseCollection.push(c)}}var a=this,d=window.$(this.ui.textInput).autocomplete({source:function(b,c){var d=(CurrentUser.get("cannedResponseSettings").get("MatchStartOfCannedResponse")?"^":"")+e.ui.autocomplete.escapeRegex(b.term),f=new RegExp(d,"im"),g=[];if(a.cannedResponseCollection.models&&a.cannedResponseCollection.models.length){var h=[];a.cannedResponseCollection.models.forEach(function(a){h.push({label:a.get("Content"),value:e("<div/>").html(a.get("Content")).text()})}),g=e.grep(h,function(a){return f.test(a.label||a.value)})}else g=e.grep(a.cannedResponseCollection,function(a){return f.test(a.label||a.value)});c(g)},delay:100,position:{my:"bottom",at:"top"},open:function(){var a=e(this).autocomplete("widget");e("<div />").addClass("arrow pure-chat-auto-complete-arrow").appendTo("body").position({my:"center",at:"left+32 bottom+5",of:a}).css({zIndex:parseInt(a.css("z-index"))+1})},close:function(){e(".pure-chat-auto-complete-arrow").remove()}});d.autocomplete("widget").addClass("canned-responses-autocomplete")}this.options.settings.get("isPersonalChat")&&(this.$el.find(".btn-close").css("display","inline-block"),this.options.settings.get("isInEditorMode")&&window.pcPersonalEditor&&(this.$el.find("textarea").prop("disabled",!0),window.pcPersonalEditor.execute("editButton:show",this.$el.find("[data-resourcekey]")))),this.updatePreviousVisibility()},keyDown:function(a){return 13!==a.keyCode||a.shiftKey?!0:a.ctrlKey?(this.ui.textInput.val(this.ui.textInput.val()+"\n"),!0):(this.triggerMethod("typingChange",!1),this.activity=!1,this.ui.form.submit(),!1)},keyUp:function(){var a=this;a.typingTimeout&&(clearTimeout(a.typingTimeout),a.typingTimeout=null),this.typingTimeout=setTimeout(function(){try{""!=a.ui.textInput.val()?(a.activity=!0,a.triggerMethod("typingChange",!0)):(a.triggerMethod("typingChange",!1),a.activity=!1)}catch(b){}},2e3),""!=a.ui.textInput.val()&&1!=a.activity&&(a.triggerMethod("typingChange",!0),a.activity=!0)},postMessage:function(a){a.stopPropagation(),a.preventDefault();var b=this.ui.textInput.val();this.triggerMethod("newMessage",b),this.ui.textInput.val("");try{this.ui.textInput.autocomplete("close")}catch(c){}},typing:function(a,b,c){this.model.get("participants").set({userId:a,displayName:b,isTyping:c},{remove:!1}),this.ui.userStatus.html(this.model.get("participants").getOperatorTypingText(this)),c&&this.options.settings.get("isPersonalChat")&&this.options.settings.get("isInEditorMode")&&(this.ui.userStatus.find('[data-resourcekey="chat_typing"]').attr("data-username",f.escape(b)),window.pcPersonalEditor.execute("editButton:show",this.ui.userStatus.find("[data-resourcekey]")))},appendBuffer:function(a,b){var c=this.getItemViewContainer(a);c.append(b)},appendHtml:function(a,b,c){if(a.isBuffering)a.elBuffer.appendChild(b.el);else{var d=this.getItemViewContainer(a),e=d.find(".purechat-message-wrapper").last();e.length?e.after(b.el):d.append(b.el)}},destroy:function(){this.ui.displayContainer.off("scroll.displayContainer")}}),a.ClosedOperatorView=a.MessageListView.extend({template:"ClosedMessageOperator",className:"message-list-view closed-operator-container",templateHelpers:function(){var a=this;return e.extend({getExportParams:function(){var b={chatId:a.options.settings.get("room").id,visitorEmail:a.options.settings.get("room").visitorEmail,visitorIPAddress:a.options.settings.get("room").visitorIPAddress,visitorPhoneNumber:a.options.settings.get("room").visitorPhoneNumber,visitorFirstName:a.options.settings.get("room").visitorFirstName,visitorLastName:a.options.settings.get("room").visitorLastName};return escape(JSON.stringify(b))}},this.options.settings)},events:{},initialize:function(){this._initialCollection=d.getOption(this,"chatModel").get("messages"),this._proxyCollection=new c.Collection,this.collection=new b.Models.MessageCollectionMessagesGrouped(null,{collection:this._proxyCollection})},onRender:function(){this.ui.messageListContainer.show()},renderMessageList:function(){var a=this;this._initialCollection.forEach(function(b){a._proxyCollection.add(b)})}}),a.EmailForm=d.ItemView.extend({template:"EmailForm",className:"purechat-start-chat-form",ui:{form:".purechat-form",userDisplayName:".purechat-name-input",userDisplayFirstName:".purechat-firstname-input",userDisplayLastName:".purechat-lastname-input",userDisplayCompany:".purechat-company-input",email:".purechat-email-input",question:".purechat-question-input",userDisplayNameError:".please-entername",emailError:".please-enteremail",questionError:".please-enterquestion",phoneNumber:".purechat-phonenumber-input",unavailablePhoneNumber:".purechat-unavailablephone-input",phoneNumberError:".please-enterphonenumber",unavailablePhoneError:".please-enterunavailablephone",userDisplayFirstNameError:".please-enterfirstname",userDisplayLastNameError:".please-enterlastname",userDisplayCompanyError:".please-entercompany"},templateHelpers:function(){return this.options.settings},events:{"submit form":"submitEmailForm"},submitEmailForm:function(a){a.preventDefault();var c=this;if(!this.submitDelay){this.submitDelay=!0,setTimeout(function(){delete c.submitDelay},500);var d=this.options.settings.get("AskForFirstName"),f=this.options.settings.get("AskForLastName"),g=this.options.settings.get("AskForPhoneNumber"),h=this.options.settings.get("AskForCompany"),i=null,j=null;d&&(j=e.trim(this.ui.userDisplayFirstName.val()));var k=null;f&&(k=e.trim(this.ui.userDisplayLastName.val()));var l=null;h&&(l=e.trim(this.ui.userDisplayCompany.val()));var m=this.ui.email.val(),n=this.ui.question.val();if(this.ui.form.find('[class*="please"]').hide(),"string"==typeof j&&0==j.length)return this.ui.userDisplayFirstNameError.show(),c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof k&&0==k.length)return this.ui.userDisplayLastNameError.show(),c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof m&&0==m.length)return this.ui.emailError.show(),c.options.viewController.triggerResizedEvent(),!1;if("string"==typeof l&&0==l.length)return this.ui.userDisplayCompanyError.show(),c.options.viewController.triggerResizedEvent(),!1;var o=this.ui.phoneNumber.val();if(g){if(0==o.length)return this.ui.phoneNumberError.show(),c.options.viewController.triggerResizedEvent(),!1;this.ui.phoneNumberError.hide(),c.options.viewController.triggerResizedEvent(),this.ui.phoneNumber.val(o)}if(null===n||""==e.trim(n))return this.ui.questionError.show(),c.options.viewController.triggerResizedEvent(),!1;j=j||c.options.viewController.getPublicApi().get("visitor_firstName")||this.model.get("InitialVisitorFirstName")||"Visitor",k=k||c.options.viewController.getPublicApi().get("visitor_lastName")||this.model.get("InitialVisitorLastName"),l=l||c.options.viewController.getPublicApi().get("visitor_company")||this.model.get("InitialVisitorCompany"),m=m||c.options.viewController.getPublicApi().get("visitor_email")||this.model.get("InitialVisitorEmail"),n=n||c.options.viewController.getPublicApi().get("visitor_question")||this.model.get("InitialVisitorQuestion"),o=o||c.options.viewController.getPublicApi().get("visitor_phonenumber")||this.model.get("InitialVisitorPhoneNumber"),j?(i=j,k&&(i+=k)):k?i=k:(i="Visitor",j="Visitor"),this.model.set({Name:i,FirstName:j,LastName:k,Company:l,Email:m,Question:n,PhoneNumber:o}),this.model.trigger("formSubmit",{visitorName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(i||""),!0),visitorFirstName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(j||""),!0),visitorLastName:b.Utils.escapeHtml(b.Utils.stripDangerousTags(k||""),!0),visitorCompany:b.Utils.escapeHtml(b.Utils.stripDangerousTags(l||""),!0),visitorEmail:b.Utils.escapeHtml(b.Utils.stripDangerousTags(m||""),!0),visitorQuestion:b.Utils.escapeHtml(b.Utils.stripDangerousTags(n||""),!1),visitorPhoneNumber:b.Utils.escapeHtml(b.Utils.stripDangerousTags(o||""),!0)})}},onRender:function(){}}),a.ClosedMessage=d.ItemView.extend({getTemplate:function(){return this.options.settings.get("isOperator")?"ClosedMessageOperator":"ClosedMessage"},className:"purechat-closedmessage-container",ui:{ratingThanks:".purechat-rating-thanks",displayContainer:".purechat-message-display-container",ratingPrompt:'[data-resourcekey="closed_askForRating"]'},templateHelpers:function(){return this.options.settings},updateScroll:function(){var a=this;a.ui.displayContainer.scrollTop(a.ui.displayContainer[0].scrollHeight-a.ui.displayContainer.height())},events:{"click .purechat-thumbs-up":function(a){this.options.settings.get("isInEditorMode")||(e(a.target).addClass("purechat-thumbs-selected"),this.rateChat(!0))},"click .purechat-thumbs-down":function(a){this.options.settings.get("isInEditorMode")||(e(a.target).addClass("purechat-thumbs-selected"),this.rateChat(!1))},"click button.ban-ip-operator-button":function(a){var b=h(a.target);h('.operatorBanIPAddress[data-ipaddressid="'+b.attr("data-ipaddressid")+'"]').modal("show"),h("#BanIP-"+b.attr("data-ipaddressid")).off("click.BanIPAddressFromOperator").on("click.BanIPAddressFromOperator",function(){h(document).trigger("ConfirmBanIPAddressFromOperator",[h(this),b])})},"click .purechat-download-container a":function(){return!this.options.settings.get("isInEditorMode")}},rateChat:function(a){this.rating||(this.rating=a?1:0,this.trigger("chat:rated",this.rating)),this.$el.find(".purechat-thumbs-selectable:not(.purechat-thumbs-selected)").remove(),this.ui.ratingThanks.text(this.getResource("closed_ratingThanks")),this.ui.ratingThanks.attr("data-resourcekey","closed_ratingThanks"),this.ui.ratingPrompt.length>0&&this.ui.ratingPrompt.hide()},initialize:function(){this.model.set("isPersonalChat",this.options.settings.get("isPersonalChat"))},onClose:function(){this.options.settings.get("isPersonalChat")&&this.options.settings.get("isInEditorMode")&&window.pcPersonalEditor&&window.pcPersonalEditor.execute("editButton:hide",this.$el.find("[data-resourcekey]"))},onRender:function(){this.options.settings.get("isPersonalChat")&&(this.$el.find("a.purechat-cta-button").attr("href",/http/i.test(this.getResource("button_cta_url"))?this.getResource("button_cta_url"):"http://"+this.getResource("button_cta_url")),this.options.settings.get("isInEditorMode")&&window.pcPersonalEditor&&window.pcPersonalEditor.execute("editButton:show",this.$el.find("[data-resourcekey]")))}}),a.CoolSpinner=d.ItemView.extend({template:f.template(""),className:"purechat-cool-awesome-spinner spinner"}),a.ChatConnectingView=d.ItemView.extend({template:"ChatConnecting",className:"purechat-enterinfo-container",ui:{spinner:".spinnerContainer",greeting:".greeting",connecting:".connecting"},onRender:function(){var b={length:20,radius:20,width:10,color:"#888"};if(this.options.settings.get("isPersonalChat")){var c=new a.CoolSpinner;c.render(),this.ui.spinner.css("height","auto").append(c.$el),this.ui.greeting.css("display","none"),this.ui.connecting.css("display","none")}else{var c=new purechatSpinner.Spinner(b).spin(),d=e(c.el);d.css({left:"50%",top:"50%"}),this.ui.spinner.append(d)}},showErrorMessage:function(a){this.ui.spinner.hide(),this.ui.greeting.hide(),this.ui.connecting.hide(),this.$el.append("<p>"+a+"</p>")}}),a.PersonalChatTooltip=d.ItemView.extend({template:f.template('<span class="arrow"></span>'),tagName:"span",className:"personal-tooltip",onRender:function(){this.$el.append(this.model.get("text"))}}),a.PersonalChatDetails=d.ItemView.extend({template:"PersonalChatDetails",className:"purechat-personal-widget-content",events:{"mouseenter .purechat-social-buttons a[data-tooltiptext]":"displayFixedTooltip","mouseleave .purechat-social-buttons a[data-tooltiptext]":"hideFixedTooltip","click .start-chat":"showWidgetBody"},showWidgetBody:function(){var a=this;this.$el.parent().css({left:-e(window).width()}),setTimeout(function(){a.$el.parent().addClass("purechat-hide")},1001)},displayFixedTooltip:function(b){var d=e(b.currentTarget),f=new a.PersonalChatTooltip({model:new c.Model({text:d.data("tooltiptext")})});f.render(),f.$el.appendTo("body");var g=d.offset().top+d.outerHeight()-1,h=d.offset().left+d.width()/2-8;f.$el.css({display:"inline-block",top:g,left:h}),d.data("activetooltip",f)},hideFixedTooltip:function(a){var b=e(a.currentTarget),c=b.data("activetooltip");c&&(c.destroy(),b.data("activetooltip",null))},initialize:function(){if("undefined"!=typeof tempPersonalWidgetSettings){var a=this.model.get("UserWidgetSettings");for(var b in tempPersonalWidgetSettings.attributes)a.set(b,tempPersonalWidgetSettings.get(b)||a.get(b));this.model.set("UserWidgetSettings",a)}},onRender:function(){this.options.model.get("RequestFromMobileDevice")&&this.$el.find(".purechat-contact-details a").addClass("button")},onAfterInserted:function(){}}),a.UnsupportedBrowser=d.ItemView.extend({template:"UnsupportedBrowser",className:"purechat-unsupported-browser",onRender:function(){}})},purechatApp.Models),purechatApp.templates=templates;var m=_.noConflict(),n=Backbone.noConflict(),o=Marionette.noConflict(),p={popoutButton:!1,closeButton:!1,restartButton:!1,removeWidgetButton:!1,requeueButton:!1,leaveButton:!1,cannedResponsesButton:!1},q=2e4,r=6e5,s=[];purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCWidgetState=o.Controller.extend({initialize:function(){this.stateSettings=this.stateSettings||{},this.stateSettings.UiVisiblity=this.stateSettings.UiVisiblity||{},m.defaults(this.stateSettings.UiVisiblity,p)},setChatModel:function(a){this.chatModel=a},getChatModel:function(){return this.chatModel},setWidgetView:function(a){this.widgetView=a,this.listenTo(this.widgetView,"all")},setPersonalDetailsView:function(a){this.personalDetailsView=a},getPersonalDetailsView:function(){return this.personalDetailsView},getWidgetView:function(){return this.widgetView},setWidgetSettings:function(a){this.settings=a},getWidgetSettings:function(){return this.settings},setResources:function(a){this.resources=a},getResources:function(){return this.resources},setDataController:function(a){this.dc=a},getDataController:function(){return this.dc},setViewController:function(a){this.vc=a},getViewController:function(){return this.vc},getResource:function(a,b){return this.resources.getResource(a,b)},disable:function(){this.getDataController().connectionInfo.set("disabled",!0),this.getDataController().connectionInfo.set("chatActiveInOtherWindow",!0),this.getWidgetView().$el.hide()},enable:function(){this.getDataController().connectionInfo.set("disabled",!1),this.getDataController().connectionInfo.set("chatActiveInOtherWindow",!1),this.getWidgetView().$el.show()},syncWithContact:function(){var a=e.Deferred(),b=this;return this.getDataController().getContactInfo().done(function(c){!c||window.pcPersonalEditorSettings&&window.pcPersonalEditorSettings.get("isInEditorMode")||(b.getChatModel().set("visitorFirstName",c.firstName),b.getChatModel().set("visitorLastName",c.lastName),b.getChatModel().set("visitorCompany",c.company),b.getChatModel().set("visitorEmail",c.email),b.getChatModel().set("visitorPhoneNumber",c.phone)),a.resolve()}),a.promise()},showConnectingWithTimeout:function(){function a(){if(this.connectingTimeout){var a=new purechatApp.Views.ChatConnectingView({rm:b.getResources(),model:new n.Model({}),settings:b.options});b.getWidgetView().content.show(a)}}var b=this;this.clearConnectingTimeout(),this.connectingTimeout=setTimeout(a,500);this.connectingTimeout},clearConnectingTimeout:function(){this.connectingTimeout&&(clearTimeout(this.connectingTimeout),delete this.connectingTimeout)},onEnter:function(){this.listenTo(this.getWidgetView(),"all",function(a,b){var c=this;b&&b.confirmation?c.getViewController().showConfirmationDialog(b.confirmation,b.title).done(function(){c.triggerMethod.call(c,a,b)}):this.triggerMethod.apply(this,arguments)});var a=this;if(this.stateSettings){if(this.stateSettings.UiVisiblity){var b=this.getWidgetView();for(var c in this.stateSettings.UiVisiblity)b.ui[c]&&b.ui[c].toggle(this.stateSettings.UiVisiblity[c])}var d=a.getDataController(),e=d.connectionInfo,f=this.stateSettings.shouldBeInRoom;this.chatModel.get("isOperator")||m.isUndefined(f)||(f?this.listenTo(e,"change:isInChat",function(b,c){c||a.chatModel.set("state",purechatApp.Constants.WidgetStates.Closed)}):this.listenTo(e,"change:isInChat",function(b,c){c&&(a.widgetView.expand(),a.chatModel.set("state",purechatApp.Constants.WidgetStates.Chatting))}))}this.listenTo(this.options,"change:enableAvailabilityPolling",function(b,c){if(c)switch(a.name){case"inactive":a.startAvailabilityPolling(!0)}else!a.getChatModel().get("expanded")&&a.TestingStartedFromApi&&a.stopAvailabilityPolling()})},onExit:function(){this.clearConnectingTimeout(),this.stopListening(this.widgetView,"all"),this.stopAvailabilityPolling(!0)},clearPolling:function(){s.forEach(function(a){clearInterval(a)}),s=[]},testAvailability:function(){var a=this;a.getViewController().pageActivity||a.lastCheck&&new Date-a.lastCheck>12e4?(a.lastCheck=new Date,a.getDataController().checkChatAvailable().done(function(b){a.clearPolling(),a.checkAvailTimeout=b.available?q:r,b.available?s.push(setTimeout(function(){a.testAvailability()},a.checkAvailTimeout)):"AccountActivity"!==b.reason?s.push(setTimeout(function(){a.testAvailability()},a.checkAvailTimeout)):a.stopAvailabilityPolling(),a.getChatModel().set("operatorsAvailable",b.available)})):(a.checkAvailTimeout=q,a.clearPolling(),s.push(setTimeout(function(){a.testAvailability()},1500)))},startAvailabilityPolling:function(a){var b=this;b.clearPolling(),b.checkAvailTimeout=q,b.testAvailability(),this.TestingStatus||s.push(setTimeout(function(){b.testAvailability()},b.checkAvailTimeout)),this.TestingStatus=!0,this.TestingStartedFromApi=a||!1},stopAvailabilityPolling:function(a){this.options.get("enableAvailabilityPolling")&&"chatting"!=this.name&&"activating"!=this.name&&!a||(this.TestingStatus=!1,this.clearPolling())},onPopOutChat:function(){var a=this.getWidgetSettings(),b=this.getChatModel(),c=this.getDataController();this.getChatModel().set("poppedOut",!0),this.disable(),c.connectionInfo.persistLocalStorage(),window.openedWindow=window.open(this.settings.get("pureServerUrl")+"/VisitorWidget/ChatWindow?widgetId="+a.get("widgetId")+"&userId="+c.connectionInfo.get("userId")+"&displayName="+c.connectionInfo.get("visitorName")+"&authToken="+c.connectionInfo.get("authToken")+"&roomId="+c.connectionInfo.get("roomId")+"&chatId="+c.connectionInfo.get("chatId")+"&origin="+encodeURIComponent(b.get("origin")),"purechatwindow","menubar=no, location=no, resizable=yes, scrollbars=no, status=no, width=480, height=640"),this.getViewController().trigger("widget:poppedOut")}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateEmailForm=a.PCWidgetState.extend({name:"emailForm",initialize:function(){a.PCWidgetState.prototype.initialize.apply(this,arguments)},UiVisibility:{popoutButton:!0,closeButton:!0,requeueButton:!0},buildInitialQuestionFromMessageList:function(){var a=this.chatModel.get("userId"),b=this.chatModel.get("messages").filter(function(b){return b.get("userId")==a}),c="";return b.forEach(function(a){0==c.length?c=a.get("message"):c+=" "+a.get("message")}),c},onEnter:function(){var c=this.buildInitialQuestionFromMessageList();a.PCWidgetState.prototype.onEnter.apply(this,arguments);var d=this,f=this.getWidgetView();d.getWidgetView().setTitle(d.getResource("title_emailForm"),"title_emailForm");var g=new n.Model({UnavailableAskForPhone:d.settings.get("UnavailableAskForPhone"),EmailForm:!0,InitialVisitorName:d.getViewController().getChatModel().get("visitorName")||"",InitialVisitorFirstName:d.getViewController().getChatModel().get("visitorFirstName")||"",InitialVisitorLastName:d.getViewController().getChatModel().get("visitorLastName")||"",InitialVisitorCompany:d.getViewController().getChatModel().get("visitorCompany")||"",InitialVisitorEmail:d.getViewController().getChatModel().get("visitorEmail")||"",InitialVisitorQuestion:c||d.getViewController().getChatModel().get("visitorQuestion")||"",InitialVisitorPhoneNumber:d.getViewController().getChatModel().get("visitorPhoneNumber")||""});g.on("formSubmit",function(a){var c=e(d.getWidgetView().el).find(".purechat-form.purechat-email-form");b.execute("spinner:show",c),d.getDataController().submitEmailForm(a).done(function(b){if(b.success){var e=new purechatApp.Views.EmailSent({rm:d.getResources(),model:g});d.getWidgetView().content.show(e),d.getWidgetView().ui.restartButton.show(),d.getWidgetView().$el.find(".btn-restart").on("click.RestartChat",function(a){d.restartChat.call(d,a)}),d.getViewController().trigger("email:send",a)}else c.find(".purechat-email-error").css({display:"block"})}).fail(function(){}).always(function(){b.execute("spinner:hide",c)})});var h=new b.Views.EmailForm({viewController:d.getViewController(),rm:d.getResources(),settings:d.options,chatModel:d.chatModel,model:g});f.content.show(h),f.onShow()},onExpanded:function(){this.getWidgetView().setTitle(this.getResource("title_emailForm"),"title_emailForm")},onCollapsed:function(){this.getWidgetView().setTitle(this.getResource("title_initial"))},restartChat:function(a){a.stopPropagation();var b=e(a.currentTarget),c=this;b.off("click.RestartChat"),c.getDataController().restartChat().done(function(){c.getChatModel().restartChat(),c.getViewController().resetVisitorQuestion(),c.getViewController().trigger("widget:restart")}).fail(function(){throw new Error("Failed to send email. Please try again!")})},onExit:function(){a.PCWidgetState.prototype.onExit.apply(this,arguments),this.unbindEvents&&this.unbindEvents()}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateInitializing=a.PCWidgetState.extend({name:"initializing",stateSettings:{UiVisiblity:{}},onEnter:function(){var c=this;a.PCWidgetState.prototype.onEnter.apply(this,arguments),this.getWidgetView().setTitle(this.getResource("title_initial_open"),"title_initial_open");var d=this.getDataController().checkInRoom(),e=new RegExp("^https?://"+document.location.hostname,"i");document.referrer.match(e)||(localStorage.acquisitionSource=document.referrer),this.syncWithContact().done(function(){d?c.getChatModel().set("state",b.Constants.WidgetStates.Activating):c.getChatModel().set("state",b.Constants.WidgetStates.Inactive)})}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){var h=null;a.PCStateInactive=a.PCWidgetState.extend({name:"inactive",stateSettings:{shouldBeInRoom:!1,UiVisiblity:{}},onEnter:function(){a.PCWidgetState.prototype.onEnter.apply(this,arguments);
var c=h=this,d=(c.getWidgetSettings(),function(a){var d=c.getViewController().getChatModel();c.getWidgetView().$el.find(".purechat-start-chat-button-container button").html("Start Chat"),a.available||"WidgetDisabled"!=a.reason&&"ChatQuotaExceeded"!=a.reason&&"IpIsbanned"!=a.reason||c.getWidgetSettings().set("UnavailableBehavior",1),c.options.get("isPersonalChat")&&!c.getPersonalDetailsView()&&(c.personalDetails=new b.Views.PersonalChatDetails({model:c.options}),c.getWidgetView().personalDetails.show(c.personalDetails),c.setPersonalDetailsView(c.personalDetails),c.personalDetails.triggerMethod("afterInserted")),d.set("operatorsAvailable",a.available);var e=c.options.get("isDemo"),f=e&&c.options.get("requestedState")==b.Constants.WidgetStates.EmailForm;if(a.available){c.getWidgetView().onShow(),c.getWidgetView().setTitle(c.getResource("title_initial"),"title_initial");var g=new n.Model({AskForFirstName:c.getWidgetSettings().get("AskForFirstName"),AskForLastName:c.getWidgetSettings().get("AskForLastName"),AskForEmail:c.getWidgetSettings().get("AskForEmail"),AskForCompany:c.getWidgetSettings().get("AskForCompany"),AskForQuestion:c.getWidgetSettings().get("AskForQuestion"),AskForPhoneNumber:c.getWidgetSettings().get("AskForPhoneNumber"),InitialVisitorFirstName:d.get("visitorFirstName")||"",InitialVisitorLastName:d.get("visitorLastName")||"",InitialVisitorEmail:d.get("visitorEmail")||"",InitialVisitorCompany:d.get("visitorCompany")||"",InitialVisitorQuestion:d.get("visitorQuestion")||"",InitialVisitorPhoneNumber:d.get("visitorPhoneNumber")||""}),h=c.getWidgetSettings().get("StartChatImmediately")?purechatApp.Views.StartChatFormAutomatically:purechatApp.Views.StartChatForm;c.chatForm=new h({viewController:c.getViewController(),rm:c.getResources(),model:g,settings:c.options}),g.on("formSubmit",function(a){c.getViewController().onFormSubmitted(a)}),c.settings.browserIsUnsupported()?d.set("state",b.Constants.WidgetStates.Unsupported):f?d.set("state",b.Constants.WidgetStates.EmailForm):(c.getWidgetView().content.show(c.chatForm),c.listenTo(d,"change:operatorsAvailable",function(a,c){c||d.set("state",b.Constants.WidgetStates.Unavailable)}),c.listenTo(d,"change",function(a){g.set({InitialVisitorName:a.get("visitorName")||"",InitialVisitorFirstName:a.get("visitorFirstName")||"",InitialVisitorLastName:a.get("visitorLastName")||"",InitialVisitorEmail:a.get("visitorEmail")||"",InitialVisitorCompany:a.get("visitorCompany")||"",InitialVisitorQuestion:a.get("visitorQuestion")||"",InitialVisitorPhoneNumber:a.get("visitorPhoneNumber")||""})}),(c.widgetView.model.get("expanded")||0==c.getWidgetSettings().get("UnavailableBehavior"))&&(c.widgetView.model.get("expanded")&&c.getWidgetView().setTitle(c.getResource("title_initial_open"),"title_initial_open"),window._pcDisableAvailabilityPings||c.startAvailabilityPolling()),c.options.get("enableAvailabilityPolling")&&c.startAvailabilityPolling())}else f?d.set("state",b.Constants.WidgetStates.EmailForm):d.set("state",b.Constants.WidgetStates.Unavailable);b.execute("poweredby:reset")});c.getDataController().checkChatAvailable().done(d)},onExit:function(){a.PCWidgetState.prototype.onExit.apply(this,arguments),this.stopListening(this.getViewController().getChatModel())},onExpanded:function(){var a=this.getDataController().checkInRoom();a?this.getChatModel().set("state",b.Constants.WidgetStates.Activating):(this.getWidgetView().setTitle(this.getResource("title_initial_open"),"title_initial_open"),window._pcDisableAvailabilityPings||this.startAvailabilityPolling())},onCollapsed:function(){this.getWidgetView().setTitle(this.getResource("title_initial"),"title_initial"),0!=this.getWidgetSettings().get("UnavailableBehavior")&&this.stopAvailabilityPolling()},startChatAutomatically:function(){var a=e.Deferred(),c=this,d={visitorName:"Visitor"},f=c.getWidgetSettings();return c.getDataController().checkChatAvailable().done(function(e){c.getChatModel().set("operatorsAvailable",e.available),e.available?c.getDataController().startChat(d).done(function(e){purechatApp.Utils.GaEvent(f,"GaTrackingChat","GAChatEvent"),c.getWidgetView().$el.find(".purechat-init-form").find(".general-error").text("").hide(),c.status.chatInfo=e,c.status.initialData=d,c.getChatModel().set("visitorName",d.visitorName),c.getChatModel().set("visitorEmail",d.visitorEmail),c.getChatModel().set("visitorQuestion",d.visitorQuestion),c.getChatModel().set("roomId",e.get("roomId")),c.getChatModel().set("userId",e.get("userId")),c.getChatModel().set("authToken",e.get("authToken")),c.getChatModel().set("chatId",e.get("chatId")),c.getChatModel().set("state",b.Constants.WidgetStates.Chatting),c.getDataController().connectionInfo.persistLocalStorage(),a.resolve()}).fail(function(b){c.log("Error","Unable to start chat. WidgetId: "+c.getWidgetSettings().get("widgetId")+", Message:"+(b||"None"));var d=c.getWidgetView();d.$el.find(".purechat-init-form").find(".general-error").text("Unable to start chat. Please try again").show(),a.reject()}).always(function(){c.submittingChat=!1}):(c.getChatModel().set("state",b.Constants.WidgetStates.Unavailable),a.resolve())}),a.promise()}}),a.addInitializer(function(){}),a.addFinalizer(function(){})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateActivating=a.PCWidgetState.extend({name:"activating",stateSettings:{UiVisiblity:{}},onEnter:function(){var c=this;a.PCWidgetState.prototype.onEnter.apply(this,arguments);new n.Model({userName:c.getChatModel().get("visitorName")});c.options.get("isPersonalChat")&&!c.getPersonalDetailsView()&&(c.personalDetails=new b.Views.PersonalChatDetails({model:c.options}),c.getWidgetView().personalDetails.show(c.personalDetails),c.setPersonalDetailsView(c.personalDetails),c.personalDetails.triggerMethod("afterInserted")),c.showConnectingWithTimeout(),c.clearConnectingTimeout(),c.getChatModel().set("state",b.Constants.WidgetStates.Chatting)}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){function h(a){return e("<div/>").html(a).text()}a.PCStateChatting=a.PCWidgetState.extend({name:"chatting",stateSettings:{shouldBeInRoom:!0,UiVisiblity:{popoutButton:!0,closeButton:!0,requeueButton:!0,cannedResponsesButton:!0}},initialize:function(){a.PCWidgetState.prototype.initialize.apply(this,arguments),this.typing={},this.isUserAlone=!0,this.mobileAnimationInterval=null},onEnter:function(){a.PCWidgetState.prototype.onEnter.apply(this,arguments);var c=this;c.getWidgetView().$el.removeClass("purechat-button-hidden"),c.options.get("isPersonalChat")&&!c.getPersonalDetailsView()&&(c.personalDetails=new b.Views.PersonalChatDetails({model:c.options}),c.getWidgetView().personalDetails.show(c.personalDetails),c.setPersonalDetailsView(c.personalDetails),c.personalDetails.triggerMethod("afterInserted"));var d=(new n.Model({userName:c.getChatModel().get("visitorName")}),this.options.get("StartChatImmediately")),g=c.getChatModel();g.set({isPersonalChat:this.options.get("isPersonalChat"),RequestFromMobileDevice:this.options.get("RequestFromMobileDevice")}),c.messageView=new purechatApp.Views.MessageListView({rm:this.getResources(),model:g,collection:new b.Models.MessageCollectionMessagesGrouped(null,{collection:c.getChatModel().get("messages")}),settings:c.getWidgetSettings(),viewController:c.getViewController()}),c.getWidgetView().content.show(c.messageView),c.listenTo(c.messageView,"showPrevious",function(){if(c.chatModel.get("PreviousTranscriptId")){var a=c.getDataController().getPreviousChat({chatId:c.chatModel.get("PreviousTranscriptId")});a.done(function(a){c.appendPreviousChatResults(a)})}}),c.showConnectingWithTimeout();var h=c.options.get("RequestFromMobileDevice")&&(c.options.get("poppedOut")||c.options.get("isDirectAccess")),i=[c.getDataController().connectToChatServer(this)];if(this.options.get("room")&&1!=this.options.get("room").roomType&&!this.options.get("room").isDemo){var j=c.getDataController().getPreviousChat({chatId:this.options.get("room")?this.options.get("room").id:-1});i.push(j)}e.when.apply(e,i).done(function(a,i){i&&c.appendPreviousChatResults(i),c.clearConnectingTimeout();try{if(!c.chatModel.get("isOperator")&&("undefined"==typeof c.chatModel.get("operators")||0==c.chatModel.get("operators").length)){var j=new Date;j.setTime(0),c.chatModel.get("messages").add({date:j,type:d?"message":"note",message:c.status&&c.status.initialData&&c.status.initialData.initiator&&1==c.status.initialData.initiator?"":c.getResource("chat_startedMessage"),resourceKey:"chat_startedMessage",avatarUrl:c.options.get("isPersonalChat")?personalAvatarUrl||"/content/images/avatars/1avatar-operator-skinny.png":h?"/content/images/avatars/1avatar-operator-skinny.png":null})}f.isFunction(c.getDataController().setCurrentPage)&&!c.options.get("isOperator")&&c.getDataController().setCurrentPage(document.location.href),c.messageView.on("newMessage",function(a){c.getDataController().newMessage(a)}),c.listenTo(c.messageView,"typingChange",function(a){c.getDataController().setTypingIndicator(a)}),c.getWidgetView().$el.find(".purechat-start-chat-button-container button").html('Back to Chat<i style="margin-left: .5em;" class="fa fa-chevron-right"></i>'),c.getWidgetView().onShow(),c.getDataController().sendRoomHistory(),c.getViewController().trigger("stateChanged",b.Constants.WidgetStates.Chatting),c.settings.get("RequestFromMobileDevice")&&c.settings.get("AllowWidgetOnMobile")&&(e(window).trigger("resize.ResizeChatContent"),c.getWidgetView().$el.find(".purechat-send-form-message").off("blur.ResizeWindow").on("blur.ResizeWindow",function(){e(window).trigger("resize.ResizeChatContent")}),c.options.get("isDirectAccess")&&(e(".direct-container-header").css("display","none"),"function"==typeof resizeDirectAccessContainer&&resizeDirectAccessContainer())),c.options.get("isDemo")||c.getWidgetView().$el.find(".purechat-send-form-message").trigger("focus"),c.getWidgetView().trigger("resized"),b.execute("poweredby:reset"),c.getViewController().trigger("chat:start",g.pick(["visitorEmail","visitorName","visitorPhoneNumber","visitorQuestion","visitorFirstName","visitorLastName","visitorCompany"]))}catch(k){console.log(k)}}).fail(function(){c.clearConnectingTimeout(),c.getDataController().connectionInfo.clearLocalStorage(),c.getChatModel().set("state",b.Constants.WidgetStates.Inactive)}),g.on("roomHostChanged",function(){var a=g.get("roomHostAvatarUrl"),b=g.get("roomHostName");c.getWidgetView().showRoomHostAvatar(a),c.getWidgetView().updateRoomHostName(b)})},onSelectionShow:function(){this.messageView.updateScroll()},appendPreviousChatResults:function(a,b){var c=this;a&&a.forEach(function(a){function d(){h=c.convertToUserTime(h),c.chatModel.get("messages").add({date:h,type:"separator",message:e,isClosedChat:!0})}var e=null,f=null,g=0;if(a.Records.forEach(function(a){function d(){1==a.Type?c.onJoined(a.UserId,a.Name,-1,a.Name,a.DateCreatedJsTicks/1e3,!0,!0):2==a.Type?c.onLeft(a.UserId,a.Name,-1,a.Name,a.DateCreatedJsTicks/1e3,!0,!0):c.onMessage(a.UserId,a.Name,-1,a.Name,a.DateCreatedJsTicks/1e3,a.Message,!0,0,0,a.AvatarUrl,a.UserId>0,0,0,!0)}b?(setTimeout(d,g),g+=b):d(),e=a.DateCreatedString+" at "+a.TimeCreatedString,f=a}),null!=e){var h=new Date;h.setTime(f.DateCreatedJsTicks),b?(setTimeout(d,g),g+=b):d()}c.chatModel.set("PreviousTranscriptId",a.Id),a.PreviousTranscriptId?c.chatModel.set("HasMoreTransactions",!0):c.chatModel.set("HasMoreTransactions",!1)})},onExit:function(){a.PCWidgetState.prototype.onExit.apply(this,arguments),this.unbindEvents&&this.unbindEvents(),this.getDataController().unbindHandlerEvents()},onRoomChanged:function(a){this.onRoomDetailsChanged(a.room)},onCloseChat:function(a){var c=this,d=function(a){a.getDataController().closeChat().done(function(){a.getChatModel().set("state",b.Constants.WidgetStates.Closed)}).fail(function(){alert("fail")})},f=c.getWidgetView().$el.find(".purechat-confirm-close-modal"),g=c.getWidgetView().$el.find(".purchat-confirm-close-modal-overlay");a||!c.settings.useMobile()||c.settings.isDesktopDimension()?d(c):(f.css({display:"block"}),g.css({display:"block"}),f.find(".modal-button-bar .btn").off("click.PerformModalAction").on("click.PerformModalAction",function(){var a=e(this);a.hasClass("kill-chat")&&d(c),f.css({display:"none"}),g.css({display:"none"})}))},onExpanded:function(){},flashMobileNotificationIcon:function(){var a=this;if(this.settings.get("RequestFromMobileDevice")&&this.settings.get("AllowWidgetOnMobile")&&"number"!=typeof this.mobileAnimationInterval){var b=this.getWidgetView().$el,c=b.hasClass("purechat-widget-collapsed")&&b.find(".purechat-expanded").is(":visible")?b:[];if(c.length>0){var d=b.find(".purechat-title-image-out-of-way-hilight").filter(":visible");d.addClass("flash");var f=!0;this.mobileAnimationInterval=setInterval(function(){f?(d.removeClass("flash"),f=!1):(d.addClass("flash"),f=!0)},1e3),c.off("click.StopNotification").on("click.StopNotification",function(b){var f=e(b.currentTarget);a.mobileAnimationInterval=clearInterval(a.mobileAnimationInterval),d.removeClass("flash"),c.off("click.StopNotification"),f.trigger("click")})}}},convertToUserTime:function(a){if("undefined"!=typeof CurrentUser&&null!==CurrentUser){var b=CurrentUser.get("isInDaylightSavings"),c=new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds());a=new Date(c.getTime()+6e4*(CurrentUser.get("accountUtcOffset")+(b?60:0)))}return a},onMessage:function(a,c,d,g,h,i,j,k,l,m,n,o,p,q){this.settings.get("avatarUrl");if(this.chatModel.get("isOperator")&&a!=this.chatModel.get("userId")&&notifier.notify("New message!"),null!==i&&"string"==typeof i){var r=new Date;r.setTime(1e3*h),r=this.convertToUserTime(r),this.chatModel.get("messages").add({date:r,type:"message",message:i,userName:c,myMessage:a==this.chatModel.get("userId"),time:r.toHourMinuteString(),avatarUrl:m,fromOperator:n,visitorAvatarUrl:this.settings.get("room")&&this.settings.get("room").visitorAvatarUrl?this.settings.get("room").visitorGravatarHash:"",rootUrl:this.chatModel.get("cdnServerUrl"),userId:a,messageId:p,isClosedChat:q}),a==this.chatModel.get("userId")||j||b.execute("notifications:newMessage")}if(this.chatModel.get("userId")!=a&&0==this.chatModel.get("isOperator")&&1==this.chatModel.get("isWidget")&&0==this.chatModel.get("expanded")&&0==j&&this.getWidgetView().flashNotification(i),this.isUserAlone&&!this.chatModel.get("isOperator")&&!j&&i!=this.chatModel.get("Question")&&!this.chatModel.get("noOperatorMessageSeen")){var r=new Date;r.setTime(1e3*h+1),r=this.convertToUserTime(r),this.chatModel.get("messages").add({date:r,type:"note",message:f.escape(this.getResource("chat_noOperatorMessage")),resourceKey:"chat_noOperatorMessage",isClosedChat:q}),this.chatModel.set("noOperatorMessageSeen",!0)}e("body").trigger("ChatMessageAdded"),this.flashMobileNotificationIcon()},onTyping:function(a,b,c,d,e,f){this.messageView.typing(a,b,e)},onRoomClosed:function(a){this.options.get("isOperator")||localStorage.roomId||this.getDataController().connectionInfo.get("roomId")!=a||this.onCloseChat(!0)},onRoomDestroyed:function(a,c,d,e){this.chatModel.set("closedReasonCode",e),4==e?this.chatModel.set("state",b.Constants.WidgetStates.EmailForm):this.chatModel.set("state",b.Constants.WidgetStates.Closed)},onUserDestroyed:function(){this.chatModel.set("state",b.Constants.WidgetStates.Closed)},onRoomDetailsChanged:function(a){this.chatModel.set({roomHostAvatarUrl:a.roomHostAvatarUrl||null,roomHostName:a.roomHostName||null,visitorEmail:a.visitorEmail||this.chatModel.get("visitorEmail"),visitorName:a.visitorName||this.chatModel.get("visitorName"),visitorPhoneNumber:a.visitorPhoneNumber||this.chatModel.get("visitorPhoneNumber"),visitorFirstName:a.visitorFirstName||this.chatModel.get("visitorFirstName"),visitorLastName:a.visitorLastName||this.chatModel.get("visitorLastName"),visitorCompany:a.visitorCompany||this.chatModel.get("visitorCompany")}),this.getViewController().triggerRoomChangedForApi()},onJoined:function(a,b,c,d,g,i,j){if(this.chatModel.get("isOperator")||a!=this.chatModel.get("userId")){var k=new Date;k.setTime(1e3*g),k=this.convertToUserTime(k),this.chatModel.get("messages").add({date:k,type:"note",important:!0,message:h(f.escape(this.getResource("chat_joinMessage",{displayName:e.trim(b)}))),username:b,resourceKey:"chat_joinMessage",time:k.toHourMinuteString(),isClosedChat:j})}a!=this.chatModel.get("userId")&&(this.isUserAlone=!1,this.chatModel.get("operators").add({userDisplayName:b,userId:a}),this.chatModel.get("operators").length>0?this.chatModel.get("isOperator")||this.getWidgetView().setTitle(h(this.getResource("chat_nowChattingWith",{chatUserNames:this.chatModel.chatUserNames()})),"chat_nowChattingWith"):this.isUserAlone=!0)},onLeft:function(a,b,c,d,f,g,i){if(this.chatModel.get("isOperator")||a!=this.chatModel.get("userId")){var j=new Date;j.setTime(1e3*f),j=this.convertToUserTime(j),this.chatModel.get("messages").add({date:j,type:"note",message:this.getResource("chat_leftMessage",{displayName:e.trim(b)}),resourceKey:"chat_leftMessage",time:j.toHourMinuteString(),isClosedChat:i})}a!=this.chatModel.get("userId")&&(this.chatModel.get("operators").remove(a),!this.chatModel.get("isOperator")&&this.chatModel.chatUserNames().length>0?this.getWidgetView().setTitle(h(this.getResource("chat_nowChattingWith",{chatUserNames:this.chatModel.chatUserNames()})),"chat_nowChattingWith"):this.getWidgetView().setTitle(h(this.getResource("title_initial")),"title_initial"))}}),a.addInitializer(function(){b.commands.setHandler("roomclosed",function(a){"undefined"!=typeof _pcwi&&_pcwi.state.triggerMethod("roomClosed",a)})})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateClosed=a.PCWidgetState.extend({name:"closed",stateSettings:{shouldBeInRoom:!1,UiVisiblity:{restartButton:!0,removeWidgetButton:!0}},handleRoomClose:function(a,c){var d=this,g="undefined"!=typeof a&&null!==a&&"string"==typeof a.visitorIPAddress?a.visitorIPAddress:"",h="undefined"!=typeof a&&null!==a&&a.Id?a.Id:-1,i="undefined"!=typeof c&&null!==c&&"string"==typeof c.name?c.name:"",j="undefined"!=typeof c&&null!==c&&"string"===c.visitorReferer?c.visitorReferer:"",k="undefined"!=typeof c&&null!==c&&"undefined"!=typeof c.id?c.id:"";d.options.get("isOperator")&&c.roomType&&c.roomType==PureChat.enums.roomType.visitor&&e.ajax({url:"/ExternalApps",type:"GET",data:{chatId:d.getDataController().connectionInfo.get("roomId")}}).done(function(a){var b=e(d.getWidgetView().el);f.each(a,function(a,c){b.find("#export-"+c).toggle(a)})}),d.getWidgetView().$el.removeClass("purechat-button-hidden"),d.getWidgetView().onShow(),localStorage.expanded=!1,d.getDataController().connectionInfo.set("chatClosed",!0),d.getDataController().connectionInfo.persistLocalStorage(),d.getWidgetView().setTitle(d.getResource("title_chatClosed"),"title_chatClosed");var l=new n.Model({isOperator:d.chatModel.get("isOperator"),roomId:k,visitorIPAddress:g,visitorIPAddressId:h,visitorName:i,visitorReferrer:j,closedReasonCode:d.chatModel.get("closedReasonCode")});d.chatModel.get("isOperator")?l.set({GoogId:"",GaTrackingTab:!1,GaTrackingChat:!1,GaTrackingThumbs:!1,GAUpThumbEvent:!1,GADownThumbEvent:!1,GAEventCategory:!1,UsingGa:!1}):l.set({GoogId:d.getWidgetSettings().get("GoogId"),GaTrackingTab:d.getWidgetSettings().get("GaTrackingTab"),GaTrackingChat:d.getWidgetSettings().get("GaTrackingChat"),GaTrackingThumbs:d.getWidgetSettings().get("GaTrackingThumbs"),GAUpThumbEvent:d.getWidgetSettings().get("GAUpThumbEvent"),GADownThumbEvent:d.getWidgetSettings().get("GADownThumbEvent"),GAEventCategory:d.getWidgetSettings().get("GAEventCategory"),UsingGa:d.getWidgetSettings().get("UsingGa"),AskForRating:d.getWidgetSettings().get("AskForRating"),CtaButton:d.getWidgetSettings().get("CtaButton"),DownloadTranscript:d.getWidgetSettings().get("DownloadTranscript")});var m={rm:d.getResources(),model:l,settings:d.options,chatModel:d.chatModel},o=d.options.get("isOperator");this.closeMessage=o?new b.Views.ClosedOperatorView(m):new b.Views.ClosedMessage(m),d.listenTo(this.closeMessage,"chat:rated",function(a){d.getDataController().rateChat(a),a?purechatApp.Utils.GaEvent(d.getWidgetSettings(),"GaTrackingThumbs","GAUpThumbEvent"):purechatApp.Utils.GaEvent(d.getWidgetSettings(),"GaTrackingThumbs","GADownThumbEvent"),d.getViewController().triggerResizedEvent(),d.getViewController().trigger("chat:rate",{rating:a})}),d.getWidgetView().content.show(this.closeMessage),o&&this.closeMessage.renderMessageList(),d.getWidgetView().hideRoomHostAvatar(),d.chatModel.set({roomHostAvatarUrl:null,roomHostName:null}),d.options.get("isDirectAccess")&&(e(".direct-container-header").css("display","block"),"function"==typeof resizeDirectAccessContainer&&resizeDirectAccessContainer()),b.execute("poweredby:update","Love chatting? Add <a "+(d.options.get("isPersonalChat")?"":'style="font-size: 10px !important;"')+' href="https://purechat.com" target="_blank">Pure Chat</a> to your site for free!'),f.isFunction(d.getDataController().unbindHandlerEvents)&&d.getDataController().unbindHandlerEvents(),d.getViewController().trigger("chat:end",d.chatModel.pick(["visitorEmail","visitorName","visitorPhoneNumber","visitorQuestion","visitorFirstName","visitorLastName","visitorCompany"]))},onSelectionShow:function(){this.closeMessage.updateScroll()},onEnter:function(){a.PCWidgetState.prototype.onEnter.apply(this,arguments);var c=this,d=this.options.get("room")||{};c.getWidgetView().chatAutoStarted=!1,c.options.get("isPersonalChat")&&!c.getPersonalDetailsView()&&(c.getWidgetView().$el.find(".purechat-start-chat-button-container button").html('Back to Chat<i style="margin-left: .5em;" class="fa fa-chevron-right"></i>'),c.personalDetails=new b.Views.PersonalChatDetails({model:c.options}),c.getWidgetView().personalDetails.show(c.personalDetails),c.setPersonalDetailsView(c.personalDetails),c.personalDetails.triggerMethod("afterInserted")),c.chatModel.get("isOperator")?isNaN(parseInt(d.id))?c.handleRoomClose(null,d):e.ajax({type:"get",dataType:"json",url:"/api/Widgets/GetVisitorIPAddress/"+(d.id||-1)}).done(function(a){c.handleRoomClose(a,d)}):c.handleRoomClose(null,null)},onExport:function(a){var b={};b.chatId=this.options.get("room").id,b.visitorEmail=this.options.get("room").visitorEmail,b.visitorName=this.options.get("room").visitorName,pcDashboard.execute("export:"+a.app,b)},onRestartChat:function(){var a=this,c=this.getDataController().checkInRoom();localStorage.expanded=!0,this.syncWithContact().done(function(){c?this.getChatModel().set("state",b.Constants.WidgetStates.Activating):a.getDataController().restartChat().done(function(){a.getChatModel().restartChat(),a.getViewController().resetVisitorQuestion(),a.getViewController().trigger("widget:restart")}).fail(function(){})})}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateUnavailable=a.PCWidgetState.extend({name:"unavailable",stateSettings:{shouldBeInRoom:!1},onEnter:function(){a.PCWidgetState.prototype.onEnter.apply(this,arguments);var c=this,d=this.settings.get("IPIsBanned")?1:c.options.get("UnavailableBehavior");if(c.getWidgetView().$el.find(".purechat-start-chat-button-container button").html("Start Chat"),0==d)c.getWidgetView().onHide();else if(1==d)c.getWidgetView().onShow(),c.widgetView.model.get("expanded")?c.getWidgetView().setTitle(this.getResource("title_noOperators"),"title_noOperators"):c.getWidgetView().setTitle(c.getResource("title_initial"),"title_initial"),e(c.getWidgetView().content.el).html('<div data-resourcekey="error_noOperators" class="purechat-closedmessage-container purechat-no-operators">'+b.Utils.linkify(this.getResource("error_noOperators"))+"</div>"),this.options.get("isPersonalChat")&&this.options.get("isInEditorMode")&&window.pcPersonalEditor&&window.pcPersonalEditor.execute("editButton:show",e(c.getWidgetView().content.el).find("[data-resourcekey]"));else{c.getWidgetView().onShow(),c.widgetView.model.get("expanded")?c.settings.get("isPersonalChat")?c.getWidgetView().setTitle(this.getResource("title_noOperators"),"title_noOperators"):c.getWidgetView().setTitle(this.getResource("title_emailForm"),"title_emailForm"):c.getWidgetView().setTitle(c.getResource("title_initial"),"title_initial");var f=new n.Model({AskForFirstName:c.settings.get("AskForFirstName"),AskForLastName:c.settings.get("AskForLastName"),AskForEmail:!0,AskForCompany:c.settings.get("AskForCompany"),AskForQuestion:!0,AskForPhoneNumber:c.settings.get("AskForPhoneNumber"),EmailForm:!0,InitialVisitorFirstName:c.getViewController().getChatModel().get("visitorFirstName")||"",InitialVisitorLastName:c.getViewController().getChatModel().get("visitorLastName")||"",InitialVisitorEmail:c.getViewController().getChatModel().get("visitorEmail")||"",InitialVisitorCompany:c.getViewController().getChatModel().get("visitorCompany")||"",InitialVisitorQuestion:c.getViewController().getChatModel().get("visitorQuestion")||"",InitialVisitorPhoneNumber:c.getViewController().getChatModel().get("visitorPhoneNumber")||""});f.on("formSubmit",function(a){var d=e(c.getWidgetView().el).find(".purechat-form.purechat-email-form");b.execute("spinner:show",d),c.getDataController().submitEmailForm(a).done(function(b){if(b.success){var e=new purechatApp.Views.EmailSent({rm:c.getResources(),model:f});c.getWidgetView().content.show(e),c.getWidgetView().ui.restartButton.show(),c.getWidgetView().$el.find(".btn-restart").on("click.RestartChat",function(a){c.restartChat.call(c,a)}),c.getViewController().trigger("email:send",a)}else d.find(".purechat-email-error").css({display:"block"})}).fail(function(){}).always(function(){b.execute("spinner:show",d)})});var g=new purechatApp.Views.StartChatForm({viewController:c.getViewController(),rm:c.getResources(),model:f,settings:this.options,FormType:"email"});c.getWidgetView().content.show(g)}c.listenTo(c.getChatModel(),"change:operatorsAvailable",function(a,d){d&&c.getChatModel().set("state",b.Constants.WidgetStates.Inactive)});var h=0==c.getWidgetSettings().get("UnavailableBehavior");(c.widgetView.model.get("expanded")&&!h||h&&c.getChatModel().get("operatorsAvailable")||c.options.get("enableAvailabilityPolling"))&&(window._pcDisableAvailabilityPings||c.startAvailabilityPolling())},onExpanded:function(){var a=this,c=this.getDataController().checkInRoom();if(c)this.getChatModel().set("state",b.Constants.WidgetStates.Activating);else{var d=this.settings.get("IPIsBanned")?1:a.options.get("UnavailableBehavior");1==d?a.getWidgetView().setTitle(this.getResource("title_noOperators"),"title_noOperators"):a.getWidgetView().setTitle(this.getResource("title_emailForm"),"title_emailForm"),window._pcDisableAvailabilityPings||this.startAvailabilityPolling()}},onCollapsed:function(){this.getWidgetView().setTitle(this.getResource("title_initial")),0!=this.getWidgetSettings().get("UnavailableBehavior")&&this.stopAvailabilityPolling()},restartChat:function(a){a.stopPropagation();var b=e(a.currentTarget),c=this;b.off("click.RestartChat"),c.getDataController().restartChat().done(function(){c.getChatModel().restartChat(),c.getViewController().resetVisitorQuestion(),c.getViewController().trigger("widget:restart")}).fail(function(){throw new Error("Failed to send email. Please try again!")})}})},purechatApp.Models),purechatApp.module("Controllers.States",function(a,b,c,d,e,f,g){a.PCStateUnsupported=a.PCWidgetState.extend({name:"unsupported",stateSettings:{UiVisiblity:{}},onEnter:function(){var c=this;a.PCWidgetState.prototype.onEnter.apply(this,arguments),c.getWidgetView().content.show(new b.Views.UnsupportedBrowser)}})},purechatApp.Models),purechatApp.module("Controllers",function(a,b,c,d,e,f,g){var h=d.Controller.extend({getCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""},resetExpandedForMobile:function(){},getPreviousChat:function(a){var b=e.Deferred();return b.resolve([]),b.promise()},getContactInfo:function(){var a=e.Deferred(),b=this.getCookie("_PCCID"),c=d.getOption(this,"widgetId");return b&&c?e.ajax({url:d.getOption(this,"pureServerUrl")+"/api/contact/widget/"+d.getOption(this,"widgetId")+"/"+b}).done(function(b){a.resolve(b)}).fail(function(){console.log("Error obtaining contact details")}):setTimeout(function(){a.resolve()},0),a},initialize:function(){var a=this;this.sentChatRequest=!1,this.connectionInfo=new purechatApp.Models.ChatConnection({},this.options),this.options.connectionInfo&&this.connectionInfo.set(this.options.connectionInfo),this._originalGetWidgetSettings=this.getWidgetSettings,this.getWidgetSettings=function(){var b=e.Deferred();return a._originalGetWidgetSettings.apply(a,arguments).done(function(a){a.widgetConfig&&a.widgetConfig.AllowWidgetOnMobile&&a.widgetConfig.RequestFromMobileDevice&&(localStorage.expanded=!1),b.resolve(a)}),b.promise()}},unbindHandlerEvents:function(){},loadWidgetSettings:function(){var a=this,b=e.Deferred();return this.getWidgetSettings().done(function(c){a.widgetSettings=c,b.resolve()}).fail(function(){b.reject()}),b}}),i=h.extend({initialize:function(){h.prototype.initialize.apply(this,arguments),this.chatAvailable="function"==typeof this.setDemoUnavailable?!this.setDemoUnavailable():!0},startChat:function(a){return this.connectionInfo.set("userId",1),this.connectionInfo.set("authToken","adsfasfdsdf"),this.connectionInfo.set("roomId",1),e.Deferred().resolve(this.connectionInfo)},closeChat:function(a){return e.Deferred().resolve()},getContactInfo:function(){var a=e.Deferred();return setTimeout(function(){a.resolve({firstName:"",lastName:"",company:"",email:"",phone:""})},0),a},restartChat:function(a){return e.Deferred().resolve()},connectToChatServer:function(a){var b=e.Deferred();return this.handler=a,setTimeout(function(){b.resolve()},0),b},sendRoomHistory:function(a){},checkInRoom:function(){return!1},newMessage:function(a){var b=new Date,c=b.getHours(),e=b.getMinutes(),f=b.getSeconds(),g=c>=12;c=10>c?c:12==c?c:c%12,e=10>e?"0"+e:e,f=10>f?"0"+f:f,d.getOption(this,"chatModel").get("messages").add({userId:b.getTime(),type:"message",message:a,myMessage:!0,userName:"Aaron",time:c+":"+e+" "+f+(g?"PM":"AM"),date:b,avatarUrl:"/content/images/avatars/visitor-avatar-thick.png"})},checkChatAvailable:function(a){var b=this,c=e.Deferred();return setTimeout(function(){c.resolve({available:b.chatAvailable})},1),c},getWidgetSettings:function(){var a={Version:27288,WidgetWording:{Id:721,AccountId:0,Title:"Chat with us test."},AccountId:1,Color:"000000",Position:2,WidgetType:1,UnavailableBehavior:2,AskForRating:!0,AskForFirstName:!0,AskForLastName:!0,AskForEmail:!1,AskForCompany:!0,AskForQuestion:!0,ForcePopout:!1,StringResources:{chat_identifyFailed:"Failed to connect to PureChat!",greeting:"Hello",closed_message:"Thanks for chatting. Please rate how you feel about the chat session:",closed_opMessage:"This chat has ended.<br/>What would you like to do?",chat_joinMessage:"{displayName} has joined the chat!",placeholder_email:"Email",chat_connecting:"Connecting you to the chat now...",chat_nowChattingWith:"Chatting with {chatUserNames}.",label_pressToBegin:"Press the button below to begin!",error_enterEmail:"Please enter an email address.",closed_downloadTrans:"Download chat transcript",title_noOperators:"No Operators Available",error_enterQuestion:"Please enter a question",noOperators_email_message:"There are currently no operators available, but feel free to send us an email!",poweredby:"Powered by",chat_noOperatorMessage:"An operator has not yet connected. Don't worry, an operator will be by shortly! When they connect, they'll see all the messages you've sent so far.",chat_typing:"{displayName} is typing",title_chatClosed:"Chat Closed",closed_ratingThanks:"Thanks for your rating!",placeholder_name:"Name",placeholder_firstName:"First Name",placeholder_lastName:"Last Name",placeholder_comapny:"Company",title_initial:"Chat with us test.",placeholder_question:"Enter your Question",
label_initial_label:"Introductory Text",title_initial_label:"Widget Title",error_noOperators:"Sorry, no operators are currently available",label_initial:"Enter your info below to begin.",error_noOperators_label:"No Operators Available",button_startChat:"Send Chat Request",label_initial_helptext:"This is the introductory text that will be displayed after the user clicks on the PureChat widget.",button_sendEmail:"Send Email",chat_startedMessage:"An operator will be right with you! Feel free to hide this box and navigate around the site.",chat_leftMessage:"{displayName} has left the chat!",chat_connectionFailed:"Failed to connect to PureChat!",button_startNewChat:"Start a new chat",error_noOperators_helptext:"This is the message that will be displayed when Hide Widget When Unavailable is unchecked, and there are no operators available.",error_enterName:"Please enter a name."},GoogId:"UA-XXXX-Y",GaTrackingTab:!1,GaTrackingChat:!1,GaTrackingThumbs:!1,GATabEvent:"Tab Opened",GAChatEvent:"Chat Started",GAUpThumbEvent:"Thumbs Up",GADownThumbEvent:"Thumbs Down",GAEventCategory:"PureChat widget",UsingGa:!1,ChatServerUrl:"http://chad.purechat.com:8000",DisplayWidgetAnimation:"bounceInDown",CollapsedWidgetImageUrl:"http://chad.purechat.com/Content/images/widgetSamples/operator1.png"};return e.Deferred().resolve(a)},rateChat:function(a){var b=e.Deferred();return b.resolve()},setTypingIndicator:function(a){},bindEvents:function(a){this.handler=a}}),j=i.extend({getWidgetSettings:function(){var a=e.Deferred();return window.parent&&window.parent.currentWidgetSettings?a.resolve(window.parent.currentWidgetSettings.attributes):this.options.isPersonalChat&&window.pcPersonalEditorSettings?(window.pcPersonalEditorSettings.set({dataController:window.pcDataController,renderInto:window.pcRenderInto}),a.resolve(window.pcPersonalEditorSettings.attributes)):e.ajax({url:d.getOption(this,"pureServerUrl")+"/VisitorWidget/Widget/"+d.getOption(this,"widgetId")+window.location.search,dataType:"jsonp",timeout:2e4,success:function(b){b.UserWidgetSettings=new c.Model(b.UserWidgetSettings);var d={success:!0,version:b.Version,accountId:b.AccountId,color:b.Color,position:b.Position,widgetType:b.WidgetType,widgetConfig:b,resources:b.StringResources,googleAnalytics:b.GoogleAnalytics,chatServerUrl:b.ChatServerUrl,ShowMinimizeWidgetButton:b.ShowMinimizeWidgetButton,userWidgetConfig:b.UserWidgetSettings};a.resolve(d)},error:function(b,c,d){a.reject()}}),a.promise()},isDemo:function(){return d.getOption(this,"isDemo")},setDemoUnavailable:function(){return d.getOption(this,"setOperatorsUnavailable")}}),k=h.extend({sessionTimeout:12e5,timeStampUrl:function(a){var b=new Date;return a.indexOf("?")>=0?a+"&t="+b.getTime():a+"?t="+b.getTime()},closeChat:function(a){return this.chatServerConnection.destroyself(null,a),e.Deferred().resolve()},leaveChat:function(){return this.chatServerConnection.leave(this.connectionInfo.get("roomId")),e.Deferred().resolve()},restartChat:function(a){return this.connectionInfo.clearLocalStorage(),e.Deferred().resolve()},newMessage:function(a){return""==e.trim(a)?!1:""==e.trim(a)?!1:void this.chatServerConnection.sendmessage(a,this.connectionInfo.get("roomId"))},checkChatAvailable:function(a){var b=this;a=a||this.widgetSettings.accountId;var c=!1;if(this.options.BrowserDetails){var f=this.options.BrowserDetails.Version,g=parseInt(f);("Opera"==this.options.BrowserDetails.Browser&&12>g||"InternetExplorer"==this.options.BrowserDetails.Browser.replace(/\s+/g,"")&&9>=g||"Safari"==this.options.BrowserDetails.Browser&&5>g&&g>0)&&(c=!0)}if(!window._checkChatAvailableDeferred)if(window._checkChatAvailableDeferred=e.Deferred(),c)setTimeout(function(){window._checkChatAvailableDeferred.resolve({a:0,r:2})},300);else{var h={accountId:a,widgetId:this.options?this.options.connectionSettings&&this.options.connectionSettings.c?this.options.connectionSettings.c:this.options.widgetId||this.options.Id:null},i=d.getOption(this,"pureServerUrl")+"/VisitorWidget/ChatAvailable/"+h.accountId+"/"+h.widgetId+"/_PCcb?externalRequest=false";e.ajax({url:b.timeStampUrl(i),dataType:"jsonp",timeout:2e4,jsonpCallback:"_PCcb",error:function(){window._checkChatAvailableDeferred.reject(),window._checkChatAvailableDeferred=null}})}return window._checkChatAvailableDeferred.promise()},getWidgetSettings:function(){var a=this,b="boolean"==typeof d.getOption(this,"hasAllSettings")?d.getOption(this,"hasAllSettings"):!1,f=e.Deferred();return b?f.resolve({success:!0,version:d.getOption(this,"Version"),accountId:d.getOption(this,"AccountId"),color:d.getOption(this,"Color"),position:d.getOption(this,"Position"),widgetType:d.getOption(this,"WidgetType"),widgetConfig:this.options,resources:d.getOption(this,"StringResources"),googleAnalytics:d.getOption(this,"GoogleAnalytics"),chatServerUrl:d.getOption(this,"ChatServerUrl"),userWidgetConfig:d.getOption(this,"UserWidgetSettings")}):e.ajax({url:d.getOption(this,"pureServerUrl")+"/VisitorWidget/Widget/"+d.getOption(this,"widgetId"),dataType:"jsonp",timeout:2e4,success:function(b){if(b.Valid){0==b.UnavailableBehavior&&a.options.isDirectAccess&&(b.UnavailableBehavior=1),b.UserWidgetSettings=new c.Model(b.UserWidgetSettings);var d={success:!0,version:b.Version,accountId:b.AccountId,color:b.Color,position:b.Position,widgetType:b.WidgetType,widgetConfig:b,resources:b.StringResources,googleAnalytics:b.GoogleAnalytics,chatServerUrl:b.ChatServerUrl,userWidgetConfig:b.UserWidgetSettings};f.resolve(d)}},error:function(a,b,c){f.reject()}}),f.promise()},submitEmailForm:function(a){var b,c=null;try{b=this.cleanNulls(localStorage.getItem("i")),this.isActiveSession()&&(c=this.cleanNulls(localStorage.getItem(this.getSessionItemName())))}catch(f){}a.widgetId=d.getOption(this,"widgetId"),a.startPage=a.origin||window.location.toString()||"unknown",a.acquisitionSource=localStorage.acquisitionSource||"Direct",a.pccId=b,a.pccsId=c;var g=e.Deferred();return e.ajax({url:d.getOption(this,"pureServerUrl")+"/VisitorWidget/SendEmail",dataType:"jsonp",type:"GET",data:a}).done(function(a){try{response.customerId&&localStorage.setItem("i",response.customerId)}catch(b){}g.resolve(a)}).fail(function(){}),g.promise()},cleanNulls:function(a){return"null"==a?void 0:null==a?void 0:a},getSessionItemName:function(){return"s_"+this.widgetSettings.accountId},getLastCheckinItemName:function(){return"lastCheckin_"+this.widgetSettings.accountId},isActiveSession:function(){var a,b=Date.now();this.getLastCheckinItemName();return a=this.cleanNulls(localStorage.getItem(this.getLastCheckinItemName())),!(a&&b-a>=this.sessionTimeout)},startChat:function(a){var b,c=this,f=e.Deferred(),g=null;try{b=this.cleanNulls(localStorage.getItem("i")),this.isActiveSession()&&(g=this.cleanNulls(localStorage.getItem(this.getSessionItemName())))}catch(h){}var i=a.visitorName,j=a.visitorFirstName,k=a.visitorLastName,l=a.visitorCompany,m=d.getOption(this,"pureServerUrl")+"/VisitorWidget/Chat/"+d.getOption(this,"widgetId")+"?visitorName="+encodeURIComponent(i||"")+"&visitorFirstName="+encodeURIComponent(j||"")+"&visitorLastName="+encodeURIComponent(k||"")+"&visitorCompany="+encodeURIComponent(l||"")+"&origin="+encodeURIComponent(a.origin||window.location.toString()||"unknown")+"&expandSource="+(window.localStorage.getItem("expandSource")||"")+"&acquisitionSource="+(localStorage.acquisitionSource||"Direct")+"&operatorJoinIds="+encodeURIComponent((a.operatorJoinIds||[]).join(","))+"&initiator="+encodeURIComponent(a.initiator||"")+"&startedByOperator="+(a.startedByOperator||!1).toString()+"&pccid="+b+"&pccsid="+g+"&sentChatRequest="+(this.sentChatRequest||!1).toString();return a.visitorEmail&&(m+="&visitorEmail="+encodeURIComponent(a.visitorEmail)),a.visitorPhoneNumber&&(m+="&visitorPhoneNumber="+encodeURIComponent(a.visitorPhoneNumber)),a.visitorQuestion&&1!=a.initiator&&(m+="&visitorQuestion="+encodeURIComponent(a.visitorQuestion)),this.sentChatRequest||(this.sentChatRequest=!0),e.ajax({url:m,dataType:"jsonp",timeout:2e4,success:function(a){if(a.user&&a.room){try{a.customerId&&localStorage.setItem("i",a.customerId)}catch(b){}c.connectionInfo.set({userId:a.user.id,authToken:a.user.authToken,roomId:a.room.id,chatId:a.chat.id,chatClosed:!1}),c.widgetSettings.chatServerUrl=a.server.url,f.resolve(c.connectionInfo)}else"undefined"!=typeof connectingView&&null!==connectingView&&connectingView.showErrorMessage(a.message),f.reject(a.message);f.resolve()},error:function(a,b,c){f.reject(b+", "+c)},complete:function(){setTimeout(function(){c.sentChatRequest=!1},0)}}),f},connectToChatServer:function(a){function b(a,b,e,f){c=!0,0==a?d.reject():d.resolve()}var c,d=e.Deferred(),f=f||this.widgetSettings.accountId;return this.chatServerConnection?(this.chatServerConnection.identify(this.connectionInfo.get("userId"),f,this.connectionInfo.get("authToken"),b,"boolean"==typeof this.options.connectionSettings.poppedOut?this.options.connectionSettings.poppedOut:!1),a&&this.bindEvents(a)):(this.chatServerConnection=new PureChat(this.widgetSettings.chatServerUrl+"/client",this.connectionInfo.get("userId"),f,this.connectionInfo.get("authToken"),b,function(){c||d.reject()},null,"boolean"==typeof this.options.connectionSettings.poppedOut?this.options.connectionSettings.poppedOut:!1),a&&this.bindEvents(a)),d},setTypingIndicator:function(a){this.chatServerConnection.sendtyping(this.connectionInfo.get("roomId"),a)},rateChat:function(a){var b=e.Deferred();return e.ajax({url:d.getOption(this,"pureServerUrl")+"/VisitorWidget/Rate",dataType:"jsonp",data:{chatId:this.connectionInfo.get("chatId"),rating:a,authToken:this.connectionInfo.get("authToken")}}).done(function(){}).fail(function(){}),b.promise()},checkInRoom:function(){return this.connectionInfo.isInChat()||this.connectionInfo.loadFromLocalStorage().isInChat()},setCurrentPage:function(a){this.chatServerConnection.setVisitorDetails(this.connectionInfo.get("roomId"),{visitorReferer:a})},sendRoomHistory:function(a){this.chatServerConnection.sendroomhistory(a||this.connectionInfo.get("roomId"))},unbindHandlerEvents:function(){h.prototype.unbindHandlerEvents.apply(this,arguments),this.unbindHandlerEventsImpl&&this.unbindHandlerEventsImpl()},bindEvents:function(a){var b=this;b.handler=a;var c={message:function(c,d,e,f,g,h,i,j){b.connectionInfo.get("roomId")==e&&(h=h.replace("response below to see hos it works","response below to see how it works"),a.onMessage.apply(a,arguments))},joined:function(c,d,e,f,g,h){b.connectionInfo.get("roomId")==e&&a.onJoined.apply(a,arguments)},left:function(c,d,e,f,g,h){b.connectionInfo.get("roomId")==e&&a.onLeft.apply(a,arguments)},roomdestroyed:function(c,d,e){b.connectionInfo.get("roomId")==c&&a.onRoomDestroyed.apply(a,arguments)},typing:function(c,d,e,f,g,h){b.connectionInfo.get("userId")!=c&&b.connectionInfo.get("roomId")==e&&a.onTyping.apply(a,arguments)},userDestroyed:function(c){b.connectionInfo.get("userId")==c&&a.onRoomDestroyed.apply(a)},roomdetailschanged:function(c){b.connectionInfo.get("roomId")==c.id&&a.onRoomDetailsChanged.apply(a,arguments)},roomchanged:function(c){b.connectionInfo.get("roomId")==c.room.id&&a.onRoomChanged.apply(a,arguments)},noOperatorJoined:function(c){b.connectionInfo.get("roomId")==c.roomId&&a.onNoOperatorJoined.apply(a,arguments)}};b.unbindHandlerEventsImpl=function(){b.chatServerConnection.off(c),b.handler=null},b.chatServerConnection.on(c)}}),l=k.extend({initialize:function(a){h.prototype.initialize.apply(this,arguments),this.chatServerConnection=a.chatServerConnection},closeChat:function(){return this.chatServerConnection.closeroom(this.connectionInfo.get("roomId")),this.sentChatRequest=!1,e.Deferred().resolve()},connectToChatServer:function(a){var b=e.Deferred();return a&&this.bindEvents(a),b.resolve()},htmlEncode:function(a){return e("<div/>").text(a).html()},getPreviousChat:function(a){var b=e.Deferred(),c=this;return a=f.defaults(a,{includeMessages:!0,previousCount:1}),e.ajax({url:"/api/transcripts/related/"+a.chatId,dataType:"json",data:a,type:"get",success:function(a){a.forEach(function(a){a.Records.forEach(function(a){a.Message=c.htmlEncode(a.Message)})}),b.resolve(a)},error:function(){b.resolve(null)}}),b.promise()},getWidgetSettings:function(){var a=e.Deferred();return e.ajax({url:"/User/DashboardSettings",dataType:"json",type:"post",success:function(b){var c={success:!0,authToken:b.authToken,version:"",accountId:b.accountId,userId:b.userId,position:null,widgetType:null,widgetConfig:b,resources:{},googleAnalytics:null,chatServerUrl:b.chatServerUrl};a.resolve(c)}}),a.promise()},checkInRoom:function(){return!!this.connectionInfo.get("roomId")}});a.DemoDataController=j,a.DashboardDataController=l,a.PCDataController=k},purechatApp.Models),purechatApp.module("Controllers",function(a,b,c,d,e,f,g){a.PureChatApiController=d.Controller.extend({_publicApi:null,changeableRoomDetails:["visitorName","visitorFirstName","visitorLastName","visitorEmail","visitorReferer","visitorPhoneNumber","additionalDetails"],getPublicApi:function(){return this._publicApi},getBaseApiEventObject:function(){return{chatboxId:this.options.get("Id")}},extendBaseApiEventObject:function(a){return e.extend(this.getBaseApiEventObject(),a||{})},bindWidgetLayoutPublicApiEvents:function(){var a=this;a.widgetLayout.on("widget:resized",function(b){a.getPublicApi().trigger("resized",{widgetId:a.getChatModel().id}),a.getPublicApi().trigger("chatbox:resize",a.extendBaseApiEventObject({width:b.width,height:b.height}))}),a.widgetLayout.on("expanded",function(){a.getPublicApi().trigger("chatbox:expand",a.extendBaseApiEventObject())}),a.widgetLayout.on("collapsed",function(){a.getPublicApi().trigger("chatbox:collapse",a.extendBaseApiEventObject())}),a.widgetLayout.on("minimized",function(){a.getPublicApi().trigger("chatbox:minimize",a.extendBaseApiEventObject())})},bindOptionsPublicApiEvents:function(){var a=this;a.options.on("change:Position",function(){a.widgetLayout.repositionWidget()})},bindChatModelPublicApiEvents:function(){var a=this;a.getChatModel().on("widget:available widget:unavailable",function(){a.getPublicApi().trigger("chatbox.available:change",a.extendBaseApiEventObject({available:a.getChatModel().get("operatorsAvailable")}))}),a.getChatModel().on("operator:join",function(b){a.getPublicApi().trigger("chat:operatorJoin",a.extendBaseApiEventObject({operatorName:b.get("userDisplayName")}))}),a.getChatModel().on("operator:leave",function(b){a.getPublicApi().trigger("chat:operatorLeave",a.extendBaseApiEventObject({operatorName:b.get("userDisplayName")}))}),a.getChatModel().on("change:visitorName",function(a,b){}),a.getChatModel().on("change:visitorFirstName",function(b,c){a.getPublicApi().trigger("visitor.firstName:change",a.extendBaseApiEventObject({firstName:c})),a.getPublicApi().trigger("visitor.name:change",a.extendBaseApiEventObject({name:b.getFullName()}))}),a.getChatModel().on("change:visitorLastName",function(b,c){a.getPublicApi().trigger("visitor.lastName:change",a.extendBaseApiEventObject({lastName:c})),a.getPublicApi().trigger("visitor.name:change",a.extendBaseApiEventObject({name:b.getFullName()}))}),a.getChatModel().on("change:visitorCompany",function(b,c){a.getPublicApi().trigger("visitor.company:change",a.extendBaseApiEventObject({company:c}))}),a.getChatModel().on("change:visitorEmail",function(b,c){a.getPublicApi().trigger("visitor.email:change",a.extendBaseApiEventObject({email:c}))}),a.getChatModel().on("change:visitorPhoneNumber",function(b,c){a.getPublicApi().trigger("visitor.phoneNumber:change",a.extendBaseApiEventObject({phoneNumber:c}))}),a.getChatModel().on("change:visitorQuestion",function(b,c){a.getPublicApi().trigger("visitor.question:change",a.extendBaseApiEventObject({question:c}))}),a.getChatModel().on("chat:restart",function(){a.getPublicApi().trigger("chatbox:restart",a.extendBaseApiEventObject())})},bindViewControllerPublicApiEvents:function(){var a=this;this.on("chat:start",function(b){a.getPublicApi().trigger("chat:start",a.extendBaseApiEventObject(a.getPublicApi().reverseMapVisitorDetails(b)))}),this.on("chat:end",function(b){a.getPublicApi().trigger("chat:end",a.extendBaseApiEventObject(a.getPublicApi().reverseMapVisitorDetails(b)))}),this.on("chat:rate",function(b){a.getPublicApi().trigger("chat:rate",a.extendBaseApiEventObject(b))}),this.on("widget:poppedOut",function(){a.getPublicApi().trigger("chatbox:poppedOut",a.extendBaseApiEventObject())}),this.on("email:send",function(b){a.getPublicApi().trigger("email:send",a.extendBaseApiEventObject(a.getPublicApi().reverseMapVisitorDetails(b)))})},registerPublicApiEvents:function(){var a=this;this._publicApi||(this._publicApi=new b.Api.Models.ApiModel,this._publicApi.setViewController(this)),a.on("state:changed",function(b){var c={widgetId:a.getChatModel().id,state:b.newState.name};b.oldState&&(c.previousState=b.oldState.name),a.getPublicApi().trigger("widget:state-changed",a.extendBaseApiEventObject(c)),a.getPublicApi().trigger("chatbox:state-changed",a.extendBaseApiEventObject(c))}),this.on("widget:ready",function(){a.bindWidgetLayoutPublicApiEvents(),a.bindOptionsPublicApiEvents(),a.bindChatModelPublicApiEvents();try{a.getPublicApi().trigger("ready",a.extendBaseApiEventObject())}catch(b){console.error(b)}try{a.getPublicApi().trigger("chatbox:ready",a.extendBaseApiEventObject())}catch(b){console.error(b)}}),this.bindViewControllerPublicApiEvents()},apiRoomDetailsChanged:function(a,b,c){this.getDataController().chatServerConnection&&this.getDataController().chatServerConnection.setVisitorDetails(this.getDataController().connectionInfo.get("chatId"),a.pick(this.changeableRoomDetails))},triggerRoomChangedForApi:function(){this.getPublicApi().trigger("chat:change",this.extendBaseApiEventObject(this.getPublicApi().reverseMapVisitorDetails(this.getChatModel().pick(this.changeableRoomDetails))))}})}),purechatApp.module("Api.Models",function(a,b,c,d,e,f){a.ApiModel=c.Model.extend({viewController:null,widgetSettings:function(){return this.viewController?this.viewController.options:null},chatModel:function(){return this.viewController?this.viewController.getChatModel():null},dataController:function(){return this.viewController?this.viewController.getDataController():null},setWidgetSetting:function(a,b){this.widgetSettings().set(a,b)},setChatModel:function(a,b){this.chatModel().set(a,b)},getWidgetSetting:function(a,b){this.widgetSettings().get(a)},getChatModel:function(a){this.chatModel().get(a)},regexs:{propAccess:{chatBox:/^chatbox\./i,strings:/^string\./i,visitor:/^visitor\./i},events:{chatBox:/^chatbox:/i,chatBoxPropChange:/^chatbox\.\w(\w|\d)*:/i,chat:/^chat:/i,email:/^email:/i,visitor:/^visitor\.\w(\w|\d)*/i}},mappings:{chatBox:{keys:{available:"available",position:"Position",layoutType:"CollapsedStyle",unavailableBehavior:"UnavailableBehavior",askForRating:"AskForRating",askForFirstName:"AskForFirstName",askForLastName:"AskForLastName",askForEmail:"AskForEmail",askForCompany:"AskForCompany",askForQuestion:"AskForQuestion",askForPhoneNumber:"AskForPhoneNumber",unavailableAskForPhone:"UnavailableAskForPhone",enableTranscriptDownload:"DownloadTranscript",forcePopout:"ForcePopout",enableGoogleAnalytics:"UsingGa",loadingAnimation:"DisplayWidgetAnimation",availableImageXOffset:"AvailableImageXOffset",availableImageYOffset:"AvailableImageYOffset",availableImageScale:"AvailableImageScale",availableImageOnTop:"AvailableImageTop",availableCollapsedImageUrl:"AvailableCollapsedWidgetImageUrl",availableImageHeight:"AvailableImageHeight",availableImageWidth:"AvailableImageWidth",useAvailableImageForBoth:"UseAvailableImageForBoth",unavailableImageXOffset:"UnavailableImageXOffset",unavailableImageYOffset:"UnavailableImageYOffset",unavailableImageScale:"UnavailableImageScale",unavailableImageOnTop:"UnavailableImageTop",unavailableCollapsedImageUrl:"UnavailableCollapsedWidgetImageUrl",unavailableImageHeight:"UnavailableImageHeight",unavailableImageWidth:"UnavailableImageWidth",showMinimizeButton:"ShowMinimizeWidgetButton",expanded:{propertyName:"expanded",setter:function(a,b,c){c=c||{},b?this.viewController.widgetLayout.expand(!1,!1,{expandSource:c.expandSource}):this.viewController.widgetLayout.onCollapse(!1)}},initialState:"initialState",currentState:"state",enableAvailabilityPolling:"enableAvailabilityPolling"},values:{position:{bottomLeft:1,bottomRight:2,topLeft:3,topRight:4},layoutType:{tab:1,button:2,image:3,tabWithImage:4},unavailableBehavior:{hide:0,message:1,email:2},loadingAnimation:{none:"none",flipInX:"flipInX",flipInY:"flipInY",fadeIn:"fadeIn",fadeInUp:"fadeInUp",fadeInDown:"fadeInDown",fadeInLeft:"fadeInLeft",fadeInRight:"fadeInRight",fadeInUpBig:"fadeInUpBig",fadeInDownBig:"fadeInDownBig",fadeInLeftBig:"fadeInLeftBig",fadeInRightBig:"fadeInRightBig",slideInUp:"slideInUp",slideInDown:"slideInDown",slideInLeft:"slideInLeft",slideInRight:"slideInRight",bounceIn:"bounceIn",bounceInUp:"bounceInUp",bounceInDown:"bounceInDown",bounceInLeft:"bounceInLeft",bounceInRight:"bounceInRight",rotateIn:"rotateIn",rotateInDownLeft:"rotateInDownLeft",rotateInDownRight:"rotateInDownRight",rotateInUpLeft:"rotateInUpLeft",rotateInUpRight:"rotateInUpRight"}}},visitor:{keys:{firstName:"visitorFirstName",lastName:"visitorLastName",email:"visitorEmail",avatarUrl:"visitorAvatarUrl",phoneNumber:"visitorPhoneNumber",question:"visitorQuestion",company:"visitorCompany",name:function(a){var b,c,d=a.value.indexOf(" ");d>0?(b=a.value.substring(0,d),c=a.value.substring(d+1)):b=a.value,this.chatModel().set("visitorFirstName",b),this.chatModel().set("visitorLastName",c)}},values:{}}},reverseMapVisitorDetails:function(a){var b={};for(var c in this.mappings.visitor.keys)b[c]=a[this.mappings.visitor.keys[c]];return b},getMappedWidgetValue:function(a,b){if("string"==typeof b&&this.mappings.chatBox.values[a])for(var c in this.mappings.chatBox.values[a])if(c.toLowerCase()==b.toLowerCase())return this.mappings.chatBox.values[a][c];return b},canSetChatBoxProp:function(a){switch(a){case"available":return!1;default:return!0}},set:function(a,b){if(c.Model.prototype.set.apply(this,arguments),"object"==typeof a)for(var d in a)this.set(d,a[d]);else{var e;if(this.regexs.propAccess.chatBox.test(a)){e=a.split(this.regexs.propAccess.chatBox),e=e.length>1?e[1]:null;var g=this.mappings.chatBox.keys;if(e&&g[e]){var h=this.setWidgetSetting,i=g[e];f.isObject(i)&&(h=i.setter||h,i=i.propertyName),b=this.getMappedWidgetValue(e,b),h.call(this,g[e],b),this.widgetSettings().trigger("api:change",this.widgetSettings,g[e],b)}}else if(this.regexs.propAccess.visitor.test(a)){e=a.split(this.regexs.propAccess.visitor),e=e.length>1?e[1]:null;var j=this.mappings.visitor.keys[e];if(e&&this.mappings.visitor.keys[e]){var k=this.chatModel().get("roomId")||this.viewController.getDataController().checkInRoom();(this.mappings.visitor.keys.question==j&&!k||this.mappings.visitor.keys.question!=j)&&("function"==typeof j?j.call(this,{value:b}):(this.chatModel().set(j,b,{silent:!1}),this.chatModel().trigger("api:change",this.chatModel(),this.mappings.visitor.keys[e],b)))}}}},getRequestedPropName:function(a,b){var c=a.split(b);return c.length>1?c[1]:null},get:function(a){var b=null;if(this.regexs.propAccess.chatBox.test(a)){if(b=this.getRequestedPropName(a,this.regexs.propAccess.chatBox),b&&this.mappings.chatBox.keys[b])switch(b){case"available":return this.chatModel()?this.chatModel().get("operatorsAvailable"):null;default:return this.widgetSettings()?this.widgetSettings().get(this.mappings.chatBox.keys[b]):null}}else if(this.regexs.propAccess.visitor.test(a)&&(b=this.getRequestedPropName(a,this.regexs.propAccess.visitor),b&&this.mappings.visitor.keys[b]&&this.chatModel))return this.chatModel().get(this.mappings.visitor.keys[b]);return null},on:function(a){var b=this.regexs.events.chat.test(a)||this.regexs.events.chatBox.test(a)||this.regexs.events.email.test(a)||this.regexs.events.visitor.test(a)||this.regexs.events.chatBoxPropChange.test(a);if(b)return void c.Model.prototype.on.apply(this,arguments);throw new Error('"'+a+'" is not a valid purechatApi event')},off:function(a){(this.regexs.events.chat.test(a)||this.regexs.events.chatBox.test(a))&&c.Model.prototype.off.apply(this,arguments)},clearViewController:function(){this.viewController=null},setViewController:function(a){this.viewController=a},clearWidgetSettings:function(){this.widgetSettings=null},setWidgetSettings:function(a){this.widgetSettings=a},clearChatModel:function(){this.chatModel=null},setChatModel:function(a){this.chatModel=a},unbindEvents:function(){for(var a in this.events)c.Model.prototype.off.apply(this,a,this.events[a])},bindEvents:function(){for(var a in this.events)c.Model.prototype.on.apply(this,a,this.events[a])},initialize:function(){this.bindEvents()},onDestroy:function(){this.unbindEvents(),c.Model.prototype.off.apply(this)}}),a.addInitializer(function(){}),a.addFinalizer(function(){})});purechatApp.module("Controllers",function(a,b,c,e,h,i,j){function k(a,b){var c=new Date,d=new Date(c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate(),c.getUTCHours(),c.getUTCMinutes(),c.getUTCSeconds()),e=d.getTime()/1e3-a,f=parseInt(a,10)-(parseInt(b,10)-e);return 1e3*f}a.PureChatController=a.PureChatApiController.extend({setChatModel:function(a){this.chatModel=a},getChatModel:function(){return this.chatModel},setDataController:function(a){this.dc=a},getDataController:function(){return this.dc},popoutChatOnExpand:function(a,b,c,d,e){c.set("poppedOut",!0),d.disable(),a.connectionInfo.persistLocalStorage();var f=b.pureServerUrl+"/VisitorWidget/ChatWindow?widgetId="+b.widgetId+"&userId="+a.connectionInfo.get("userId")+"&displayName="+a.connectionInfo.get("visitorName")+"&authToken="+a.connectionInfo.get("authToken")+"&roomId="+a.connectionInfo.get("roomId")+"&chatId="+a.connectionInfo.get("chatId")+"&origin="+encodeURIComponent(c?c.get("origin"):"");e?window.openedWindow=window.open(f,"_blank"):window.openedWindow=window.open(f,"purechatwindow","menubar=no, location=no, resizable=yes, scrollbars=no, status=no, width=480, height=640"),this.trigger("widget:poppedOut")},resetVisitorQuestion:function(){this.getChatModel().set("visitorQuestion",null)},triggerResizedEvent:function(){var a=this;a.resizeTrigger&&clearTimeout(a.resizeTrigger),a.resizeTrigger=setTimeout(function(){if(a.resizeTrigger=null,a.widgetLayout&&a.widgetLayout.$el){var b=a.widgetLayout.$el.width();a.widgetLayout.trigger("resized",{height:390,width:b}),a.widgetLayout.trigger("widget:resized",{height:390,width:b}),a.resizeTrigger2&&clearTimeout(a.resizeTrigger2),a.resizeTrigger2=setTimeout(function(){a.resizeTrigger2=null;var c=a.widgetLayout.$el.height();if(0===c){var d=a.widgetLayout.$el.find("img.collapsed-image");d.length>0&&(c=d.height(),b=d.width())}a.widgetLayout.trigger("resized",{height:c,width:b}),a.widgetLayout.trigger("widget:resized",{height:c,width:b})},1e3)}},0)},unbindAppLevelCommands:function(){b.commands.removeHandler("roomHostChanged")},bindAppLevelCommands:function(){var a=this;try{this.unbindAppLevelCommands()}catch(c){}b.commands.setHandler("roomHostChanged",function(b){(!a.options.get("AllowWidgetOnMobile")&&a.options.get("RequestFromMobileDevice")||!a.options.get("RequestFromMobileDevice"))&&a.getPublicApi().trigger("room:hostChanged",b)})},getStyleURL:function(){var a=null,b=this.options.get("version")+this.options.get("CssVersion"),c=this.options.isMobileRequest(),d=this.options.isAllowedOnMobile();return a=this.options.get("isPersonalChat")?c&&!this.options.isDesktopDimension()?this.options.get("apiCdnServerUrl")+"/VisitorWidget/WidgetCss/personal-mobile/"+this.options.get("Color")+"/"+b+".css":this.options.get("apiCdnServerUrl")+"/VisitorWidget/WidgetCss/personal/"+this.options.get("Color")+"/"+b+".css":c&&d&&!this.options.isDesktopDimension()?this.options.get("apiCdnServerUrl")+"/VisitorWidget/WidgetCss/mobile/"+this.options.get("Color")+"/"+b+".css":this.options.get("apiCdnServerUrl")+"/VisitorWidget/WidgetCss/"+this.options.get("StyleName")+"/"+this.options.get("Color")+"/"+b+".css"},bindVisitorTrackingEvents:function(){var a=this;this.vtftw&&this.vtftw.on("purechat:startChat",function(b){a.onFormSubmitted({operatorJoinIds:b.eventArgs.operatorJoinIds||[],initiator:1,startedByOperator:!0})})},unbindVisitorTrackingEvents:function(){this.vtftw&&this.vtftw.off("purechat:startChat")},isBanned:function(){var a=this.options.get("IPIsBanned");if(!a)return!1;try{return JSON.parse(a.toString().toLowerCase())}catch(b){return!1}},startVisitorTracking:function(){if(!this.getChatModel().get("isOperator")&&this.options.get("IsVisitorTrackingEnabledForAccount")){var a=i.find(this.options.get("Features"),function(a){return a.Status!=b.Constants.FeatureStatus.Off&&a.Feature==b.Constants.Features.VisitorTracking}),c=this.options.get("Type")!=b.Constants.PersonalChatType;if(c&&a&&(!this.vtftw||!this.vtftw.initialized)){var e={widgetId:this.options.get("overrideWidgetId")||this.options.get("Id"),widgetName:this.options.get("Name")};this.isBanned()&&(e.isBanned=!0),this.vtftw=new d(f,g,this.options.get("AccountId")),this.vtftw.setAdditionalInfo(e),this.vtftw.init(),this.bindVisitorTrackingEvents()}}},disableVisitorTrackingInactivity:function(){this.vtftw&&this.vtftw.setUserAlwaysActive()},enableVisitorTrackingInactivity:function(){this.vtftw&&this.vtftw.unsetUserAlwaysActive()},coalesceStartChatData:function(a){var b=this.getChatModel();return(!b.get("visitorFirstName")||a.visitorFirstName&&b.get("visitorFirstName")!=a.visitorFirstName)&&b.set("visitorFirstName",a.visitorFirstName),(!b.get("visitorLastName")||a.visitorLastName&&b.get("visitorLastName")!=a.visitorLastName)&&b.set("visitorLastName",a.visitorLastName),(!b.get("visitorName")||a.visitorName&&b.get("visitorName")!=a.visitorName)&&b.set("visitorName",a.visitorName),(!b.get("visitorEmail")||a.visitorEmail&&b.get("visitorEmail")!=a.visitorEmail)&&b.set("visitorEmail",a.visitorEmail),(!b.get("visitorQuestion")||a.visitorQuestion&&b.get("visitorQuestion")!=a.visitorQuestion)&&b.set("visitorQuestion",a.visitorQuestion),(!b.get("visitorPhoneNumber")||a.visitorPhoneNumber&&b.get("visitorPhoneNumber")!=a.visitorPhoneNumber)&&b.set("visitorPhoneNumber",a.visitorPhoneNumber),h.extend(a,b.attributes)},onFormSubmitted:function(a){var c=this,d=c.getDataController().checkInRoom(),e=c.widgetLayout.$el.find(".purechat-form.purechat-init-form"),f=this.getChatModel();if(e&&e.length>0&&b.execute("spinner:show",e),!c.state.submittingChat)if(d)b.execute("spinner:hide",e),f.set("state",b.Constants.WidgetStates.Activating);else{c.submittingChat=!0,a.origin=f.get("origin");c.getDataController().startChat(this.coalesceStartChatData(a)).done(function(d){b.Utils.GaEvent(c.options,"GaTrackingChat","GAChatEvent"),c.widgetLayout.$el.find(".purechat-init-form").find(".general-error").text("").hide(),c.state.status.chatInfo=d,c.state.status.initialData=a,f.set({visitorFirstName:a.visitorFirstName,visitorLastName:a.visitorLastName,visitorName:a.visitorName,visitorEmail:a.visitorEmail,visitorQuestion:a.visitorQuestion,visitorPhoneNumber:a.visitorPhoneNumber,roomId:d.get("roomId"),userId:d.get("userId"),authToken:d.get("authToken"),chatId:d.get("chatId"),state:b.Constants.WidgetStates.Chatting}),c.getDataController().connectionInfo.persistLocalStorage()}).fail(function(a){c.log("Error","Unable to start chat. WidgetId: "+c.options.get("widgetId")+", Message:"+(a||"None")),c.widgetLayout.$el.find(".purechat-init-form").find(".general-error").text("Unable to start chat. Please try again").show()}).always(function(){c.state.submittingChat=!1,e&&e.length>0&&b.execute("spinner:hide",e)})}},initialize:function(a){function c(){d.options.set(d.options.get("dataController").widgetSettings.widgetConfig),d.setupPageActivityTest(),d.rm=d.options,d.options.set(d.getDataController().widgetSettings),h(".purechat-button-expand").find(".purechat-button-text").text(d.options.getResource("title_initial"),"title_initial"),e.on("change:operatorsAvailable",function(a,b){var c=h(".purechat-button-expand");c.filter(":not(.purechat)").click(function(a){var b=d.getDataController();h(a.target).hasClass("pc-icon-caret-down")||h(a.target).hasClass("purechat-super-minimize-link-button")||!(b.options.ForcePopout&&!d.chatModel.get("isPoppedOut")||b.options.usePrototypeFallback)?d.widgetLayout.triggerMethod("expand",a,{
collapse:h(a.target).hasClass("btn-collapse")||h(a.target).hasClass("pc-icon-minus"),superMinimize:h(a.target).hasClass("pc-icon-caret-down")||h(a.target).hasClass("pc-icon-caret-up")||h(a.target).hasClass("purechat-super-minimize-link-button")}):d.popoutChatOnExpand(b,b.options,d.chatModel,d.state)}),b?(c.addClass("purechat-button-available"),c.removeClass("purechat-button-unavailable"),c.removeClass("purechat-button-hidden"),c.removeAttr("disabled"),e.trigger("widget:available")):(0===d.options.get("UnavailableBehavior")&&(c.removeClass("purechat-button-available"),c.addClass("purechat-button-unavailable"),c.attr("disabled","disabled")),c.each(function(){var a,b=h(this),c=b.attr("HideUnavailable");a=c?"true"==c:0===d.options.get("UnavailableBehavior"),a&&b.addClass("purechat-button-hidden")}),e.trigger("widget:unavailable"))}),d.getDataController().connectionInfo.isInChat()||d.getDataController().connectionInfo.loadFromLocalStorage(),e.set("userId",d.getDataController().connectionInfo.get("userId")),d.widgetLayout=new purechatApp.Views.WidgetLayout({viewController:d,rm:d.rm,model:e,widgetSettings:d.options}),d.widgetLayout.render(),d.widgetLayout.onHide(),!d.getDataController().connectionInfo.get("chatActiveInOtherWindow")&&d.getDataController().connectionInfo.get("disabled")&&d.getDataController().connectionInfo.get("roomId")?d.widgetLayout.$el.hide():d.getDataController().connectionInfo.get("chatActiveInOtherWindow")&&d.widgetLayout.triggerMethod("collapse");var c=function(){var c=h(a.get("renderInto"));c.append(d.widgetLayout.$el),c.on("selectionShow",function(){d.triggerMethod("selectionShow")}),d.bindGobalCommand(d.widgetLayout.$el),d.triggerMethod("rendered"),d.options.get("dataController").options.chatModel=d.getChatModel(),d.listenTo(e,"change:state",d.stateChange),e.set("state",d.options.get("initialState")||b.Constants.WidgetStates.Initializing),d.listenTo(d.widgetLayout.$el,"change:state",d.stateChange),d.widgetLayout.$el.removeClass("hide"),d.widgetLayout.triggerMethod("afterInsertion"),d.trigger("widget:ready"),d.chatModel.get("expanded")||!d.options.useMobile()||d.options.isDesktopDimension()||setTimeout(function(){d.widgetLayout.collapseMobile()},1e3),d.setUpUiTriggers(),d.startVisitorTracking()};if(d.options.get("isOperator"))c();else{var f=!1,g=d.options.get("BrowserDetails").Browser||"",i=(parseFloat(d.options.get("BrowserDetails").Version||""),d.options.get("BrowserDetails").OS||"Other"),j=d.getStyleURL(),k=h('<link rel="stylesheet" href="'+j+'" type="text/css">'),l=0;if(/safari/i.test(g)&&"Windows"==i){console.log("Safari on Windows detected"),k.appendTo("head");var m=setInterval(function(){(k[0].sheet||l>=150)&&(f||(f=!0,m=clearInterval(m),c())),l++},100)}else k.appendTo("head").on("load",function(){f=!0,c()})}}var d=this;a.get("apiCdnServerUrl")||a.set("apiCdnServerUrl","https://cdnva2.purechat.com/api"),b.pureServerUrl=a.get("pureServerUrl");var e=(h.Deferred(),new purechatApp.Models.Chat({isWidget:a.get("isWidget"),position:a.get("position"),pureServerUrl:a.get("pureServerUrl"),cdnServerUrl:a.get("cdnServerUrl")||a.get("pureServerUrl"),apiCdnServerUrl:a.get("apiCdnServerUrl"),widgetType:b.Constants.WidgetType.Tab,isOperator:a.get("isOperator"),isPoppedOut:a.get("poppedOut"),State:b.Constants.WidgetStates.Inactive,messages:new purechatApp.Models.MessageCollection,operators:new purechatApp.Models.OperatorCollection,origin:a.get("origin")||window.location.href,userId:a.get("userId")}));if(d.setChatModel(e),this.registerPublicApiEvents(),a.get("isDemo")&&(e.set("operatorsAvailable",!0),e.set("visitorName",a.get("visitorName")),a.get("isPersonalChat")&&a.get("isInEditorMode")&&(window.pcDemoChatModel=e)),window.pcDashboard)var f=h.Deferred().resolve();else var f=h.ajax({url:a.get("cdnServerUrl")+"/scripts/socket.io.0.9.16-noflash.js",dataType:"script",cache:!0});var g=d.setupDataController(a,e);h.when(g,f).done(c).fail(function(){d.trigger("widget:fail")}),this.on("all",function(){d.state&&d.state.triggerMethod.apply(d.state,arguments)}),this.on("chat:start",function(){d.disableVisitorTrackingInactivity()}),this.on("chat:end",function(){d.enableVisitorTrackingInactivity()})},setUpUiTriggers:function(){new b.Triggers.TimeBasedTrigger(this),new b.Triggers.UrlBasedTrigger(this)},setupDataController:function(a,b){var c=this.options.get("dataController").loadWidgetSettings();return this.setDataController(this.options.get("dataController")),c},setupPageActivityTest:function(){var a=this,b=null,c=-9999,d=-9999;a.pageActivity=!1,h(document).on("mousemove.setupPageActivityTest",h.throttle(1e4,function(e){b&&clearTimeout(b),Math.abs(c-e.clientX)<=2&&Math.abs(d-e.clientY)<=2||(c=e.clientX,d=e.clientY,a.pageActivity=!0,b=setTimeout(function(){a.pageActivity=!1},45e3))}))},onSelectionShow:function(){this.state&&this.state.triggerMethod("selectionShow")},stateChange:function(a,c){var d=new b.Controllers.States[c](this.options);this.setState(d)},setState:function(a){var b=this.state,c={};null!=this.state&&(c=this.state.status,this.state.triggerMethod("exit"),this.state.destroy()),this.state=a,this.state.status=c,this.state.setChatModel(this.getChatModel()),this.state.setWidgetView(this.widgetLayout),this.state.setWidgetSettings(this.options),this.state.setResources(this.rm),this.state.setDataController(this.getDataController()),this.state.setViewController(this),this.trigger("state:changed",{oldState:b,newState:a}),this.state.triggerMethod("enter"),this.triggerResizedEvent()},bindGobalCommand:function(a){var b=this;a.on("click.delegateEvents","[data-command]",function(a){a.preventDefault();var c=h(this),d=c.data("command"),e=c.data("command-params");b.trigger(d,e)})},showConfirmationDialog:function(){return h.Deferred.resolve()},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},onClose:function(){},onDestroy:function(){h(document).off(".setupPageActivityTest");var a=this.getDataController();a.unbindHandlerEvents(),a.chatServerConnection=null,a.destroy(),this.widgetLayout.destroy(),this.state.destroy(),this.state=null,this.widgetLayout=null,this.setDataController(null),this.setChatModel(null),this.resizeTrigger&&(clearTimeout(this.resizeTrigger),this.resizeTrigger=null),this.resizeTrigger2&&(clearTimeout(this.resizeTrigger2),this.resizeTrigger2=null),this.options&&(this.options.attributes.dataController=null,this.options.attributes.renderInto=null,this.options._previousAttributes.dataController=null,this.options._previousAttributes.renderInto=null,this.options=null),this.unbindAppLevelCommands()},roomHostChanged:function(a){var b=this.getChatModel();for(var c in a)b.set(c,a[c],{silent:!0});b.trigger("roomHostChanged")}});var l=a.PureChatController.extend({onRendered:function(){if(this.options.get("isInvisible")?this.widgetLayout.setTitle(this.options.get("room").name+" (Eavesdropping)"):this.widgetLayout.setTitle(this.options.get("room").name),this.options.get("room").roomType==PureChat.enums.roomType.visitor){var a=this.options.get("room").visitorReferer;"Unknown"!=a&&(a='<a target="_blank" href="'+a+'">'+a+"</a>");var b,c=h('<div class="chat-referer" title="'+this.options.get("room").visitorReferer+'">'+a+"</div>");b=null!=this.options.get("room").timeElapsed?k(this.options.get("room").time,this.options.get("room").timeElapsed):room.time;var d=h('<div class="purechat-start time"></div>');d.attr("start-time",b),this.widgetLayout.$el.find(".purechat-chat-info").append(d),this.widgetLayout.$el.find(".purechat-chat-info").append(c)}else{var e=h('<div class="operator-bar">Operator Room</div>');this.widgetLayout.$el.find(".purechat-chat-info").append(e)}pcDashboard&&pcDashboard.vent.trigger("chat:selected",this.rm.get("room").id)},showConfirmationDialog:function(a,b){var c=h.Deferred(),d=window.showConfirmationDialog({title:b||"Are you sure?",bodyText:a,onConfirm:function(){c.resolve(),d.modal("hide")}});return c}});a.DashboardChatController=l},purechatApp.Models),_PCWidget=function(a){a.pureServerUrl=a.pureServerUrl||"https://www.purechat.com";var b,c={test:!1,widgetId:a.widgetId||a.c,connectionSettings:a,isWidget:a.isWidget||a.f,isOperator:void 0==a.d?!1:a.d,pureServerUrl:a.pureServerUrl,renderInto:j("body")};window._pcDisableAvailabilityPings=a.DisableAvailabilityPings||a.IPIsBanned,b=c.test?new purechatApp.Controllers.TestDataController(c):new purechatApp.Controllers.PCDataController(j.extend(a,c));var d=!1,e="";if("undefined"!=typeof Prototype)try{var f=Prototype.Version.split(/\./g);f.length>0&&(d=parseInt(f[0])>=2?!1:!(parseInt(f[1])>=7))}catch(g){e=g}d&&(e="PureChat widgets are not compatible with Prototype.js versions < 1.7. Default widget behavior will popout into a new window"),e.length>0&&"undefined"!=typeof console&&null!==console&&console.log(e);var h={test:!1,pureServerUrl:a.pureServerUrl,widgetId:a.widgetId||a.c,isWidget:a.isWidget||a.f,isOperator:void 0==a.d?!1:a.d,renderInto:j("body"),dataController:b,usePrototypeFallback:d};h=j.extend(a,h);var i=new purechatApp.Controllers.PureChatController(new purechatApp.Models.WidgetSettings(h));return purechatApp.Notifications.controller=new purechatApp.Notifications.Controller({settings:i.options}),i},purechatApp.module("Triggers",function(a,b,c,d,e,f,g){a.MILLISECONDS_IN_SECOND=1e3,a.SECONDS_IN_MINUTE=60,a.MINUTES_IN_HOUR=60,a.HOURS_IN_DAY=24,a.MILLISECONDS_IN_DAY=a.HOURS_IN_DAY*a.MINUTES_IN_HOUR*a.SECONDS_IN_MINUTE*a.MILLISECONDS_IN_SECOND,a.DISMISS_DELAYS_DAYS=[0,1,3,7,30,365],a.CHECKIN_INTERVAL_SECONDS=5,a.MAX_CHECKIN_INTERVAL_SECOND=60;var h=c.Model.extend({storageKeys:["_purechatSessionStart","_purechatLastCheckin","_purechatDismissTime","_pureChatTimeSettingsVersion","_purechatDismissCount"],defaults:{_purechatSessionStart:new Date,_purechatPageStart:new Date,_purechatLastCheckin:new Date,_purechatDismissCount:0},fetchDate:function(a){var b=window.localStorage.getItem(this.formatPropName(a));f.isUndefined(b)||f.isNaN(b)||f.isNull(b)||this.set(a,new Date(window.localStorage.getItem(this.formatPropName(a))))},fetchInt:function(a){var b=window.localStorage.getItem(this.formatPropName(a));f.isUndefined(b)||f.isNaN(b)||f.isNull(b)||this.set(a,parseInt(window.localStorage.getItem(this.formatPropName(a))),10)},formatPropName:function(a){return this.widgetId+"_"+a},fetch:function(){this.fetchDate("_purechatSessionStart"),this.fetchDate("_purechatLastCheckin"),this.fetchDate("_purechatDismissTime"),this.fetchInt("_pureChatTimeSettingsVersion"),this.fetchInt("_purechatDismissCount")},save:function(){var a=this;this.storageKeys.forEach(function(b,c){var d=a.get(b);f.isUndefined(d)||f.isNaN(d)||f.isNull(d)?window.localStorage.removeItem(a.formatPropName(b)):window.localStorage.setItem(a.formatPropName(b),a.get(b))})},resetTimeCounters:function(){this.set({_purechatDismissTime:null})},updateEventLoop:function(){this.set("_purechatLastCheckin",new Date),window.localStorage.setItem(this.formatPropName("_purechatLastCheckin"),this.get("_purechatLastCheckin"))},initialize:function(){f.bindAll(this,"updateEventLoop"),setInterval(this.updateEventLoop,a.CHECKIN_INTERVAL_SECONDS*a.MILLISECONDS_IN_SECOND)}}),i=d.Controller.extend({isPoppedOut:function(){return this.widgetSettings.get("isPoppedOut")},isHosted:function(){return this.widgetSettings.get("isDirectAccess")},isPersonalChat:function(){return this.widgetSettings.get("isPersonalChat")},isDemoChat:function(){return this.widgetSettings.get("isDemo")},isMobile:function(){return this.widgetSettings.get("RequestFromMobileDevice")},isWidgetAvailable:function(){return this.purechatController.chatModel.get("operatorsAvailable")},popOutAutomatically:function(){return this.widgetSettings.get("ForcePopout")||!1},initialize:function(a){var b=this;if(this.purechatController=a,this.widgetSettings=a.options,this.enabled=this.widgetSettings.get(this.enabledWidgetSettingKey)&&!this.isPoppedOut()&&!this.isHosted()&&!this.isPersonalChat()&&!this.isDemoChat()&&!this.isMobile()&&!this.popOutAutomatically(),this.enabled){f.bindAll(this,"onCollapse"),i.dismissSettings||(i.dismissSettings=new h,i.dismissSettings.widgetId=this.widgetSettings.get("Id"),i.dismissSettings.fetch());var c=i.dismissSettings.get("_pureChatTimeSettingsVersion"),d=this.widgetSettings.get("WidgetSettingsVersion");c&&c==d||(i.dismissSettings.resetTimeCounters(),i.dismissSettings.set("_pureChatTimeSettingsVersion",d)),this.isNewSession()&&i.dismissSettings.set("_purechatSessionStart",new Date),this.purechatController.getPublicApi().on("chatbox:collapse",this.onCollapse),b.startTesting(),i.dismissSettings.save()}},onCollapse:function(){i.dismissSettings.set("_purechatDismissCount",i.dismissSettings.get("_purechatDismissCount")+1),this.stopTesting(),i.dismissSettings.set("_purechatDismissTime",new Date),i.dismissSettings.save(),this.purechatController.getPublicApi().off("chatbox:collapse",this.onCollapse)},getDismissDelay:function(){return a.DISMISS_DELAYS_DAYS[Math.min(i.dismissSettings.get("_purechatDismissCount"),a.DISMISS_DELAYS_DAYS.length-1)]*a.MILLISECONDS_IN_DAY},isNewSession:function(){return new Date-i.dismissSettings.get("_purechatLastCheckin")>a.MAX_CHECKIN_INTERVAL_SECOND*a.MILLISECONDS_IN_SECOND},startTesting:function(){var a=i.dismissSettings.get("_purechatDismissTime"),b=this.getDismissDelay();(!a||new Date-a>b)&&(i.dismissSettings.on("change:_purechatLastCheckin",this.eventCheckChange),this.onStart&&this.onStart())},removeEventListeners:function(){i.dismissSettings.off("change:_purechatLastCheckin",this.eventCheckChange)},stopTesting:function(){this.removeEventListeners(),i.dismissSettings.resetTimeCounters(),i.dismissSettings.set("_purechatDismissTime",new Date),i.dismissSettings.save(),this.onStop&&this.onStop()},triggerEvent:function(a){var b=this;this.purechatController.getDataController().checkChatAvailable().done(function(c){c.available&&(b.removeEventListeners(),setTimeout(function(){b.purechatController.chatModel.get("expanded")||(b.stopTesting(),b.purechatController.getPublicApi().set("chatbox.expanded",!0,{expandSource:d.getOption(b,"expandSource")}))},a||1e3))}).fail(function(){})}});a.BaseControllerSettings=i,a.addInitializer(function(a){}),a.addFinalizer(function(){})}),purechatApp.module("Triggers",function(a,b,c,d,e,f,g){var h=a.BaseControllerSettings.extend({expandSource:"time-trigger",enabledWidgetSettingKey:"ExpandWidgetTimeoutEnabled",initialize:function(b){a.BaseControllerSettings.prototype.initialize.apply(this,arguments)},onStart:function(){var b=this,c=this.widgetSettings.get("ExpandWidgetTimeoutType"),d=1==c?"_purechatSessionStart":"_purechatPageStart",e=new Date-a.BaseControllerSettings.dismissSettings.get(d),f=this.widgetSettings.get("ExpandWidgetTimeout")*a.MILLISECONDS_IN_SECOND,g=f-e;this.timeout=setTimeout(function(){b.triggerEvent()},g)},onStop:function(){clearTimeout(this.timeout),delete this.timeout}});a.TimeBasedTrigger=h,a.addInitializer(function(a){}),a.addFinalizer(function(){})}),purechatApp.module("Triggers",function(a,b,c,d,e,f,g){var h=a.BaseControllerSettings.extend({expandSource:"url-trigger",enabledWidgetSettingKey:"EnableTriggerPageSpecific",initialize:function(b){a.BaseControllerSettings.prototype.initialize.apply(this,arguments)},onStart:function(){var b=this,c=this.widgetSettings.get("TriggerUrls"),d=this.widgetSettings.get("TriggerPageExpandTimeout"),e=window.location.href.replace("http://","").replace("https://","");c.forEach(function(c){b.testUrl(e,c)&&b.triggerEvent(d*a.MILLISECONDS_IN_SECOND)})},testUrl:function(a,b){return a.toLowerCase().indexOf(b.Url.toLowerCase())>=0}});a.UrlBasedTrigger=h,a.addInitializer(function(a){}),a.addFinalizer(function(){})}),purechatApp.module("Notifications",function(a,b,c,d,e,f,g){a.Controller=d.Controller.extend({notificationSoundTimeout:null,soundIsPlaying:!1,_soundsFolder:"/content/sounds/notifications/",_localStorageKey:"_purechatVisitorWidgetPlaySound",_playSound:function(a){var b=this,c=new Audio(a);c.onerror=function(){console.log(arguments)},c.onended=function(){b.soundIsPlaying=!1,delete c},this.soundIsPlaying=!0,c.play()},_playWave:function(a){this._playSound(a+this._soundsFolder+"Correct-short.wav")},_playMp3:function(a){this._playSound(a+this._soundsFolder+"Correct-short.mp3")},newMessage:function(){var a=d.getOption(this,"settings");if(!a.get("RequestFromMobileDevice")&&!a.get("isInEditorMode")){var b=a.get("pureServerUrl")||"https://app.purechat.com",c="true"==localStorage._purechatVisitorWidgetPlaySound.toString().toLowerCase();if(!a.get("isOperator")&&c&&"undefined"!=typeof Audio&&!this.soundIsPlaying){var e=new Audio,f=e.canPlayType("audio/wav")||e.canPlayType("audio/wave");f?this._playWave(b):this._playMp3(b)}}},initialize:function(){var a=this;localStorage[this._localStorageKey]="undefined"!=typeof localStorage[this._localStorageKey]?"true"==localStorage[this._localStorageKey].toString().toLowerCase():!0,b.commands.setHandler("notifications:newMessage",function(){a.newMessage()})},onDestroy:function(){b.commands.removeHandler("notifications:newMessage")}})})}({},function(){return this}());